<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Mail/Protocol/Abstract.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Mail/Protocol/Abstract.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 
<a name="l00028"></a>00028 require_once <span class="stringliteral">&#39;Zend/Validate.php&#39;</span>;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00034"></a>00034 require_once <span class="stringliteral">&#39;Zend/Validate/Hostname.php&#39;</span>;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00050"></a><a class="code" href="class_zend___mail___protocol___abstract.html">00050</a> <span class="keyword">abstract</span> <span class="keyword">class </span><a class="code" href="class_zend___mail___protocol___abstract.html">Zend_Mail_Protocol_Abstract</a>
<a name="l00051"></a>00051 {
<a name="l00055"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a0603d6ece8c5d37b4b7db697db053a4b">00055</a>     <span class="keyword">const</span> <a class="code" href="class_zend___mail___protocol___abstract.html#a0603d6ece8c5d37b4b7db697db053a4b">EOL</a> = <span class="stringliteral">&quot;\r\n&quot;</span>;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00061"></a><a class="code" href="class_zend___mail___protocol___abstract.html#ad974ae8dbc5dc17a8adda83550efc869">00061</a>     <span class="keyword">const</span> <a class="code" href="class_zend___mail___protocol___abstract.html#ad974ae8dbc5dc17a8adda83550efc869">TIMEOUT_CONNECTION</a> = 30;
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 
<a name="l00068"></a>00068     <span class="keyword">protected</span> $_host;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 
<a name="l00075"></a>00075     <span class="keyword">protected</span> $_port;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 
<a name="l00082"></a>00082     <span class="keyword">protected</span> $_validHost;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00089"></a>00089     <span class="keyword">protected</span> $_socket;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 
<a name="l00096"></a>00096     <span class="keyword">protected</span> $_request;
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 
<a name="l00103"></a>00103     <span class="keyword">protected</span> $_response;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00110"></a>00110     <span class="keyword">protected</span> $_template = <span class="stringliteral">&#39;%d%s&#39;</span>;
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 
<a name="l00117"></a>00117     <span class="keyword">private</span> $_log;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 
<a name="l00128"></a><a class="code" href="class_zend___mail___protocol___abstract.html#adb26e14ff9f19cf3e9cf81215e17ec4e">00128</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#adb26e14ff9f19cf3e9cf81215e17ec4e">__construct</a>($host = <span class="stringliteral">&#39;127.0.0.1&#39;</span>, $port = null)
<a name="l00129"></a>00129     {
<a name="l00130"></a>00130         $this-&gt;_validHost = <span class="keyword">new</span> <a class="code" href="class_zend___validate.html">Zend_Validate</a>();
<a name="l00131"></a>00131         $this-&gt;_validHost-&gt;addValidator(<span class="keyword">new</span> <a class="code" href="class_zend___validate___hostname.html">Zend_Validate_Hostname</a>(<a class="code" href="class_zend___validate___hostname.html#aef08298224bb7a9e7784529f93b661c3">Zend_Validate_Hostname::ALLOW_ALL</a>));
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (!$this-&gt;_validHost-&gt;isValid($host)) {
<a name="l00137"></a>00137             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00138"></a>00138             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(join(<span class="stringliteral">&#39;, &#39;</span>, $this-&gt;_validHost-&gt;getMessages()));
<a name="l00139"></a>00139         }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         $this-&gt;_host = $host;
<a name="l00142"></a>00142         $this-&gt;_port = $port;
<a name="l00143"></a>00143     }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 
<a name="l00151"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a421831a265621325e1fdd19aace0c758">00151</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a421831a265621325e1fdd19aace0c758">__destruct</a>()
<a name="l00152"></a>00152     {
<a name="l00153"></a>00153         $this-&gt;<a class="code" href="class_zend___mail___protocol___abstract.html#a176baffc5de9e52339871ea80a24a14e">_disconnect</a>();
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00162"></a>00162     <span class="keyword">abstract</span> <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a78572828d11dcdf2a498497d9001d557">connect</a>();
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 
<a name="l00170"></a><a class="code" href="class_zend___mail___protocol___abstract.html#adf1a35ad20e475c59cc0967d5764aa22">00170</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#adf1a35ad20e475c59cc0967d5764aa22">getRequest</a>()
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172         <span class="keywordflow">return</span> $this-&gt;_request;
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 
<a name="l00181"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a6c907e8af775e517a77037dd0164222f">00181</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a6c907e8af775e517a77037dd0164222f">getResponse</a>()
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183         <span class="keywordflow">return</span> $this-&gt;_response;
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 
<a name="l00192"></a><a class="code" href="class_zend___mail___protocol___abstract.html#af8283af3e7c972d9c276dc634eec0bdc">00192</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#af8283af3e7c972d9c276dc634eec0bdc">getLog</a>()
<a name="l00193"></a>00193     {
<a name="l00194"></a>00194         <span class="keywordflow">return</span> $this-&gt;_log;
<a name="l00195"></a>00195     }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00203"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a96a5e88adbe1e92d0865b6ad4dabe8f6">00203</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a96a5e88adbe1e92d0865b6ad4dabe8f6">resetLog</a>()
<a name="l00204"></a>00204     {
<a name="l00205"></a>00205         $this-&gt;_log = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 
<a name="l00218"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a232549a2b8760895af81ad9e8a819317">00218</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a232549a2b8760895af81ad9e8a819317">_connect</a>($remote)
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220         $errorNum = 0;
<a name="l00221"></a>00221         $errorStr = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <span class="comment">// open connection</span>
<a name="l00224"></a>00224         $this-&gt;_socket = @stream_socket_client($remote, $errorNum, $errorStr, self::TIMEOUT_CONNECTION);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="keywordflow">if</span> ($this-&gt;_socket === <span class="keyword">false</span>) {
<a name="l00227"></a>00227             <span class="keywordflow">if</span> ($errorNum == 0) {
<a name="l00228"></a>00228                 $errorStr = <span class="stringliteral">&#39;Could not open socket&#39;</span>;
<a name="l00229"></a>00229             }
<a name="l00233"></a>00233             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00234"></a>00234             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>($errorStr);
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         <span class="keywordflow">if</span> (($result = stream_set_timeout($this-&gt;_socket, self::TIMEOUT_CONNECTION)) === <span class="keyword">false</span>) {
<a name="l00241"></a>00241             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00242"></a>00242             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(<span class="stringliteral">&#39;Could not set stream timeout&#39;</span>);
<a name="l00243"></a>00243         }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         <span class="keywordflow">return</span> $result;
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 
<a name="l00254"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a176baffc5de9e52339871ea80a24a14e">00254</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a176baffc5de9e52339871ea80a24a14e">_disconnect</a>()
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256         <span class="keywordflow">if</span> (is_resource($this-&gt;_socket)) {
<a name="l00257"></a>00257             fclose($this-&gt;_socket);
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00269"></a><a class="code" href="class_zend___mail___protocol___abstract.html#ae0f3637f16d97ccf9b9c16e2676e550f">00269</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#ae0f3637f16d97ccf9b9c16e2676e550f">_send</a>($request)
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (!is_resource($this-&gt;_socket)) {
<a name="l00275"></a>00275             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00276"></a>00276             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(<span class="stringliteral">&#39;No connection has been established to &#39;</span> . $this-&gt;_host);
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         $this-&gt;_request = $request;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         $result = fwrite($this-&gt;_socket, $request . self::EOL);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <span class="comment">// Save request to internal log</span>
<a name="l00284"></a>00284         $this-&gt;_log .= $request . <a class="code" href="class_zend___mail___protocol___abstract.html#a0603d6ece8c5d37b4b7db697db053a4b">self::EOL</a>;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         <span class="keywordflow">if</span> ($result === <span class="keyword">false</span>) {
<a name="l00290"></a>00290             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00291"></a>00291             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(<span class="stringliteral">&#39;Could not send request to &#39;</span> . $this-&gt;_host);
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294         <span class="keywordflow">return</span> $result;
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 
<a name="l00305"></a><a class="code" href="class_zend___mail___protocol___abstract.html#a1b16678d668491625c5b66ee54a2838f">00305</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#a1b16678d668491625c5b66ee54a2838f">_receive</a>($timeout = null)
<a name="l00306"></a>00306     {
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (!is_resource($this-&gt;_socket)) {
<a name="l00311"></a>00311             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00312"></a>00312             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(<span class="stringliteral">&#39;No connection has been established to &#39;</span> . $this-&gt;_host);
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">// Adapters may wish to supply per-commend timeouts according to appropriate RFC</span>
<a name="l00316"></a>00316         <span class="keywordflow">if</span> ($timeout !== null) {
<a name="l00317"></a>00317            stream_set_timeout($this-&gt;_socket, $timeout);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         <span class="comment">// Retrieve response</span>
<a name="l00321"></a>00321         $reponse = fgets($this-&gt;_socket, 1024);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="comment">// Save request to internal log</span>
<a name="l00324"></a>00324         $this-&gt;_log .= $reponse;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         <span class="comment">// Check meta data to ensure connection is still valid</span>
<a name="l00327"></a>00327         $info = stream_get_meta_data($this-&gt;_socket);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="keywordflow">if</span> (!empty($info[<span class="stringliteral">&#39;timed_out&#39;</span>])) {
<a name="l00333"></a>00333             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00334"></a>00334             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>($this-&gt;_host . <span class="stringliteral">&#39; has timed out&#39;</span>);
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="keywordflow">if</span> ($reponse === <span class="keyword">false</span>) {
<a name="l00341"></a>00341             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00342"></a>00342             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>(<span class="stringliteral">&#39;Could not read from &#39;</span> . $this-&gt;_host);
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <span class="keywordflow">return</span> $reponse;
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a>00348 
<a name="l00359"></a><a class="code" href="class_zend___mail___protocol___abstract.html#ad025c6a68277837733e0776e40446f13">00359</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___protocol___abstract.html#ad025c6a68277837733e0776e40446f13">_expect</a>($code, $timeout = null)
<a name="l00360"></a>00360     {
<a name="l00361"></a>00361         $this-&gt;_response = array();
<a name="l00362"></a>00362         $cmd = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00363"></a>00363         $msg = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00364"></a>00364         $errMsg = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366         <span class="keywordflow">if</span> (!is_array($code)) {
<a name="l00367"></a>00367             $code = array($code);
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370         <span class="keywordflow">do</span> {
<a name="l00371"></a>00371             $this-&gt;_response[] = $result = $this-&gt;<a class="code" href="class_zend___mail___protocol___abstract.html#a1b16678d668491625c5b66ee54a2838f">_receive</a>($timeout);
<a name="l00372"></a>00372             sscanf($result, $this-&gt;_template, $cmd, $msg);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374             <span class="keywordflow">if</span> ($errMsg !== <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00375"></a>00375                 $errMsg .= $msg;
<a name="l00376"></a>00376             } elseif ($cmd === null || !in_array($cmd, $code)) {
<a name="l00377"></a>00377                 $errMsg =  $msg;
<a name="l00378"></a>00378             }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         } <span class="keywordflow">while</span> (strpos($msg, <span class="charliteral">&#39;-&#39;</span>) === 0); <span class="comment">// The &#39;-&#39; message prefix indicates an information string instead of a response string.</span>
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="keywordflow">if</span> ($errMsg !== <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00386"></a>00386             require_once <span class="stringliteral">&#39;Zend/Mail/Protocol/Exception.php&#39;</span>;
<a name="l00387"></a>00387             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___protocol___exception.html">Zend_Mail_Protocol_Exception</a>($errMsg);
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <span class="keywordflow">return</span> $msg;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:17 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
