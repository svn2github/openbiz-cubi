<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Db/Adapter/Db2.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Db/Adapter/Db2.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00027"></a>00027 require_once <span class="stringliteral">&#39;Zend/Db.php&#39;</span>;
<a name="l00028"></a>00028 
<a name="l00032"></a>00032 require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Abstract.php&#39;</span>;
<a name="l00033"></a>00033 
<a name="l00037"></a>00037 require_once <span class="stringliteral">&#39;Zend/Db/Statement/Db2.php&#39;</span>;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00046"></a><a class="code" href="class_zend___db___adapter___db2.html">00046</a> <span class="keyword">class </span><a class="code" href="class_zend___db___adapter___db2.html">Zend_Db_Adapter_Db2</a> <span class="keyword">extends</span> <a class="code" href="class_zend___db___adapter___abstract.html">Zend_Db_Adapter_Abstract</a>
<a name="l00047"></a>00047 {
<a name="l00065"></a>00065     <span class="keyword">protected</span> $_config = array(
<a name="l00066"></a>00066         <span class="stringliteral">&#39;dbname&#39;</span>       =&gt; null,
<a name="l00067"></a>00067         <span class="stringliteral">&#39;username&#39;</span>     =&gt; null,
<a name="l00068"></a>00068         <span class="stringliteral">&#39;password&#39;</span>     =&gt; null,
<a name="l00069"></a>00069         <span class="stringliteral">&#39;host&#39;</span>         =&gt; <span class="stringliteral">&#39;localhost&#39;</span>,
<a name="l00070"></a>00070         <span class="stringliteral">&#39;port&#39;</span>         =&gt; <span class="stringliteral">&#39;50000&#39;</span>,
<a name="l00071"></a>00071         <span class="stringliteral">&#39;protocol&#39;</span>     =&gt; <span class="stringliteral">&#39;TCPIP&#39;</span>,
<a name="l00072"></a>00072         <span class="stringliteral">&#39;persistent&#39;</span>   =&gt; <span class="keyword">false</span>,
<a name="l00073"></a>00073         <span class="stringliteral">&#39;os&#39;</span>           =&gt; null,
<a name="l00074"></a>00074         <span class="stringliteral">&#39;schema&#39;</span>       =&gt; null
<a name="l00075"></a>00075     );
<a name="l00076"></a>00076 
<a name="l00082"></a>00082     <span class="keyword">protected</span> $_execute_mode = DB2_AUTOCOMMIT_ON;
<a name="l00083"></a>00083 
<a name="l00089"></a>00089     <span class="keyword">protected</span> $_defaultStmtClass = <span class="stringliteral">&#39;Zend_Db_Statement_Db2&#39;</span>;
<a name="l00090"></a>00090     <span class="keyword">protected</span> $_isI5 = <span class="keyword">false</span>;
<a name="l00091"></a>00091 
<a name="l00103"></a>00103     <span class="keyword">protected</span> $_numericDataTypes = array(
<a name="l00104"></a>00104         <a class="code" href="class_zend___db.html#affecef211960acad23a2b28b618b207c">Zend_Db::INT_TYPE</a>    =&gt; <a class="code" href="class_zend___db.html#affecef211960acad23a2b28b618b207c">Zend_Db::INT_TYPE</a>,
<a name="l00105"></a>00105         Zend_Db::BIGINT_TYPE =&gt; Zend_Db::BIGINT_TYPE,
<a name="l00106"></a>00106         Zend_Db::FLOAT_TYPE  =&gt; Zend_Db::FLOAT_TYPE,
<a name="l00107"></a>00107         <span class="stringliteral">&#39;INTEGER&#39;</span>            =&gt; <a class="code" href="class_zend___db.html#affecef211960acad23a2b28b618b207c">Zend_Db::INT_TYPE</a>,
<a name="l00108"></a>00108         <span class="stringliteral">&#39;SMALLINT&#39;</span>           =&gt; <a class="code" href="class_zend___db.html#affecef211960acad23a2b28b618b207c">Zend_Db::INT_TYPE</a>,
<a name="l00109"></a>00109         <span class="stringliteral">&#39;BIGINT&#39;</span>             =&gt; Zend_Db::BIGINT_TYPE,
<a name="l00110"></a>00110         <span class="stringliteral">&#39;DECIMAL&#39;</span>            =&gt; Zend_Db::FLOAT_TYPE,
<a name="l00111"></a>00111         <span class="stringliteral">&#39;NUMERIC&#39;</span>            =&gt; Zend_Db::FLOAT_TYPE
<a name="l00112"></a>00112     );
<a name="l00113"></a>00113 
<a name="l00119"></a><a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">00119</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>()
<a name="l00120"></a>00120     {
<a name="l00121"></a>00121         <span class="keywordflow">if</span> (is_resource($this-&gt;_connection)) {
<a name="l00122"></a>00122             <span class="comment">// connection already exists</span>
<a name="l00123"></a>00123             <span class="keywordflow">return</span>;
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126         <span class="keywordflow">if</span> (!extension_loaded(<span class="stringliteral">&#39;ibm_db2&#39;</span>)) {
<a name="l00130"></a>00130             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00131"></a>00131             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&#39;The IBM DB2 extension is required for this adapter but the extension is not loaded&#39;</span>);
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a581ab1db35a4a3b4ef64b543d251b463">_determineI5</a>();
<a name="l00135"></a>00135         <span class="keywordflow">if</span> ($this-&gt;_config[<span class="stringliteral">&#39;persistent&#39;</span>]) {
<a name="l00136"></a>00136             <span class="comment">// use persistent connection</span>
<a name="l00137"></a>00137             $conn_func_name = <span class="stringliteral">&#39;db2_pconnect&#39;</span>;
<a name="l00138"></a>00138         } <span class="keywordflow">else</span> {
<a name="l00139"></a>00139             <span class="comment">// use &quot;normal&quot; connection</span>
<a name="l00140"></a>00140             $conn_func_name = <span class="stringliteral">&#39;db2_connect&#39;</span>;
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143         <span class="keywordflow">if</span> (!isset($this-&gt;_config[<span class="stringliteral">&#39;driver_options&#39;</span>][<span class="stringliteral">&#39;autocommit&#39;</span>])) {
<a name="l00144"></a>00144             <span class="comment">// set execution mode</span>
<a name="l00145"></a>00145             $this-&gt;_config[<span class="stringliteral">&#39;driver_options&#39;</span>][<span class="stringliteral">&#39;autocommit&#39;</span>] = &amp;$this-&gt;_execute_mode;
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (isset($this-&gt;_config[<span class="stringliteral">&#39;options&#39;</span>][<a class="code" href="class_zend___db.html#ac0ac08a79cea345d404854dbc74d7775">Zend_Db::CASE_FOLDING</a>])) {
<a name="l00149"></a>00149             $caseAttrMap = array(
<a name="l00150"></a>00150                 Zend_Db::CASE_NATURAL =&gt; DB2_CASE_NATURAL,
<a name="l00151"></a>00151                 Zend_Db::CASE_UPPER   =&gt; DB2_CASE_UPPER,
<a name="l00152"></a>00152                 Zend_Db::CASE_LOWER   =&gt; DB2_CASE_LOWER
<a name="l00153"></a>00153             );
<a name="l00154"></a>00154             $this-&gt;_config[<span class="stringliteral">&#39;driver_options&#39;</span>][<span class="stringliteral">&#39;DB2_ATTR_CASE&#39;</span>] = $caseAttrMap[$this-&gt;_config[<span class="stringliteral">&#39;options&#39;</span>][Zend_Db::CASE_FOLDING]];
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         <span class="keywordflow">if</span> ($this-&gt;_config[<span class="stringliteral">&#39;host&#39;</span>] !== <span class="stringliteral">&#39;localhost&#39;</span> &amp;&amp; !$this-&gt;_isI5) {
<a name="l00158"></a>00158             <span class="comment">// if the host isn&#39;t localhost, use extended connection params</span>
<a name="l00159"></a>00159             $dbname = <span class="stringliteral">&#39;DRIVER={IBM DB2 ODBC DRIVER}&#39;</span> .
<a name="l00160"></a>00160                      <span class="stringliteral">&#39;;DATABASE=&#39;</span> . $this-&gt;_config[<span class="stringliteral">&#39;dbname&#39;</span>] .
<a name="l00161"></a>00161                      <span class="stringliteral">&#39;;HOSTNAME=&#39;</span> . $this-&gt;_config[<span class="stringliteral">&#39;host&#39;</span>] .
<a name="l00162"></a>00162                      <span class="stringliteral">&#39;;PORT=&#39;</span>     . $this-&gt;_config[<span class="stringliteral">&#39;port&#39;</span>] .
<a name="l00163"></a>00163                      <span class="stringliteral">&#39;;PROTOCOL=&#39;</span> . $this-&gt;_config[<span class="stringliteral">&#39;protocol&#39;</span>] .
<a name="l00164"></a>00164                      <span class="stringliteral">&#39;;UID=&#39;</span>      . $this-&gt;_config[<span class="stringliteral">&#39;username&#39;</span>] .
<a name="l00165"></a>00165                      <span class="stringliteral">&#39;;PWD=&#39;</span>      . $this-&gt;_config[<span class="stringliteral">&#39;password&#39;</span>] .<span class="charliteral">&#39;;&#39;</span>;
<a name="l00166"></a>00166             $this-&gt;_connection = $conn_func_name(
<a name="l00167"></a>00167                 $dbname,
<a name="l00168"></a>00168                 null,
<a name="l00169"></a>00169                 null,
<a name="l00170"></a>00170                 $this-&gt;_config[<span class="stringliteral">&#39;driver_options&#39;</span>]
<a name="l00171"></a>00171             );
<a name="l00172"></a>00172         } <span class="keywordflow">else</span> {
<a name="l00173"></a>00173             <span class="comment">// host is localhost, so use standard connection params</span>
<a name="l00174"></a>00174             $this-&gt;_connection = $conn_func_name(
<a name="l00175"></a>00175                 $this-&gt;_config[<span class="stringliteral">&#39;dbname&#39;</span>],
<a name="l00176"></a>00176                 $this-&gt;_config[<span class="stringliteral">&#39;username&#39;</span>],
<a name="l00177"></a>00177                 $this-&gt;_config[<span class="stringliteral">&#39;password&#39;</span>],
<a name="l00178"></a>00178                 $this-&gt;_config[<span class="stringliteral">&#39;driver_options&#39;</span>]
<a name="l00179"></a>00179             );
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182         <span class="comment">// check the connection</span>
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (!$this-&gt;_connection) {
<a name="l00187"></a>00187             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00188"></a>00188             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(db2_conn_errormsg(), db2_conn_error());
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 
<a name="l00197"></a><a class="code" href="class_zend___db___adapter___db2.html#af160f7fbbf281d018ae3162521b8267d">00197</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#af160f7fbbf281d018ae3162521b8267d">isConnected</a>()
<a name="l00198"></a>00198     {
<a name="l00199"></a>00199         <span class="keywordflow">return</span> ((<span class="keywordtype">bool</span>) (is_resource($this-&gt;_connection)
<a name="l00200"></a>00200                      &amp;&amp; get_resource_type($this-&gt;_connection) == <span class="stringliteral">&#39;DB2 Connection&#39;</span>));
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202 
<a name="l00208"></a><a class="code" href="class_zend___db___adapter___db2.html#a2decfe3602a5b089088ffd97bb6e6841">00208</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a2decfe3602a5b089088ffd97bb6e6841">closeConnection</a>()
<a name="l00209"></a>00209     {
<a name="l00210"></a>00210         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#af160f7fbbf281d018ae3162521b8267d">isConnected</a>()) {
<a name="l00211"></a>00211             db2_close($this-&gt;_connection);
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         $this-&gt;_connection = null;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00222"></a><a class="code" href="class_zend___db___adapter___db2.html#a33cccb936edee27a1e17189105dd021c">00222</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a33cccb936edee27a1e17189105dd021c">prepare</a>($sql)
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00225"></a>00225         $stmtClass = $this-&gt;_defaultStmtClass;
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (!class_exists($stmtClass)) {
<a name="l00227"></a>00227             require_once <span class="stringliteral">&#39;Zend/Loader.php&#39;</span>;
<a name="l00228"></a>00228             <a class="code" href="class_zend___loader.html#a3d4b9877e0dcc1904b8e41d86be11d93">Zend_Loader::loadClass</a>($stmtClass);
<a name="l00229"></a>00229         }
<a name="l00230"></a>00230         $stmt = <span class="keyword">new</span> $stmtClass($this, $sql);
<a name="l00231"></a>00231         $stmt-&gt;setFetchMode($this-&gt;_fetchMode);
<a name="l00232"></a>00232         <span class="keywordflow">return</span> $stmt;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234 
<a name="l00240"></a><a class="code" href="class_zend___db___adapter___db2.html#a9915373ad9f0c8a4fabf4987e63bdd03">00240</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a9915373ad9f0c8a4fabf4987e63bdd03">_getExecuteMode</a>()
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242         <span class="keywordflow">return</span> $this-&gt;_execute_mode;
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244 
<a name="l00249"></a><a class="code" href="class_zend___db___adapter___db2.html#a7c67ec8a5c0aec583bb6a76b693ba8de">00249</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a7c67ec8a5c0aec583bb6a76b693ba8de">_setExecuteMode</a>($mode)
<a name="l00250"></a>00250     {
<a name="l00251"></a>00251         <span class="keywordflow">switch</span> ($mode) {
<a name="l00252"></a>00252             <span class="keywordflow">case</span> DB2_AUTOCOMMIT_OFF:
<a name="l00253"></a>00253             <span class="keywordflow">case</span> DB2_AUTOCOMMIT_ON:
<a name="l00254"></a>00254                 $this-&gt;_execute_mode = $mode;
<a name="l00255"></a>00255                 db2_autocommit($this-&gt;_connection, $mode);
<a name="l00256"></a>00256                 <span class="keywordflow">break</span>;
<a name="l00257"></a>00257             <span class="keywordflow">default</span>:
<a name="l00261"></a>00261                 require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00262"></a>00262                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&quot;execution mode not supported&quot;</span>);
<a name="l00263"></a>00263                 <span class="keywordflow">break</span>;
<a name="l00264"></a>00264         }
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266 
<a name="l00273"></a><a class="code" href="class_zend___db___adapter___db2.html#a5f242c2d18640ed331360cf0bc4bda96">00273</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a5f242c2d18640ed331360cf0bc4bda96">_quote</a>($value)
<a name="l00274"></a>00274     {
<a name="l00275"></a>00275         <span class="keywordflow">if</span> (is_int($value) || is_float($value)) {
<a name="l00276"></a>00276             <span class="keywordflow">return</span> $value;
<a name="l00277"></a>00277         }
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (function_exists(<span class="stringliteral">&#39;db2_escape_string&#39;</span>)) {
<a name="l00284"></a>00284             <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;&quot;</span> . db2_escape_string($value) . <span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286         <span class="keywordflow">return</span> <a class="code" href="class_zend___db___adapter___db2.html#a5f242c2d18640ed331360cf0bc4bda96">parent::_quote</a>($value);
<a name="l00287"></a>00287     }
<a name="l00288"></a>00288 
<a name="l00292"></a><a class="code" href="class_zend___db___adapter___db2.html#a177b44fc2918c4333031e42aca566f69">00292</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a177b44fc2918c4333031e42aca566f69">getQuoteIdentifierSymbol</a>()
<a name="l00293"></a>00293     {
<a name="l00294"></a>00294         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00295"></a>00295         $info = db2_server_info($this-&gt;_connection);
<a name="l00296"></a>00296         <span class="keywordflow">if</span> ($info) {
<a name="l00297"></a>00297             $identQuote = $info-&gt;IDENTIFIER_QUOTE_CHAR;
<a name="l00298"></a>00298         } <span class="keywordflow">else</span> {
<a name="l00299"></a>00299             <span class="comment">// db2_server_info() does not return result on some i5 OS version</span>
<a name="l00300"></a>00300             <span class="keywordflow">if</span> ($this-&gt;_isI5) {
<a name="l00301"></a>00301                 $identQuote =<span class="stringliteral">&quot;&#39;&quot;</span>;
<a name="l00302"></a>00302             }
<a name="l00303"></a>00303         }
<a name="l00304"></a>00304         <span class="keywordflow">return</span> $identQuote;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306 
<a name="l00312"></a><a class="code" href="class_zend___db___adapter___db2.html#a60f21af07a816aa8df649554e8de6872">00312</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___abstract.html#a0b89d51988f2b14063a1f8e0c163debf">listTables</a>($schema = null)
<a name="l00313"></a>00313     {
<a name="l00314"></a>00314         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00315"></a>00315 
<a name="l00316"></a>00316         <span class="keywordflow">if</span> ($schema === null &amp;&amp; $this-&gt;_config[<span class="stringliteral">&#39;schema&#39;</span>] != null) {
<a name="l00317"></a>00317             $schema = $this-&gt;_config[<span class="stringliteral">&#39;schema&#39;</span>];
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         $tables = array();
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         <span class="keywordflow">if</span> (!$this-&gt;_isI5) {
<a name="l00323"></a>00323             <span class="keywordflow">if</span> ($schema) {
<a name="l00324"></a>00324                 $stmt = db2_tables($this-&gt;_connection, null, $schema);
<a name="l00325"></a>00325             } <span class="keywordflow">else</span> {
<a name="l00326"></a>00326                 $stmt = db2_tables($this-&gt;_connection);
<a name="l00327"></a>00327             }
<a name="l00328"></a>00328             <span class="keywordflow">while</span> ($row = db2_fetch_assoc($stmt)) {
<a name="l00329"></a>00329                 $tables[] = $row[<span class="stringliteral">&#39;TABLE_NAME&#39;</span>];
<a name="l00330"></a>00330             }
<a name="l00331"></a>00331         } <span class="keywordflow">else</span> {
<a name="l00332"></a>00332             $tables = $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a1e5351aeacdece6ee6a5556f9de7ab42">_i5listTables</a>($schema);
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <span class="keywordflow">return</span> $tables;
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 
<a name="l00368"></a><a class="code" href="class_zend___db___adapter___db2.html#a288cab0fb3686d239023c937a03b5b6f">00368</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a288cab0fb3686d239023c937a03b5b6f">describeTable</a>($tableName, $schemaName = null)
<a name="l00369"></a>00369     {
<a name="l00370"></a>00370         <span class="comment">// Ensure the connection is made so that _isI5 is set</span>
<a name="l00371"></a>00371         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="keywordflow">if</span> ($schemaName === null &amp;&amp; $this-&gt;_config[<span class="stringliteral">&#39;schema&#39;</span>] != null) {
<a name="l00374"></a>00374             $schemaName = $this-&gt;_config[<span class="stringliteral">&#39;schema&#39;</span>];
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="keywordflow">if</span> (!$this-&gt;_isI5) {
<a name="l00378"></a>00378 
<a name="l00379"></a>00379             $sql = <span class="stringliteral">&quot;SELECT DISTINCT c.tabschema, c.tabname, c.colname, c.colno,</span>
<a name="l00380"></a>00380 <span class="stringliteral">                c.typename, c.default, c.nulls, c.length, c.scale,</span>
<a name="l00381"></a>00381 <span class="stringliteral">                c.identity, tc.type AS tabconsttype, k.colseq</span>
<a name="l00382"></a>00382 <span class="stringliteral">                FROM syscat.columns c</span>
<a name="l00383"></a>00383 <span class="stringliteral">                LEFT JOIN (syscat.keycoluse k JOIN syscat.tabconst tc</span>
<a name="l00384"></a>00384 <span class="stringliteral">                ON (k.tabschema = tc.tabschema</span>
<a name="l00385"></a>00385 <span class="stringliteral">                    AND k.tabname = tc.tabname</span>
<a name="l00386"></a>00386 <span class="stringliteral">                    AND tc.type = &#39;P&#39;))</span>
<a name="l00387"></a>00387 <span class="stringliteral">                ON (c.tabschema = k.tabschema</span>
<a name="l00388"></a>00388 <span class="stringliteral">                    AND c.tabname = k.tabname</span>
<a name="l00389"></a>00389 <span class="stringliteral">                    AND c.colname = k.colname)</span>
<a name="l00390"></a>00390 <span class="stringliteral">                WHERE &quot;</span>
<a name="l00391"></a>00391                 . $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a0beadbb972e664d0970c63dc3246b6ba">quoteInto</a>(<span class="stringliteral">&#39;UPPER(c.tabname) = UPPER(?)&#39;</span>, $tableName);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393             <span class="keywordflow">if</span> ($schemaName) {
<a name="l00394"></a>00394                $sql .= $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a0beadbb972e664d0970c63dc3246b6ba">quoteInto</a>(<span class="stringliteral">&#39; AND UPPER(c.tabschema) = UPPER(?)&#39;</span>, $schemaName);
<a name="l00395"></a>00395             }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397             $sql .= <span class="stringliteral">&quot; ORDER BY c.colno&quot;</span>;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         } <span class="keywordflow">else</span> {
<a name="l00400"></a>00400 
<a name="l00401"></a>00401             <span class="comment">// DB2 On I5 specific query</span>
<a name="l00402"></a>00402             $sql = <span class="stringliteral">&quot;SELECT DISTINCT C.TABLE_SCHEMA, C.TABLE_NAME, C.COLUMN_NAME, C.ORDINAL_POSITION,</span>
<a name="l00403"></a>00403 <span class="stringliteral">                C.DATA_TYPE, C.COLUMN_DEFAULT, C.NULLS ,C.LENGTH, C.SCALE, LEFT(C.IDENTITY,1),</span>
<a name="l00404"></a>00404 <span class="stringliteral">                LEFT(tc.TYPE, 1) AS tabconsttype, k.COLSEQ</span>
<a name="l00405"></a>00405 <span class="stringliteral">                FROM QSYS2.SYSCOLUMNS C</span>
<a name="l00406"></a>00406 <span class="stringliteral">                LEFT JOIN (QSYS2.syskeycst k JOIN QSYS2.SYSCST tc</span>
<a name="l00407"></a>00407 <span class="stringliteral">                    ON (k.TABLE_SCHEMA = tc.TABLE_SCHEMA</span>
<a name="l00408"></a>00408 <span class="stringliteral">                      AND k.TABLE_NAME = tc.TABLE_NAME</span>
<a name="l00409"></a>00409 <span class="stringliteral">                      AND LEFT(tc.type,1) = &#39;P&#39;))</span>
<a name="l00410"></a>00410 <span class="stringliteral">                    ON (C.TABLE_SCHEMA = k.TABLE_SCHEMA</span>
<a name="l00411"></a>00411 <span class="stringliteral">                       AND C.TABLE_NAME = k.TABLE_NAME</span>
<a name="l00412"></a>00412 <span class="stringliteral">                       AND C.COLUMN_NAME = k.COLUMN_NAME)</span>
<a name="l00413"></a>00413 <span class="stringliteral">                WHERE &quot;</span>
<a name="l00414"></a>00414                  . $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a0beadbb972e664d0970c63dc3246b6ba">quoteInto</a>(<span class="stringliteral">&#39;UPPER(C.TABLE_NAME) = UPPER(?)&#39;</span>, $tableName);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416             <span class="keywordflow">if</span> ($schemaName) {
<a name="l00417"></a>00417                 $sql .= $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a0beadbb972e664d0970c63dc3246b6ba">quoteInto</a>(<span class="stringliteral">&#39; AND UPPER(C.TABLE_SCHEMA) = UPPER(?)&#39;</span>, $schemaName);
<a name="l00418"></a>00418             }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420             $sql .= <span class="stringliteral">&quot; ORDER BY C.ORDINAL_POSITION FOR FETCH ONLY&quot;</span>;
<a name="l00421"></a>00421         }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423         $desc = array();
<a name="l00424"></a>00424         $stmt = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a0ab4447e4f026ef4f4c9087eb77a6f00">query</a>($sql);
<a name="l00425"></a>00425 
<a name="l00429"></a>00429         $result = $stmt-&gt;fetchAll(Zend_Db::FETCH_NUM);
<a name="l00430"></a>00430 
<a name="l00435"></a>00435         $tabschema      = 0;
<a name="l00436"></a>00436         $tabname        = 1;
<a name="l00437"></a>00437         $colname        = 2;
<a name="l00438"></a>00438         $colno          = 3;
<a name="l00439"></a>00439         $typename       = 4;
<a name="l00440"></a>00440         $default        = 5;
<a name="l00441"></a>00441         $nulls          = 6;
<a name="l00442"></a>00442         $length         = 7;
<a name="l00443"></a>00443         $scale          = 8;
<a name="l00444"></a>00444         $identityCol    = 9;
<a name="l00445"></a>00445         $tabconstType   = 10;
<a name="l00446"></a>00446         $colseq         = 11;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         <span class="keywordflow">foreach</span> ($result as $key =&gt; $row) {
<a name="l00449"></a>00449             list ($primary, $primaryPosition, $identity) = array(<span class="keyword">false</span>, null, <span class="keyword">false</span>);
<a name="l00450"></a>00450             <span class="keywordflow">if</span> ($row[$tabconstType] == <span class="charliteral">&#39;P&#39;</span>) {
<a name="l00451"></a>00451                 $primary = <span class="keyword">true</span>;
<a name="l00452"></a>00452                 $primaryPosition = $row[$colseq];
<a name="l00453"></a>00453             }
<a name="l00458"></a>00458             <span class="keywordflow">if</span> ($row[$identityCol] == <span class="charliteral">&#39;Y&#39;</span>) {
<a name="l00459"></a>00459                 $identity = <span class="keyword">true</span>;
<a name="l00460"></a>00460             }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462             <span class="comment">// only colname needs to be case adjusted</span>
<a name="l00463"></a>00463             $desc[$this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#ab89af22178ef3b9eb869db019c757203">foldCase</a>($row[$colname])] = array(
<a name="l00464"></a>00464                 <span class="stringliteral">&#39;SCHEMA_NAME&#39;</span>      =&gt; $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#ab89af22178ef3b9eb869db019c757203">foldCase</a>($row[$tabschema]),
<a name="l00465"></a>00465                 <span class="stringliteral">&#39;TABLE_NAME&#39;</span>       =&gt; $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#ab89af22178ef3b9eb869db019c757203">foldCase</a>($row[$tabname]),
<a name="l00466"></a>00466                 <span class="stringliteral">&#39;COLUMN_NAME&#39;</span>      =&gt; $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#ab89af22178ef3b9eb869db019c757203">foldCase</a>($row[$colname]),
<a name="l00467"></a>00467                 <span class="stringliteral">&#39;COLUMN_POSITION&#39;</span>  =&gt; (!$this-&gt;_isI5) ? $row[$colno]+1 : $row[$colno],
<a name="l00468"></a>00468                 <span class="stringliteral">&#39;DATA_TYPE&#39;</span>        =&gt; $row[$typename],
<a name="l00469"></a>00469                 <span class="stringliteral">&#39;DEFAULT&#39;</span>          =&gt; $row[$default],
<a name="l00470"></a>00470                 <span class="stringliteral">&#39;NULLABLE&#39;</span>         =&gt; (<span class="keywordtype">bool</span>) ($row[$nulls] == <span class="charliteral">&#39;Y&#39;</span>),
<a name="l00471"></a>00471                 <span class="stringliteral">&#39;LENGTH&#39;</span>           =&gt; $row[$length],
<a name="l00472"></a>00472                 <span class="stringliteral">&#39;SCALE&#39;</span>            =&gt; $row[$scale],
<a name="l00473"></a>00473                 <span class="stringliteral">&#39;PRECISION&#39;</span>        =&gt; ($row[$typename] == <span class="stringliteral">&#39;DECIMAL&#39;</span> ? $row[$length] : 0),
<a name="l00474"></a>00474                 <span class="stringliteral">&#39;UNSIGNED&#39;</span>         =&gt; <span class="keyword">false</span>,
<a name="l00475"></a>00475                 <span class="stringliteral">&#39;PRIMARY&#39;</span>          =&gt; $primary,
<a name="l00476"></a>00476                 <span class="stringliteral">&#39;PRIMARY_POSITION&#39;</span> =&gt; $primaryPosition,
<a name="l00477"></a>00477                 <span class="stringliteral">&#39;IDENTITY&#39;</span>         =&gt; $identity
<a name="l00478"></a>00478             );
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="keywordflow">return</span> $desc;
<a name="l00482"></a>00482     }
<a name="l00483"></a>00483 
<a name="l00492"></a><a class="code" href="class_zend___db___adapter___db2.html#a677a4a3a74151c7319a926c9953d7ba0">00492</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a677a4a3a74151c7319a926c9953d7ba0">lastSequenceId</a>($sequenceName)
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         <span class="keywordflow">if</span> (!$this-&gt;_isI5) {
<a name="l00497"></a>00497             $quotedSequenceName = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a251c08713c7cc7b6def84fe31aea2141">quoteIdentifier</a>($sequenceName, <span class="keyword">true</span>);
<a name="l00498"></a>00498             $sql = <span class="stringliteral">&#39;SELECT PREVVAL FOR &#39;</span> . $quotedSequenceName . <span class="stringliteral">&#39; AS VAL FROM SYSIBM.SYSDUMMY1&#39;</span>;
<a name="l00499"></a>00499         } <span class="keywordflow">else</span> {
<a name="l00500"></a>00500             $quotedSequenceName = $sequenceName;
<a name="l00501"></a>00501             $sql = <span class="stringliteral">&#39;SELECT PREVVAL FOR &#39;</span> . $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a251c08713c7cc7b6def84fe31aea2141">quoteIdentifier</a>($sequenceName, <span class="keyword">true</span>) . <span class="stringliteral">&#39; AS VAL FROM QSYS2.QSQPTABL&#39;</span>;
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         $value = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a8cc8115e071a7c1dbbe622fc215daec7">fetchOne</a>($sql);
<a name="l00505"></a>00505         <span class="keywordflow">return</span> (<span class="keywordtype">string</span>) $value;
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507 
<a name="l00516"></a><a class="code" href="class_zend___db___adapter___db2.html#aada1f1f761da6bb9b168863f0291f9f9">00516</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#aada1f1f761da6bb9b168863f0291f9f9">nextSequenceId</a>($sequenceName)
<a name="l00517"></a>00517     {
<a name="l00518"></a>00518         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00519"></a>00519         $sql = <span class="stringliteral">&#39;SELECT NEXTVAL FOR &#39;</span>.$this-&gt;quoteIdentifier($sequenceName, <span class="keyword">true</span>).<span class="stringliteral">&#39; AS VAL FROM SYSIBM.SYSDUMMY1&#39;</span>;
<a name="l00520"></a>00520         $value = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a8cc8115e071a7c1dbbe622fc215daec7">fetchOne</a>($sql);
<a name="l00521"></a>00521         <span class="keywordflow">return</span> (<span class="keywordtype">string</span>) $value;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523 
<a name="l00543"></a><a class="code" href="class_zend___db___adapter___db2.html#a105e565b27862b6dbe31c03ec6d21f81">00543</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a105e565b27862b6dbe31c03ec6d21f81">lastInsertId</a>($tableName = null, $primaryKey = null, $idType = null)
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="keywordflow">if</span> ($this-&gt;_isI5) {
<a name="l00548"></a>00548             <span class="keywordflow">return</span> (<span class="keywordtype">string</span>) $this-&gt;_i5LastInsertId($tableName, $idType);
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="keywordflow">if</span> ($tableName !== null) {
<a name="l00552"></a>00552             $sequenceName = $tableName;
<a name="l00553"></a>00553             <span class="keywordflow">if</span> ($primaryKey) {
<a name="l00554"></a>00554                 $sequenceName .= <span class="stringliteral">&quot;_$primaryKey&quot;</span>;
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556             $sequenceName .= <span class="stringliteral">&#39;_seq&#39;</span>;
<a name="l00557"></a>00557             <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a677a4a3a74151c7319a926c9953d7ba0">lastSequenceId</a>($sequenceName);
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         $sql = <span class="stringliteral">&#39;SELECT IDENTITY_VAL_LOCAL() AS VAL FROM SYSIBM.SYSDUMMY1&#39;</span>;
<a name="l00561"></a>00561         $value = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a8cc8115e071a7c1dbbe622fc215daec7">fetchOne</a>($sql);
<a name="l00562"></a>00562         <span class="keywordflow">return</span> (<span class="keywordtype">string</span>) $value;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 
<a name="l00570"></a><a class="code" href="class_zend___db___adapter___db2.html#afdb24c1d71bb26311e8c66b479af1b8a">00570</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#afdb24c1d71bb26311e8c66b479af1b8a">_beginTransaction</a>()
<a name="l00571"></a>00571     {
<a name="l00572"></a>00572         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a7c67ec8a5c0aec583bb6a76b693ba8de">_setExecuteMode</a>(DB2_AUTOCOMMIT_OFF);
<a name="l00573"></a>00573     }
<a name="l00574"></a>00574 
<a name="l00580"></a><a class="code" href="class_zend___db___adapter___db2.html#a7b56e3efd348cd6014c8ad7694a951fd">00580</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a7b56e3efd348cd6014c8ad7694a951fd">_commit</a>()
<a name="l00581"></a>00581     {
<a name="l00582"></a>00582         <span class="keywordflow">if</span> (!db2_commit($this-&gt;_connection)) {
<a name="l00586"></a>00586             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00587"></a>00587             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(
<a name="l00588"></a>00588                 db2_conn_errormsg($this-&gt;_connection),
<a name="l00589"></a>00589                 db2_conn_error($this-&gt;_connection));
<a name="l00590"></a>00590         }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a7c67ec8a5c0aec583bb6a76b693ba8de">_setExecuteMode</a>(DB2_AUTOCOMMIT_ON);
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594 
<a name="l00600"></a><a class="code" href="class_zend___db___adapter___db2.html#a902e8f39084ade8cacd541700b322659">00600</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a902e8f39084ade8cacd541700b322659">_rollBack</a>()
<a name="l00601"></a>00601     {
<a name="l00602"></a>00602         <span class="keywordflow">if</span> (!db2_rollback($this-&gt;_connection)) {
<a name="l00606"></a>00606             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00607"></a>00607             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(
<a name="l00608"></a>00608                 db2_conn_errormsg($this-&gt;_connection),
<a name="l00609"></a>00609                 db2_conn_error($this-&gt;_connection));
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a7c67ec8a5c0aec583bb6a76b693ba8de">_setExecuteMode</a>(DB2_AUTOCOMMIT_ON);
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00621"></a><a class="code" href="class_zend___db___adapter___db2.html#a4b9656d6a7e39776b44c1a930704b743">00621</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a4b9656d6a7e39776b44c1a930704b743">setFetchMode</a>($mode)
<a name="l00622"></a>00622     {
<a name="l00623"></a>00623         <span class="keywordflow">switch</span> ($mode) {
<a name="l00624"></a>00624             <span class="keywordflow">case</span> Zend_Db::FETCH_NUM:   <span class="comment">// seq array</span>
<a name="l00625"></a>00625             <span class="keywordflow">case</span> Zend_Db::FETCH_ASSOC: <span class="comment">// assoc array</span>
<a name="l00626"></a>00626             <span class="keywordflow">case</span> Zend_Db::FETCH_BOTH:  <span class="comment">// seq+assoc array</span>
<a name="l00627"></a>00627             <span class="keywordflow">case</span> Zend_Db::FETCH_OBJ:   <span class="comment">// object</span>
<a name="l00628"></a>00628                 $this-&gt;_fetchMode = $mode;
<a name="l00629"></a>00629                 <span class="keywordflow">break</span>;
<a name="l00630"></a>00630             <span class="keywordflow">case</span> Zend_Db::FETCH_BOUND:   <span class="comment">// bound to PHP variable</span>
<a name="l00634"></a>00634 <span class="comment"></span>                require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00635"></a>00635                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&#39;FETCH_BOUND is not supported yet&#39;</span>);
<a name="l00636"></a>00636                 <span class="keywordflow">break</span>;
<a name="l00637"></a>00637             <span class="keywordflow">default</span>:
<a name="l00641"></a>00641                 require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00642"></a>00642                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&quot;Invalid fetch mode &#39;$mode&#39; specified&quot;</span>);
<a name="l00643"></a>00643                 <span class="keywordflow">break</span>;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646 
<a name="l00655"></a><a class="code" href="class_zend___db___adapter___db2.html#aad2efb060c4bfe653662bd962e17ef46">00655</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#aad2efb060c4bfe653662bd962e17ef46">limit</a>($sql, $count, $offset = 0)
<a name="l00656"></a>00656     {
<a name="l00657"></a>00657         $count = intval($count);
<a name="l00658"></a>00658         <span class="keywordflow">if</span> ($count &lt;= 0) {
<a name="l00662"></a>00662             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00663"></a>00663             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&quot;LIMIT argument count=$count is not valid&quot;</span>);
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666         $offset = intval($offset);
<a name="l00667"></a>00667         <span class="keywordflow">if</span> ($offset &lt; 0) {
<a name="l00671"></a>00671             require_once <span class="stringliteral">&#39;Zend/Db/Adapter/Db2/Exception.php&#39;</span>;
<a name="l00672"></a>00672             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___db___adapter___db2___exception.html">Zend_Db_Adapter_Db2_Exception</a>(<span class="stringliteral">&quot;LIMIT argument offset=$offset is not valid&quot;</span>);
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675         <span class="keywordflow">if</span> ($offset == 0) {
<a name="l00676"></a>00676             $limit_sql = $sql . <span class="stringliteral">&quot; FETCH FIRST $count ROWS ONLY&quot;</span>;
<a name="l00677"></a>00677             <span class="keywordflow">return</span> $limit_sql;
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679 
<a name="l00686"></a>00686         $limit_sql = <span class="stringliteral">&quot;SELECT z2.*</span>
<a name="l00687"></a>00687 <span class="stringliteral">            FROM (</span>
<a name="l00688"></a>00688 <span class="stringliteral">                SELECT ROW_NUMBER() OVER() AS \&quot;ZEND_DB_ROWNUM\&quot;, z1.*</span>
<a name="l00689"></a>00689 <span class="stringliteral">                FROM (</span>
<a name="l00690"></a>00690 <span class="stringliteral">                    &quot;</span> . $sql . <span class="stringliteral">&quot;</span>
<a name="l00691"></a>00691 <span class="stringliteral">                ) z1</span>
<a name="l00692"></a>00692 <span class="stringliteral">            ) z2</span>
<a name="l00693"></a>00693 <span class="stringliteral">            WHERE z2.zend_db_rownum BETWEEN &quot;</span> . ($offset+1) . <span class="stringliteral">&quot; AND &quot;</span> . ($offset+$count);
<a name="l00694"></a>00694         <span class="keywordflow">return</span> $limit_sql;
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696 
<a name="l00703"></a><a class="code" href="class_zend___db___adapter___db2.html#ab52f66eccf8ed211b09521fc74b1623d">00703</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#ab52f66eccf8ed211b09521fc74b1623d">supportsParameters</a>($type)
<a name="l00704"></a>00704     {
<a name="l00705"></a>00705         <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;positional&#39;</span>) {
<a name="l00706"></a>00706             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709         <span class="comment">// if its &#39;named&#39; or anything else</span>
<a name="l00710"></a>00710         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00711"></a>00711     }
<a name="l00712"></a>00712 
<a name="l00718"></a><a class="code" href="class_zend___db___adapter___db2.html#a2d047b148eb053baba2150cc7d5d9545">00718</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a2d047b148eb053baba2150cc7d5d9545">getServerVersion</a>()
<a name="l00719"></a>00719     {
<a name="l00720"></a>00720         $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a056510893d19074b6d9138db970a8843">_connect</a>();
<a name="l00721"></a>00721         $server_info = db2_server_info($this-&gt;_connection);
<a name="l00722"></a>00722         <span class="keywordflow">if</span> ($server_info !== <span class="keyword">false</span>) {
<a name="l00723"></a>00723             $version = $server_info-&gt;DBMS_VER;
<a name="l00724"></a>00724             <span class="keywordflow">if</span> ($this-&gt;_isI5) {
<a name="l00725"></a>00725                 $version = (int) substr($version, 0, 2) . <span class="charliteral">&#39;.&#39;</span> . (int) substr($version, 2, 2) . <span class="charliteral">&#39;.&#39;</span> . (int) substr($version, 4);
<a name="l00726"></a>00726             }
<a name="l00727"></a>00727             <span class="keywordflow">return</span> $version;
<a name="l00728"></a>00728         } <span class="keywordflow">else</span> {
<a name="l00729"></a>00729             <span class="keywordflow">return</span> null;
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732 
<a name="l00738"></a><a class="code" href="class_zend___db___adapter___db2.html#a1f2475118b3f50d69d594c7219868ee7">00738</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___db___adapter___db2.html#a1f2475118b3f50d69d594c7219868ee7">isI5</a>()
<a name="l00739"></a>00739     {
<a name="l00740"></a>00740         <span class="keywordflow">if</span> ($this-&gt;_isI5 === null) {
<a name="l00741"></a>00741             $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a581ab1db35a4a3b4ef64b543d251b463">_determineI5</a>();
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         <span class="keywordflow">return</span> (<span class="keywordtype">bool</span>) $this-&gt;_isI5;
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00753"></a><a class="code" href="class_zend___db___adapter___db2.html#a581ab1db35a4a3b4ef64b543d251b463">00753</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a581ab1db35a4a3b4ef64b543d251b463">_determineI5</a>()
<a name="l00754"></a>00754     {
<a name="l00755"></a>00755         <span class="comment">// first us the compiled flag.</span>
<a name="l00756"></a>00756         $this-&gt;_isI5 = (php_uname(<span class="charliteral">&#39;s&#39;</span>) == <span class="stringliteral">&#39;OS400&#39;</span>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758         <span class="comment">// if this is set, then us it</span>
<a name="l00759"></a>00759         <span class="keywordflow">if</span> (isset($this-&gt;_config[<span class="stringliteral">&#39;os&#39;</span>])){
<a name="l00760"></a>00760             <span class="keywordflow">if</span> (strtolower($this-&gt;_config[<span class="stringliteral">&#39;os&#39;</span>]) === <span class="stringliteral">&#39;i5&#39;</span>) {
<a name="l00761"></a>00761                 $this-&gt;_isI5 = <span class="keyword">true</span>;
<a name="l00762"></a>00762             } <span class="keywordflow">else</span> {
<a name="l00763"></a>00763                 <span class="comment">// any other value passed in, its null</span>
<a name="l00764"></a>00764                 $this-&gt;_isI5 = <span class="keyword">false</span>;
<a name="l00765"></a>00765             }
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769 
<a name="l00778"></a><a class="code" href="class_zend___db___adapter___db2.html#a1e5351aeacdece6ee6a5556f9de7ab42">00778</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___db___adapter___db2.html#a1e5351aeacdece6ee6a5556f9de7ab42">_i5listTables</a>($schema = null)
<a name="l00779"></a>00779     {
<a name="l00780"></a>00780         <span class="comment">//list of i5 libraries.</span>
<a name="l00781"></a>00781         $tables = array();
<a name="l00782"></a>00782         <span class="keywordflow">if</span> ($schema) {
<a name="l00783"></a>00783             $tablesStatement = db2_tables($this-&gt;_connection, null, $schema);
<a name="l00784"></a>00784             <span class="keywordflow">while</span> ($rowTables = db2_fetch_assoc($tablesStatement) ) {
<a name="l00785"></a>00785                 <span class="keywordflow">if</span> ($rowTables[<span class="stringliteral">&#39;TABLE_NAME&#39;</span>] !== null) {
<a name="l00786"></a>00786                     $tables[] = $rowTables[<span class="stringliteral">&#39;TABLE_NAME&#39;</span>];
<a name="l00787"></a>00787                 }
<a name="l00788"></a>00788             }
<a name="l00789"></a>00789         } <span class="keywordflow">else</span> {
<a name="l00790"></a>00790             $schemaStatement = db2_tables($this-&gt;_connection);
<a name="l00791"></a>00791             <span class="keywordflow">while</span> ($schema = db2_fetch_assoc($schemaStatement)) {
<a name="l00792"></a>00792                 <span class="keywordflow">if</span> ($schema[<span class="stringliteral">&#39;TABLE_SCHEM&#39;</span>] !== null) {
<a name="l00793"></a>00793                     <span class="comment">// list of the tables which belongs to the selected library</span>
<a name="l00794"></a>00794                     $tablesStatement = db2_tables($this-&gt;_connection, NULL, $schema[<span class="stringliteral">&#39;TABLE_SCHEM&#39;</span>]);
<a name="l00795"></a>00795                     <span class="keywordflow">if</span> (is_resource($tablesStatement)) {
<a name="l00796"></a>00796                         <span class="keywordflow">while</span> ($rowTables = db2_fetch_assoc($tablesStatement) ) {
<a name="l00797"></a>00797                             <span class="keywordflow">if</span> ($rowTables[<span class="stringliteral">&#39;TABLE_NAME&#39;</span>] !== null) {
<a name="l00798"></a>00798                                 $tables[] = $rowTables[<span class="stringliteral">&#39;TABLE_NAME&#39;</span>];
<a name="l00799"></a>00799                             }
<a name="l00800"></a>00800                         }
<a name="l00801"></a>00801                     }
<a name="l00802"></a>00802                 }
<a name="l00803"></a>00803             }
<a name="l00804"></a>00804         }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806         <span class="keywordflow">return</span> $tables;
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keyword">protected</span> function _i5LastInsertId($objectName = null, $idType = null)
<a name="l00810"></a>00810     {
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">if</span> ($objectName === null) {
<a name="l00813"></a>00813             $sql = <span class="stringliteral">&#39;SELECT IDENTITY_VAL_LOCAL() AS VAL FROM QSYS2.QSQPTABL&#39;</span>;
<a name="l00814"></a>00814             $value = $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a8cc8115e071a7c1dbbe622fc215daec7">fetchOne</a>($sql);
<a name="l00815"></a>00815             <span class="keywordflow">return</span> $value;
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (strtoupper($idType) === <span class="charliteral">&#39;S&#39;</span>){
<a name="l00819"></a>00819             <span class="comment">//check i5_lib option</span>
<a name="l00820"></a>00820             $sequenceName = $objectName;
<a name="l00821"></a>00821             <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___db___adapter___db2.html#a677a4a3a74151c7319a926c9953d7ba0">lastSequenceId</a>($sequenceName);
<a name="l00822"></a>00822         }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824             <span class="comment">//returns last identity value for the specified table</span>
<a name="l00825"></a>00825         <span class="comment">//if (strtoupper($idType) === &#39;I&#39;) {</span>
<a name="l00826"></a>00826         $tableName = $objectName;
<a name="l00827"></a>00827         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a8cc8115e071a7c1dbbe622fc215daec7">fetchOne</a>(<span class="stringliteral">&#39;SELECT IDENTITY_VAL_LOCAL() from &#39;</span> . $this-&gt;<a class="code" href="class_zend___db___adapter___abstract.html#a251c08713c7cc7b6def84fe31aea2141">quoteIdentifier</a>($tableName));
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00832"></a>00832 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:17 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
