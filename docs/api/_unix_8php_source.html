<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/ZendX/Console/Process/Unix.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/ZendX/Console/Process/Unix.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00031"></a><a class="code" href="class_zend_x___console___process___unix.html">00031</a> <span class="keyword">abstract</span> <span class="keyword">class </span><a class="code" href="class_zend_x___console___process___unix.html">ZendX_Console_Process_Unix</a>
<a name="l00032"></a>00032 {
<a name="l00036"></a><a class="code" href="class_zend_x___console___process___unix.html#af7b433fbf6e0373114ce0ff390d363bf">00036</a>     <span class="keyword">const</span> <a class="code" href="class_zend_x___console___process___unix.html#af7b433fbf6e0373114ce0ff390d363bf">VOID_METHOD</a> = <span class="stringliteral">&#39;void_method&#39;</span>;
<a name="l00037"></a>00037 
<a name="l00041"></a><a class="code" href="class_zend_x___console___process___unix.html#ab1262e9545d58ddcde485e0146ba0748">00041</a>     <span class="keyword">const</span> <a class="code" href="class_zend_x___console___process___unix.html#ab1262e9545d58ddcde485e0146ba0748">RETURN_METHOD</a> = <span class="stringliteral">&#39;void_method&#39;</span>;
<a name="l00042"></a>00042     
<a name="l00048"></a>00048     <span class="keyword">private</span> $_name;
<a name="l00049"></a>00049 
<a name="l00055"></a>00055     <span class="keyword">private</span> $_pid = null;
<a name="l00056"></a>00056 
<a name="l00062"></a>00062     <span class="keyword">private</span> $_puid = null;
<a name="l00063"></a>00063 
<a name="l00069"></a>00069     <span class="keyword">private</span> $_guid = null;
<a name="l00070"></a>00070 
<a name="l00076"></a>00076     <span class="keyword">private</span> $_isRunning = <span class="keyword">false</span>;
<a name="l00077"></a>00077 
<a name="l00083"></a>00083     <span class="keyword">private</span> $_isChild = <span class="keyword">false</span>;
<a name="l00084"></a>00084 
<a name="l00090"></a>00090     <span class="keyword">private</span> $_internalIpcData = array();
<a name="l00091"></a>00091 
<a name="l00097"></a>00097     <span class="keyword">private</span> $_internalIpcKey;
<a name="l00098"></a>00098 
<a name="l00104"></a>00104     <span class="keyword">private</span> $_internalSemKey;
<a name="l00105"></a>00105 
<a name="l00112"></a>00112     <span class="keyword">private</span> $_ipcIsOkay;
<a name="l00113"></a>00113 
<a name="l00119"></a>00119     <span class="keyword">private</span> $_ipcSegFile;
<a name="l00120"></a>00120 
<a name="l00126"></a>00126     <span class="keyword">private</span> $_ipcSemFile;
<a name="l00127"></a>00127 
<a name="l00144"></a><a class="code" href="class_zend_x___console___process___unix.html#a71e9a0d23a55d833a0ee6e3bae47067a">00144</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a71e9a0d23a55d833a0ee6e3bae47067a">__construct</a>($puid = null, $guid = null, $umask = null)
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <span class="keywordflow">if</span> (substr(PHP_OS, 0, 3) === <span class="stringliteral">&#39;WIN&#39;</span>) {
<a name="l00147"></a>00147             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00148"></a>00148             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Cannot run on windows&#39;</span>);
<a name="l00149"></a>00149         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!in_array(substr(PHP_SAPI, 0, 3), array(<span class="stringliteral">&#39;cli&#39;</span>, <span class="stringliteral">&#39;cgi&#39;</span>))) {
<a name="l00150"></a>00150             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00151"></a>00151             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Can only run on CLI or CGI enviroment&#39;</span>);
<a name="l00152"></a>00152         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;shmop_open&#39;</span>)) {
<a name="l00153"></a>00153             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00154"></a>00154             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;shmop_* functions are required&#39;</span>);
<a name="l00155"></a>00155         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;pcntl_fork&#39;</span>)) {
<a name="l00156"></a>00156             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00157"></a>00157             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;pcntl_* functions are required&#39;</span>);
<a name="l00158"></a>00158         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!function_exists(<span class="stringliteral">&#39;posix_kill&#39;</span>)) {
<a name="l00159"></a>00159             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00160"></a>00160             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;posix_* functions are required&#39;</span>);
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162     
<a name="l00163"></a>00163         $this-&gt;_isRunning = <span class="keyword">false</span>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         $this-&gt;_name = md5(uniqid(rand()));
<a name="l00166"></a>00166         $this-&gt;_guid = $guid;
<a name="l00167"></a>00167         $this-&gt;_puid = $puid;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="keywordflow">if</span> ($umask !== null) {
<a name="l00170"></a>00170             umask($umask);
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="comment">// Try to create the shared memory segment. The variable</span>
<a name="l00174"></a>00174         <span class="comment">// $this-&gt;_ipcIsOkay contains the return code of this operation and must</span>
<a name="l00175"></a>00175         <span class="comment">// be checked before forking</span>
<a name="l00176"></a>00176         <span class="keywordflow">if</span> ($this-&gt;_createIpcSegment() &amp;&amp; $this-&gt;_createIpcSemaphore()) {
<a name="l00177"></a>00177             $this-&gt;_ipcIsOkay = <span class="keyword">true</span>;
<a name="l00178"></a>00178         } <span class="keywordflow">else</span> {
<a name="l00179"></a>00179             $this-&gt;_ipcIsOkay = <span class="keyword">false</span>;
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182     
<a name="l00186"></a><a class="code" href="class_zend_x___console___process___unix.html#a421831a265621325e1fdd19aace0c758">00186</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a421831a265621325e1fdd19aace0c758">__destruct</a>()
<a name="l00187"></a>00187     {
<a name="l00188"></a>00188         <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_zend_x___console___process___unix.html#ad7e54aa55e82e9be1428d9fa8eb559a5">isRunning</a>()) {
<a name="l00189"></a>00189             $this-&gt;<a class="code" href="class_zend_x___console___process___unix.html#a8b6fc76a620d7557d06e9a11a9ffb509">stop</a>();
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192     
<a name="l00207"></a><a class="code" href="class_zend_x___console___process___unix.html#af8fa59992209e36dccb3eefb0f75531f">00207</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#af8fa59992209e36dccb3eefb0f75531f">start</a>()
<a name="l00208"></a>00208     {
<a name="l00209"></a>00209         <span class="keywordflow">if</span> (!$this-&gt;_ipcIsOkay) {
<a name="l00210"></a>00210             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00211"></a>00211             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Unable to create SHM segments for process communications&#39;</span>);
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         <span class="comment">// @see http://www.php.net/manual/en/function.pcntl-fork.php#41150</span>
<a name="l00215"></a>00215         @ob_end_flush();
<a name="l00216"></a>00216         
<a name="l00217"></a>00217         pcntl_signal(SIGCHLD, SIG_IGN);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         $pid = @pcntl_fork();
<a name="l00220"></a>00220         <span class="keywordflow">if</span> ($pid === -1) {
<a name="l00221"></a>00221             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00222"></a>00222             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Forking process failed&#39;</span>);
<a name="l00223"></a>00223         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($pid === 0) {
<a name="l00224"></a>00224             <span class="comment">// This is the child</span>
<a name="l00225"></a>00225             $this-&gt;_isChild = <span class="keyword">true</span>;
<a name="l00226"></a>00226            
<a name="l00227"></a>00227             <span class="comment">// Sleep a second to avoid problems</span>
<a name="l00228"></a>00228             sleep(1);
<a name="l00229"></a>00229             
<a name="l00230"></a>00230             <span class="comment">// Install the signal handler</span>
<a name="l00231"></a>00231             pcntl_signal(SIGUSR1, array($this, <span class="stringliteral">&#39;_sigHandler&#39;</span>));
<a name="l00232"></a>00232 
<a name="l00233"></a>00233             <span class="comment">// If requested, change process identity</span>
<a name="l00234"></a>00234             <span class="keywordflow">if</span> ($this-&gt;_guid !== null) {
<a name="l00235"></a>00235                 posix_setgid($this-&gt;_guid);
<a name="l00236"></a>00236             }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238             <span class="keywordflow">if</span> ($this-&gt;_puid !== null) {
<a name="l00239"></a>00239                 posix_setuid($this-&gt;_puid);
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242             <span class="comment">// Run the child</span>
<a name="l00243"></a>00243             <span class="keywordflow">try</span> {
<a name="l00244"></a>00244                 $this-&gt;<a class="code" href="class_zend_x___console___process___unix.html#ac615f1c24391a6eb5345c4d17a877bf8">_run</a>();
<a name="l00245"></a>00245             } <span class="keywordflow">catch</span> (Exception $e) {
<a name="l00246"></a>00246                 <span class="comment">// We have to catch any exceptions and clean up the process,</span>
<a name="l00247"></a>00247                 <span class="comment">// else we will have a memory leak.</span>
<a name="l00248"></a>00248             }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250             <span class="comment">// Destroy the child after _run() execution. Required to avoid</span>
<a name="l00251"></a>00251             <span class="comment">// unuseful child processes after execution</span>
<a name="l00252"></a>00252             exit(0);
<a name="l00253"></a>00253         } <span class="keywordflow">else</span> {
<a name="l00254"></a>00254             <span class="comment">// Else this is the parent</span>
<a name="l00255"></a>00255             $this-&gt;_isChild   = <span class="keyword">false</span>;
<a name="l00256"></a>00256             $this-&gt;_isRunning = <span class="keyword">true</span>;
<a name="l00257"></a>00257             $this-&gt;_pid       = $pid;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260     
<a name="l00269"></a><a class="code" href="class_zend_x___console___process___unix.html#a8b6fc76a620d7557d06e9a11a9ffb509">00269</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a8b6fc76a620d7557d06e9a11a9ffb509">stop</a>()
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         $success = <span class="keyword">false</span>;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="keywordflow">if</span> ($this-&gt;_pid &gt; 0) {
<a name="l00274"></a>00274             $status = 0;
<a name="l00275"></a>00275             
<a name="l00276"></a>00276             posix_kill($this-&gt;_pid, 9);
<a name="l00277"></a>00277             pcntl_waitpid($this-&gt;_pid, $status, WNOHANG);
<a name="l00278"></a>00278             $success = pcntl_wifexited($status);
<a name="l00279"></a>00279             $this-&gt;_cleanProcessContext();
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="keywordflow">return</span> $success;
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 
<a name="l00290"></a><a class="code" href="class_zend_x___console___process___unix.html#ad7e54aa55e82e9be1428d9fa8eb559a5">00290</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#ad7e54aa55e82e9be1428d9fa8eb559a5">isRunning</a>()
<a name="l00291"></a>00291     {       
<a name="l00292"></a>00292         <span class="keywordflow">return</span> $this-&gt;_isRunning;
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294 
<a name="l00305"></a><a class="code" href="class_zend_x___console___process___unix.html#a67a83b12fcbef7b7afb6be9f2189ef97">00305</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a67a83b12fcbef7b7afb6be9f2189ef97">setVariable</a>($name, $value)
<a name="l00306"></a>00306     {
<a name="l00307"></a>00307         <span class="keywordflow">if</span> ($name[0] === <span class="charliteral">&#39;_&#39;</span>) {
<a name="l00308"></a>00308             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00309"></a>00309             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Only internal functions may use underline (_) as variable prefix&#39;</span>);
<a name="l00310"></a>00310         }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312         $this-&gt;_writeVariable($name, $value);
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00322"></a><a class="code" href="class_zend_x___console___process___unix.html#ac371a1b087c0bb8e1fb84777ad8aa275">00322</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#ac371a1b087c0bb8e1fb84777ad8aa275">getVariable</a>($name)
<a name="l00323"></a>00323     {
<a name="l00324"></a>00324         $this-&gt;_readFromIpcSegment();
<a name="l00325"></a>00325 
<a name="l00326"></a>00326         <span class="keywordflow">if</span> (isset($this-&gt;_internalIpcData[$name])) {
<a name="l00327"></a>00327             <span class="keywordflow">return</span> $this-&gt;_internalIpcData[$name];
<a name="l00328"></a>00328         } <span class="keywordflow">else</span> {
<a name="l00329"></a>00329             <span class="keywordflow">return</span> null;
<a name="l00330"></a>00330         }
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332 
<a name="l00343"></a><a class="code" href="class_zend_x___console___process___unix.html#a12a92954c09204bfca764fc979bed21a">00343</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a12a92954c09204bfca764fc979bed21a">getLastAlive</a>()
<a name="l00344"></a>00344     {
<a name="l00345"></a>00345         $pingTime = $this-&gt;<a class="code" href="class_zend_x___console___process___unix.html#ac371a1b087c0bb8e1fb84777ad8aa275">getVariable</a>(<span class="stringliteral">&#39;_pingTime&#39;</span>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="keywordflow">return</span> ($pingTime === null ? 0 : (time() - $pingTime));
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00355"></a><a class="code" href="class_zend_x___console___process___unix.html#a77c9ce8189c6f6efc037d75e4faf73ba">00355</a>     <span class="keyword">public</span> function <a class="code" href="class_zend_x___console___process___unix.html#a77c9ce8189c6f6efc037d75e4faf73ba">getPid</a>()
<a name="l00356"></a>00356     {
<a name="l00357"></a>00357         <span class="keywordflow">return</span> $this-&gt;_pid;
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359     
<a name="l00370"></a><a class="code" href="class_zend_x___console___process___unix.html#a28017ee592102a0170d19d129274e533">00370</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend_x___console___process___unix.html#a28017ee592102a0170d19d129274e533">_setAlive</a>()
<a name="l00371"></a>00371     {
<a name="l00372"></a>00372         $this-&gt;_writeVariable(<span class="stringliteral">&#39;_pingTime&#39;</span>, time());
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374     
<a name="l00375"></a>00375 
<a name="l00385"></a><a class="code" href="class_zend_x___console___process___unix.html#ac83f8999c596ee66ef1499660a72db12">00385</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend_x___console___process___unix.html#ac83f8999c596ee66ef1499660a72db12">_callCallbackMethod</a>($methodName, array $argList = array(), $type = self::VOID_METHOD)
<a name="l00386"></a>00386     {
<a name="l00387"></a>00387         <span class="comment">// This is the parent, so we really cannot execute the method. Check</span>
<a name="l00388"></a>00388         <span class="comment">// arguments passed to the method.</span>
<a name="l00389"></a>00389         <span class="keywordflow">if</span> ($type === self::RETURN_METHOD) {
<a name="l00390"></a>00390             $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callType&#39;</span>] = <a class="code" href="class_zend_x___console___process___unix.html#ab1262e9545d58ddcde485e0146ba0748">self::RETURN_METHOD</a>;
<a name="l00391"></a>00391         } <span class="keywordflow">else</span> {
<a name="l00392"></a>00392             $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callType&#39;</span>] = <a class="code" href="class_zend_x___console___process___unix.html#af7b433fbf6e0373114ce0ff390d363bf">self::VOID_METHOD</a>;
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         <span class="comment">// These setting are common to both the calling types</span>
<a name="l00396"></a>00396         $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callMethod&#39;</span>] = $methodName;
<a name="l00397"></a>00397         $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callInput&#39;</span>]  = $argList;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399         <span class="comment">// Write the IPC data to the shared segment</span>
<a name="l00400"></a>00400         $this-&gt;_writeToIpcSegment();
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">// Now we need to differentiate a bit.</span>
<a name="l00403"></a>00403         <span class="keywordflow">switch</span> ($this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callType&#39;</span>]) {
<a name="l00404"></a>00404             <span class="keywordflow">case</span> <a class="code" href="class_zend_x___console___process___unix.html#af7b433fbf6e0373114ce0ff390d363bf">VOID_METHOD</a>:
<a name="l00405"></a>00405                 <span class="comment">// Notify the child so it can process the request</span>
<a name="l00406"></a>00406                 $this-&gt;_sendSigUsr1();
<a name="l00407"></a>00407                 <span class="keywordflow">break</span>;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409             <span class="keywordflow">case</span> <a class="code" href="class_zend_x___console___process___unix.html#ab1262e9545d58ddcde485e0146ba0748">RETURN_METHOD</a>:
<a name="l00410"></a>00410                 <span class="comment">// Set the semaphorew</span>
<a name="l00411"></a>00411                 shmop_write($this-&gt;_internalSemKey, 1, 0);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413                 <span class="comment">// Notify the child so it can process the request</span>
<a name="l00414"></a>00414                 $this-&gt;_sendSigUsr1();
<a name="l00415"></a>00415 
<a name="l00416"></a>00416                 <span class="comment">// Block until the child process return</span>
<a name="l00417"></a>00417                 $this-&gt;_waitForIpcSemaphore();
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                 <span class="comment">// Read from the SHM segment. The result is stored into</span>
<a name="l00420"></a>00420                 <span class="comment">// $this-&gt;_internalIpcData[&#39;_callOutput&#39;]</span>
<a name="l00421"></a>00421                 $this-&gt;_readFromIpcSegment();
<a name="l00422"></a>00422 
<a name="l00423"></a>00423                 <span class="comment">// Data are returned. Now we can reset the semaphore</span>
<a name="l00424"></a>00424                 shmop_write($this-&gt;_internalSemKey, 0, 1);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                 <span class="comment">// Return the result. Hence no break required here</span>
<a name="l00427"></a>00427                 <span class="keywordflow">return</span> $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callOutput&#39;</span>];
<a name="l00428"></a>00428         }
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430     
<a name="l00436"></a>00436     <span class="keyword">abstract</span> <span class="keyword">protected</span> function <a class="code" href="class_zend_x___console___process___unix.html#ac615f1c24391a6eb5345c4d17a877bf8">_run</a>();
<a name="l00437"></a>00437     
<a name="l00443"></a>00443     <span class="keyword">private</span> function _sendSigUsr1()
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445         <span class="keywordflow">if</span> ($this-&gt;_pid &gt; 0) {
<a name="l00446"></a>00446             posix_kill($this-&gt;_pid, SIGUSR1);
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449     
<a name="l00457"></a>00457     <span class="keyword">private</span> function _writeVariable($name, $value)
<a name="l00458"></a>00458     {
<a name="l00459"></a>00459         $this-&gt;_internalIpcData[$name] = $value;
<a name="l00460"></a>00460         $this-&gt;_writeToIpcSegment();
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 
<a name="l00468"></a>00468     <span class="keyword">private</span> function _cleanProcessContext()
<a name="l00469"></a>00469     {
<a name="l00470"></a>00470         shmop_delete($this-&gt;_internalIpcKey);
<a name="l00471"></a>00471         shmop_delete($this-&gt;_internalSemKey);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473         shmop_close($this-&gt;_internalIpcKey);
<a name="l00474"></a>00474         shmop_close($this-&gt;_internalSemKey);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         @unlink($this-&gt;_ipcSegFile);
<a name="l00477"></a>00477         @unlink($this-&gt;_ipcSemFile);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479         $this-&gt;_isRunning = <span class="keyword">false</span>;
<a name="l00480"></a>00480         $this-&gt;_pid       = null;
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482 
<a name="l00490"></a>00490     <span class="keyword">private</span> function _sigHandler($signo)
<a name="l00491"></a>00491     {
<a name="l00492"></a>00492         <span class="keywordflow">switch</span> ($signo) {
<a name="l00493"></a>00493             <span class="keywordflow">case</span> SIGTERM:
<a name="l00494"></a>00494                 <span class="comment">// Handle shutdown tasks. Hence no break is require</span>
<a name="l00495"></a>00495                 exit;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497             <span class="keywordflow">case</span> SIGUSR1:
<a name="l00498"></a>00498                 <span class="comment">// This is the User-defined signal we&#39;ll use. Read the SHM segment</span>
<a name="l00499"></a>00499                 $this-&gt;_readFromIpcSegment();
<a name="l00500"></a>00500 
<a name="l00501"></a>00501                 <span class="keywordflow">if</span> (isset($this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callType&#39;</span>])) {
<a name="l00502"></a>00502                     $method = $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callMethod&#39;</span>];
<a name="l00503"></a>00503                     $params = $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callInput&#39;</span>];
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                     <span class="keywordflow">switch</span> ($this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callType&#39;</span>]) {
<a name="l00506"></a>00506                         <span class="keywordflow">case</span> self::VOID_METHOD:
<a name="l00507"></a>00507                             <span class="comment">// Simple call the (void) method and return immediatly</span>
<a name="l00508"></a>00508                             <span class="comment">// no semaphore is placed into parent, so the processing</span>
<a name="l00509"></a>00509                             <span class="comment">// is async</span>
<a name="l00510"></a>00510                             call_user_func(array($this, $method), $params);
<a name="l00511"></a>00511                             <span class="keywordflow">break</span>;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513                         <span class="keywordflow">case</span> self::RETURN_METHOD:
<a name="l00514"></a>00514                             <span class="comment">// Process the request</span>
<a name="l00515"></a>00515                             $this-&gt;_internalIpcData[<span class="stringliteral">&#39;_callOutput&#39;</span>] = call_user_func(array($this, $method), $params);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517                             <span class="comment">// Write the result into IPC segment</span>
<a name="l00518"></a>00518                             $this-&gt;_writeToIPCsegment();
<a name="l00519"></a>00519 
<a name="l00520"></a>00520                             <span class="comment">// Unlock the semaphore but block _writeToIpcSegment()</span>
<a name="l00521"></a>00521                             shmop_write($this-&gt;_internalSemKey, 0, 0);
<a name="l00522"></a>00522                             shmop_write($this-&gt;_internalSemKey, 1, 1);
<a name="l00523"></a>00523                             <span class="keywordflow">break</span>;
<a name="l00524"></a>00524                     }
<a name="l00525"></a>00525                 }
<a name="l00526"></a>00526                 <span class="keywordflow">break</span>;
<a name="l00527"></a>00527                 
<a name="l00528"></a>00528             <span class="keywordflow">default</span>:
<a name="l00529"></a>00529                 <span class="comment">// Ignore all other singals</span>
<a name="l00530"></a>00530                 <span class="keywordflow">break</span>;
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533 
<a name="l00539"></a>00539     <span class="keyword">private</span> function _waitForIpcSemaphore()
<a name="l00540"></a>00540     {
<a name="l00541"></a>00541         <span class="keywordflow">while</span> (<span class="keyword">true</span>) {
<a name="l00542"></a>00542             $okay = shmop_read($this-&gt;_internalSemKey, 0, 1);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544             <span class="keywordflow">if</span> ($okay === 0) {
<a name="l00545"></a>00545                 <span class="keywordflow">break</span>;
<a name="l00546"></a>00546             }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548             usleep(10);
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00558"></a>00558     <span class="keyword">private</span> function _readFromIpcSegment()
<a name="l00559"></a>00559     {
<a name="l00560"></a>00560         $serializedIpcData = shmop_read($this-&gt;_internalIpcKey,
<a name="l00561"></a>00561                                         0,
<a name="l00562"></a>00562                                         shmop_size($this-&gt;_internalIpcKey));
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         <span class="keywordflow">if</span> ($serializedIpcData === <span class="keyword">false</span>) {
<a name="l00565"></a>00565             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00566"></a>00566             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Fatal error while reading SHM segment&#39;</span>);
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         $data = @unserialize($serializedIpcData);
<a name="l00570"></a>00570         
<a name="l00571"></a>00571         <span class="keywordflow">if</span> ($data !== <span class="keyword">false</span>) {
<a name="l00572"></a>00572             $this-&gt;_internalIpcData = $data;
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575 
<a name="l00582"></a>00582     <span class="keyword">private</span> function _writeToIpcSegment()
<a name="l00583"></a>00583     {
<a name="l00584"></a>00584         <span class="comment">// Read the transaction bit (2 bit of _internalSemKey segment). If it&#39;s</span>
<a name="l00585"></a>00585         <span class="comment">// value is 1, we&#39;re into the execution of a PHP_FORK_RETURN_METHOD, so</span>
<a name="l00586"></a>00586         <span class="comment">// we must not write to segment (data corruption)</span>
<a name="l00587"></a>00587         <span class="keywordflow">if</span> (shmop_read($this-&gt;_internalSemKey, 1, 1) === 1) {
<a name="l00588"></a>00588             <span class="keywordflow">return</span>;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591         $serializedIpcData = serialize($this-&gt;_internalIpcData);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         <span class="comment">// Set the exchange array (IPC) into the shared segment</span>
<a name="l00594"></a>00594         $shmBytesWritten = shmop_write($this-&gt;_internalIpcKey,
<a name="l00595"></a>00595                                        $serializedIpcData,
<a name="l00596"></a>00596                                        0);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <span class="comment">// Check if lenght of SHM segment is enougth to contain data</span>
<a name="l00599"></a>00599         <span class="keywordflow">if</span> ($shmBytesWritten !== strlen($serializedIpcData)) {
<a name="l00600"></a>00600             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00601"></a>00601             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Fatal error while writing to SHM segment&#39;</span>);
<a name="l00602"></a>00602         }
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00611"></a>00611     <span class="keyword">private</span> function _createIpcSegment()
<a name="l00612"></a>00612     {
<a name="l00613"></a>00613         $this-&gt;_ipcSegFile = realpath(sys_get_temp_dir()) . <span class="charliteral">&#39;/&#39;</span> . rand() . $this-&gt;_name . <span class="stringliteral">&#39;.shm&#39;</span>;
<a name="l00614"></a>00614         touch($this-&gt;_ipcSegFile);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         $shmKey = ftok($this-&gt;_ipcSegFile, <span class="charliteral">&#39;t&#39;</span>);
<a name="l00617"></a>00617         <span class="keywordflow">if</span> ($shmKey === -1) {
<a name="l00618"></a>00618             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00619"></a>00619             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Could not create SHM segment&#39;</span>);
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622         $this-&gt;_internalIpcKey = @shmop_open($shmKey, <span class="charliteral">&#39;c&#39;</span>, 0644, 10240);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         <span class="keywordflow">if</span> (!$this-&gt;_internalIpcKey) {
<a name="l00625"></a>00625             @unlink($this-&gt;_ipcSegFile);
<a name="l00626"></a>00626             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00638"></a>00638     <span class="keyword">private</span> function _createIpcSemaphore()
<a name="l00639"></a>00639     {
<a name="l00640"></a>00640         $this-&gt;_ipcSemFile = realpath(sys_get_temp_dir()) . <span class="charliteral">&#39;/&#39;</span> . rand() . $this-&gt;_name . <span class="stringliteral">&#39;.sem&#39;</span>;
<a name="l00641"></a>00641         touch($this-&gt;_ipcSemFile);
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         $semKey = ftok($this-&gt;_ipcSemFile, <span class="charliteral">&#39;t&#39;</span>);
<a name="l00644"></a>00644         <span class="keywordflow">if</span> ($semKey === -1) {
<a name="l00645"></a>00645             require_once <span class="stringliteral">&#39;ZendX/Console/Process/Exception.php&#39;</span>;
<a name="l00646"></a>00646             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend_x___console___process___exception.html">ZendX_Console_Process_Exception</a>(<span class="stringliteral">&#39;Could not create semaphore&#39;</span>);
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         $this-&gt;_internalSemKey = @shmop_open($semKey, <span class="charliteral">&#39;c&#39;</span>, 0644, 10);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651         <span class="keywordflow">if</span> (!$this-&gt;_internalSemKey) {
<a name="l00652"></a>00652             @unlink($this-&gt;_ipcSemFile);
<a name="l00653"></a>00653             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00654"></a>00654         }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:18 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
