<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/Sqlite.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/Sqlite.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00027"></a>00027 require_once <span class="stringliteral">&#39;Zend/Cache/Backend/ExtendedInterface.php&#39;</span>;
<a name="l00028"></a>00028 
<a name="l00032"></a>00032 require_once <span class="stringliteral">&#39;Zend/Cache/Backend.php&#39;</span>;
<a name="l00033"></a>00033 
<a name="l00040"></a><a class="code" href="class_zend___cache___backend___sqlite.html">00040</a> <span class="keyword">class </span><a class="code" href="class_zend___cache___backend___sqlite.html">Zend_Cache_Backend_Sqlite</a> <span class="keyword">extends</span> <a class="code" href="class_zend___cache___backend.html">Zend_Cache_Backend</a> implements <a class="code" href="interface_zend___cache___backend___extended_interface.html">Zend_Cache_Backend_ExtendedInterface</a>
<a name="l00041"></a>00041 {
<a name="l00058"></a>00058     <span class="keyword">protected</span> $_options = array(
<a name="l00059"></a>00059         <span class="stringliteral">&#39;cache_db_complete_path&#39;</span> =&gt; null,
<a name="l00060"></a>00060         <span class="stringliteral">&#39;automatic_vacuum_factor&#39;</span> =&gt; 10
<a name="l00061"></a>00061     );
<a name="l00062"></a>00062 
<a name="l00068"></a>00068     <span class="keyword">private</span> $_db = null;
<a name="l00069"></a>00069 
<a name="l00075"></a>00075     <span class="keyword">private</span> $_structureChecked = <span class="keyword">false</span>;
<a name="l00076"></a>00076 
<a name="l00084"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a2d2b2afcd896367c740d1eb4b486614b">00084</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a2d2b2afcd896367c740d1eb4b486614b">__construct</a>(array $options = array())
<a name="l00085"></a>00085     {
<a name="l00086"></a>00086         <a class="code" href="class_zend___cache___backend___sqlite.html#a2d2b2afcd896367c740d1eb4b486614b">parent::__construct</a>($options);
<a name="l00087"></a>00087         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;cache_db_complete_path&#39;</span>] === null) {
<a name="l00088"></a>00088             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;cache_db_complete_path option has to set&#39;</span>);
<a name="l00089"></a>00089         }
<a name="l00090"></a>00090         <span class="keywordflow">if</span> (!extension_loaded(<span class="stringliteral">&#39;sqlite&#39;</span>)) {
<a name="l00091"></a>00091             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&quot;Cannot use SQLite storage because the &#39;sqlite&#39; extension is not loaded in the current PHP environment&quot;</span>);
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093         $this-&gt;_getConnection();
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095 
<a name="l00101"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a421831a265621325e1fdd19aace0c758">00101</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a421831a265621325e1fdd19aace0c758">__destruct</a>()
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103         @sqlite_close($this-&gt;_getConnection());
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105 
<a name="l00113"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a0c06efe7760d74865b6708552f15c258">00113</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a0c06efe7760d74865b6708552f15c258">load</a>($id, $doNotTestCacheValidity = <span class="keyword">false</span>)
<a name="l00114"></a>00114     {
<a name="l00115"></a>00115         $this-&gt;_checkAndBuildStructure();
<a name="l00116"></a>00116         $sql = <span class="stringliteral">&quot;SELECT content FROM cache WHERE id=&#39;$id&#39;&quot;</span>;
<a name="l00117"></a>00117         <span class="keywordflow">if</span> (!$doNotTestCacheValidity) {
<a name="l00118"></a>00118             $sql = $sql . <span class="stringliteral">&quot; AND (expire=0 OR expire&gt;&quot;</span> . time() . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00119"></a>00119         }
<a name="l00120"></a>00120         $result = $this-&gt;_query($sql);
<a name="l00121"></a>00121         $row = @sqlite_fetch_array($result);
<a name="l00122"></a>00122         <span class="keywordflow">if</span> ($row) {
<a name="l00123"></a>00123             <span class="keywordflow">return</span> $row[<span class="stringliteral">&#39;content&#39;</span>];
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127 
<a name="l00134"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a59a4562cc98f0681e6b8f1a9332ef503">00134</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a59a4562cc98f0681e6b8f1a9332ef503">test</a>($id)
<a name="l00135"></a>00135     {
<a name="l00136"></a>00136         $this-&gt;_checkAndBuildStructure();
<a name="l00137"></a>00137         $sql = <span class="stringliteral">&quot;SELECT lastModified FROM cache WHERE id=&#39;$id&#39; AND (expire=0 OR expire&gt;&quot;</span> . time() . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00138"></a>00138         $result = $this-&gt;_query($sql);
<a name="l00139"></a>00139         $row = @sqlite_fetch_array($result);
<a name="l00140"></a>00140         <span class="keywordflow">if</span> ($row) {
<a name="l00141"></a>00141             <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>) $row[<span class="stringliteral">&#39;lastModified&#39;</span>]);
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00144"></a>00144     }
<a name="l00145"></a>00145 
<a name="l00159"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a3b7f710e6c22b1b9d610a8acdc554869">00159</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a3b7f710e6c22b1b9d610a8acdc554869">save</a>($data, $id, $tags = array(), $specificLifetime = <span class="keyword">false</span>)
<a name="l00160"></a>00160     {
<a name="l00161"></a>00161         $this-&gt;_checkAndBuildStructure();
<a name="l00162"></a>00162         $lifetime = $this-&gt;<a class="code" href="class_zend___cache___backend.html#aecc263de36b29abfcf4059a576340e1d">getLifetime</a>($specificLifetime);
<a name="l00163"></a>00163         $data = @sqlite_escape_string($data);
<a name="l00164"></a>00164         $mktime = time();
<a name="l00165"></a>00165         <span class="keywordflow">if</span> ($lifetime === null) {
<a name="l00166"></a>00166             $expire = 0;
<a name="l00167"></a>00167         } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168             $expire = $mktime + $lifetime;
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170         $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM cache WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00171"></a>00171         $sql = <span class="stringliteral">&quot;INSERT INTO cache (id, content, lastModified, expire) VALUES (&#39;$id&#39;, &#39;$data&#39;, $mktime, $expire)&quot;</span>;
<a name="l00172"></a>00172         $res = $this-&gt;_query($sql);
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (!$res) {
<a name="l00174"></a>00174             $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&quot;Zend_Cache_Backend_Sqlite::save() : impossible to store the cache id=$id&quot;</span>);
<a name="l00175"></a>00175             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177         $res = <span class="keyword">true</span>;
<a name="l00178"></a>00178         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00179"></a>00179             $res = $this-&gt;_registerTag($id, $tag) &amp;&amp; $res;
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         <span class="keywordflow">return</span> $res;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183 
<a name="l00190"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a11f0aa9afc724ac4074e3ca127e79a2a">00190</a>     <span class="keyword">public</span> function <span class="keyword">remove</span>($id)
<a name="l00191"></a>00191     {
<a name="l00192"></a>00192         $this-&gt;_checkAndBuildStructure();
<a name="l00193"></a>00193         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT COUNT(*) AS nbr FROM cache WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00194"></a>00194         $result1 = @sqlite_fetch_single($res);
<a name="l00195"></a>00195         $result2 = $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM cache WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00196"></a>00196         $result3 = $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM tag WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00197"></a>00197         $this-&gt;_automaticVacuum();
<a name="l00198"></a>00198         <span class="keywordflow">return</span> ($result1 &amp;&amp; $result2 &amp;&amp; $result3);
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00218"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a177c269d89f9f4ec995fde6da6ae12d8">00218</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a177c269d89f9f4ec995fde6da6ae12d8">clean</a>($mode = <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>, $tags = array())
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220         $this-&gt;_checkAndBuildStructure();
<a name="l00221"></a>00221         $return = $this-&gt;_clean($mode, $tags);
<a name="l00222"></a>00222         $this-&gt;_automaticVacuum();
<a name="l00223"></a>00223         <span class="keywordflow">return</span> $return;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 
<a name="l00231"></a><a class="code" href="class_zend___cache___backend___sqlite.html#ad79572b026977913d75446d20467eaaa">00231</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#ad79572b026977913d75446d20467eaaa">getIds</a>()
<a name="l00232"></a>00232     {
<a name="l00233"></a>00233         $this-&gt;_checkAndBuildStructure();
<a name="l00234"></a>00234         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT id FROM cache WHERE (expire=0 OR expire&gt;&quot;</span> . time() . <span class="stringliteral">&quot;)&quot;</span>);
<a name="l00235"></a>00235         $result = array();
<a name="l00236"></a>00236         <span class="keywordflow">while</span> ($id = @sqlite_fetch_single($res)) {
<a name="l00237"></a>00237             $result[] = $id;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239         <span class="keywordflow">return</span> $result;
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00247"></a><a class="code" href="class_zend___cache___backend___sqlite.html#ae07173ab06a20e2f5bd928cc0518e01f">00247</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#ae07173ab06a20e2f5bd928cc0518e01f">getTags</a>()
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249         $this-&gt;_checkAndBuildStructure();
<a name="l00250"></a>00250         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT DISTINCT(name) AS name FROM tag&quot;</span>);
<a name="l00251"></a>00251         $result = array();
<a name="l00252"></a>00252         <span class="keywordflow">while</span> ($id = @sqlite_fetch_single($res)) {
<a name="l00253"></a>00253             $result[] = $id;
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255         <span class="keywordflow">return</span> $result;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 
<a name="l00266"></a><a class="code" href="class_zend___cache___backend___sqlite.html#ab5ba3730429676f2555bf765c56db804">00266</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#ab5ba3730429676f2555bf765c56db804">getIdsMatchingTags</a>($tags = array())
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268         $first = <span class="keyword">true</span>;
<a name="l00269"></a>00269         $ids = array();
<a name="l00270"></a>00270         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00271"></a>00271             $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT DISTINCT(id) AS id FROM tag WHERE name=&#39;$tag&#39;&quot;</span>);
<a name="l00272"></a>00272             <span class="keywordflow">if</span> (!$res) {
<a name="l00273"></a>00273                 <span class="keywordflow">return</span> array();
<a name="l00274"></a>00274             }
<a name="l00275"></a>00275             $rows = @sqlite_fetch_all($res, SQLITE_ASSOC);
<a name="l00276"></a>00276             $ids2 = array();
<a name="l00277"></a>00277             <span class="keywordflow">foreach</span> ($rows as $row) {
<a name="l00278"></a>00278                 $ids2[] = $row[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00279"></a>00279             }
<a name="l00280"></a>00280             <span class="keywordflow">if</span> ($first) {
<a name="l00281"></a>00281                 $ids = $ids2;
<a name="l00282"></a>00282                 $first = <span class="keyword">false</span>;
<a name="l00283"></a>00283             } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284                 $ids = array_intersect($ids, $ids2);
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287         $result = array();
<a name="l00288"></a>00288         <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00289"></a>00289             $result[] = $id;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291         <span class="keywordflow">return</span> $result;
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293 
<a name="l00302"></a><a class="code" href="class_zend___cache___backend___sqlite.html#af90b2d1c5962ba55891e92b1895df055">00302</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#af90b2d1c5962ba55891e92b1895df055">getIdsNotMatchingTags</a>($tags = array())
<a name="l00303"></a>00303     {
<a name="l00304"></a>00304         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT id FROM cache&quot;</span>);
<a name="l00305"></a>00305         $rows = @sqlite_fetch_all($res, SQLITE_ASSOC);
<a name="l00306"></a>00306         $result = array();
<a name="l00307"></a>00307         <span class="keywordflow">foreach</span> ($rows as $row) {
<a name="l00308"></a>00308             $id = $row[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00309"></a>00309             $matching = <span class="keyword">false</span>;
<a name="l00310"></a>00310             <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00311"></a>00311                 $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT COUNT(*) AS nbr FROM tag WHERE name=&#39;$tag&#39; AND id=&#39;$id&#39;&quot;</span>);
<a name="l00312"></a>00312                 <span class="keywordflow">if</span> (!$res) {
<a name="l00313"></a>00313                     <span class="keywordflow">return</span> array();
<a name="l00314"></a>00314                 }
<a name="l00315"></a>00315                 $nbr = (int) @sqlite_fetch_single($res);
<a name="l00316"></a>00316                 <span class="keywordflow">if</span> ($nbr &gt; 0) {
<a name="l00317"></a>00317                     $matching = <span class="keyword">true</span>;
<a name="l00318"></a>00318                 }
<a name="l00319"></a>00319             }
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (!$matching) {
<a name="l00321"></a>00321                 $result[] = $id;
<a name="l00322"></a>00322             }
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324         <span class="keywordflow">return</span> $result;
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326 
<a name="l00335"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a5daca406882c003b1181a0ae7ab9f652">00335</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a5daca406882c003b1181a0ae7ab9f652">getIdsMatchingAnyTags</a>($tags = array())
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337         $first = <span class="keyword">true</span>;
<a name="l00338"></a>00338         $ids = array();
<a name="l00339"></a>00339         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00340"></a>00340             $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT DISTINCT(id) AS id FROM tag WHERE name=&#39;$tag&#39;&quot;</span>);
<a name="l00341"></a>00341             <span class="keywordflow">if</span> (!$res) {
<a name="l00342"></a>00342                 <span class="keywordflow">return</span> array();
<a name="l00343"></a>00343             }
<a name="l00344"></a>00344             $rows = @sqlite_fetch_all($res, SQLITE_ASSOC);
<a name="l00345"></a>00345             $ids2 = array();
<a name="l00346"></a>00346             <span class="keywordflow">foreach</span> ($rows as $row) {
<a name="l00347"></a>00347                 $ids2[] = $row[<span class="stringliteral">&#39;id&#39;</span>];
<a name="l00348"></a>00348             }
<a name="l00349"></a>00349             <span class="keywordflow">if</span> ($first) {
<a name="l00350"></a>00350                 $ids = $ids2;
<a name="l00351"></a>00351                 $first = <span class="keyword">false</span>;
<a name="l00352"></a>00352             } <span class="keywordflow">else</span> {
<a name="l00353"></a>00353                 $ids = array_merge($ids, $ids2);
<a name="l00354"></a>00354             }
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         $result = array();
<a name="l00357"></a>00357         <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00358"></a>00358             $result[] = $id;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360         <span class="keywordflow">return</span> $result;
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00369"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a274375a3bd0220c282ba260146a0a339">00369</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a274375a3bd0220c282ba260146a0a339">getFillingPercentage</a>()
<a name="l00370"></a>00370     {
<a name="l00371"></a>00371         $dir = dirname($this-&gt;_options[<span class="stringliteral">&#39;cache_db_complete_path&#39;</span>]);
<a name="l00372"></a>00372         $free = disk_free_space($dir);
<a name="l00373"></a>00373         $total = disk_total_space($dir);
<a name="l00374"></a>00374         <span class="keywordflow">if</span> ($total == 0) {
<a name="l00375"></a>00375             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;can\&#39;t get disk_total_space&#39;</span>);
<a name="l00376"></a>00376         } <span class="keywordflow">else</span> {
<a name="l00377"></a>00377             <span class="keywordflow">if</span> ($free &gt;= $total) {
<a name="l00378"></a>00378                 <span class="keywordflow">return</span> 100;
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380             <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>) (100. * ($total - $free) / $total));
<a name="l00381"></a>00381         }
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00395"></a><a class="code" href="class_zend___cache___backend___sqlite.html#ad9b728cfeebfcb620c24b2228b3e1218">00395</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#ad9b728cfeebfcb620c24b2228b3e1218">getMetadatas</a>($id)
<a name="l00396"></a>00396     {
<a name="l00397"></a>00397         $tags = array();
<a name="l00398"></a>00398         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT name FROM tag WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00399"></a>00399         <span class="keywordflow">if</span> ($res) {
<a name="l00400"></a>00400             $rows = @sqlite_fetch_all($res, SQLITE_ASSOC);
<a name="l00401"></a>00401             <span class="keywordflow">foreach</span> ($rows as $row) {
<a name="l00402"></a>00402                 $tags[] = $row[<span class="stringliteral">&#39;name&#39;</span>];
<a name="l00403"></a>00403             }
<a name="l00404"></a>00404         }
<a name="l00405"></a>00405         $this-&gt;_query(<span class="stringliteral">&#39;CREATE TABLE cache (id TEXT PRIMARY KEY, content BLOB, lastModified INTEGER, expire INTEGER)&#39;</span>);
<a name="l00406"></a>00406         $res = $this-&gt;_query(<span class="stringliteral">&quot;SELECT lastModified,expire FROM cache WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (!$res) {
<a name="l00408"></a>00408             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         $row = @sqlite_fetch_array($res, SQLITE_ASSOC);
<a name="l00411"></a>00411         <span class="keywordflow">return</span> array(
<a name="l00412"></a>00412             <span class="stringliteral">&#39;tags&#39;</span> =&gt; $tags,
<a name="l00413"></a>00413             <span class="stringliteral">&#39;mtime&#39;</span> =&gt; $row[<span class="stringliteral">&#39;lastModified&#39;</span>],
<a name="l00414"></a>00414             <span class="stringliteral">&#39;expire&#39;</span> =&gt; $row[<span class="stringliteral">&#39;expire&#39;</span>]
<a name="l00415"></a>00415         );
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00425"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a8660c88175edca5e9e9f7a725781e698">00425</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a8660c88175edca5e9e9f7a725781e698">touch</a>($id, $extraLifetime)
<a name="l00426"></a>00426     {
<a name="l00427"></a>00427         $sql = <span class="stringliteral">&quot;SELECT expire FROM cache WHERE id=&#39;$id&#39; AND (expire=0 OR expire&gt;&quot;</span> . time() . <span class="charliteral">&#39;)&#39;</span>;
<a name="l00428"></a>00428         $res = $this-&gt;_query($sql);
<a name="l00429"></a>00429         <span class="keywordflow">if</span> (!$res) {
<a name="l00430"></a>00430             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00431"></a>00431         }
<a name="l00432"></a>00432         $expire = @sqlite_fetch_single($res);
<a name="l00433"></a>00433         $newExpire = $expire + $extraLifetime;
<a name="l00434"></a>00434         $res = $this-&gt;_query(<span class="stringliteral">&quot;UPDATE cache SET lastModified=&quot;</span> . time() . <span class="stringliteral">&quot;, expire=$newExpire WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00435"></a>00435         <span class="keywordflow">if</span> ($res) {
<a name="l00436"></a>00436             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00437"></a>00437         } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00456"></a><a class="code" href="class_zend___cache___backend___sqlite.html#aef6a344a8de433b50039668ea77ed506">00456</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#aef6a344a8de433b50039668ea77ed506">getCapabilities</a>()
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458         <span class="keywordflow">return</span> array(
<a name="l00459"></a>00459             <span class="stringliteral">&#39;automatic_cleaning&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00460"></a>00460             <span class="stringliteral">&#39;tags&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00461"></a>00461             <span class="stringliteral">&#39;expired_read&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00462"></a>00462             <span class="stringliteral">&#39;priority&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00463"></a>00463             <span class="stringliteral">&#39;infinite_lifetime&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00464"></a>00464             <span class="stringliteral">&#39;get_list&#39;</span> =&gt; <span class="keyword">true</span>
<a name="l00465"></a>00465         );
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467 
<a name="l00475"></a><a class="code" href="class_zend___cache___backend___sqlite.html#a1029d47e61a3510047583e01fa39b077">00475</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___sqlite.html#a1029d47e61a3510047583e01fa39b077">___expire</a>($id)
<a name="l00476"></a>00476     {
<a name="l00477"></a>00477         $time = time() - 1;
<a name="l00478"></a>00478         $this-&gt;_query(<span class="stringliteral">&quot;UPDATE cache SET lastModified=$time, expire=$time WHERE id=&#39;$id&#39;&quot;</span>);
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00489"></a>00489     <span class="keyword">private</span> function _getConnection()
<a name="l00490"></a>00490     {
<a name="l00491"></a>00491         <span class="keywordflow">if</span> (is_resource($this-&gt;_db)) {
<a name="l00492"></a>00492             <span class="keywordflow">return</span> $this-&gt;_db;
<a name="l00493"></a>00493         } <span class="keywordflow">else</span> {
<a name="l00494"></a>00494             $this-&gt;_db = @sqlite_open($this-&gt;_options[<span class="stringliteral">&#39;cache_db_complete_path&#39;</span>]);
<a name="l00495"></a>00495             <span class="keywordflow">if</span> (!(is_resource($this-&gt;_db))) {
<a name="l00496"></a>00496                 <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&quot;Impossible to open &quot;</span> . $this-&gt;_options[<span class="stringliteral">&#39;cache_db_complete_path&#39;</span>] . <span class="stringliteral">&quot; cache DB file&quot;</span>);
<a name="l00497"></a>00497             }
<a name="l00498"></a>00498             <span class="keywordflow">return</span> $this-&gt;_db;
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 
<a name="l00508"></a>00508     <span class="keyword">private</span> function _query($query)
<a name="l00509"></a>00509     {
<a name="l00510"></a>00510         $db = $this-&gt;_getConnection();
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (is_resource($db)) {
<a name="l00512"></a>00512             $res = @sqlite_query($db, $query);
<a name="l00513"></a>00513             <span class="keywordflow">if</span> ($res === <span class="keyword">false</span>) {
<a name="l00514"></a>00514                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00515"></a>00515             } <span class="keywordflow">else</span> {
<a name="l00516"></a>00516                 <span class="keywordflow">return</span> $res;
<a name="l00517"></a>00517             }
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521 
<a name="l00527"></a>00527     <span class="keyword">private</span> function _automaticVacuum()
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;automatic_vacuum_factor&#39;</span>] &gt; 0) {
<a name="l00530"></a>00530             $rand = rand(1, $this-&gt;_options[<span class="stringliteral">&#39;automatic_vacuum_factor&#39;</span>]);
<a name="l00531"></a>00531             <span class="keywordflow">if</span> ($rand == 1) {
<a name="l00532"></a>00532                 $this-&gt;_query(<span class="stringliteral">&#39;VACUUM&#39;</span>);
<a name="l00533"></a>00533                 @sqlite_close($this-&gt;_getConnection());
<a name="l00534"></a>00534             }
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537 
<a name="l00545"></a>00545     <span class="keyword">private</span> function _registerTag($id, $tag) {
<a name="l00546"></a>00546         $res = $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM TAG WHERE name=&#39;$tag&#39; AND id=&#39;$id&#39;&quot;</span>);
<a name="l00547"></a>00547         $res = $this-&gt;_query(<span class="stringliteral">&quot;INSERT INTO tag (name, id) VALUES (&#39;$tag&#39;, &#39;$id&#39;)&quot;</span>);
<a name="l00548"></a>00548         <span class="keywordflow">if</span> (!$res) {
<a name="l00549"></a>00549             $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&quot;Zend_Cache_Backend_Sqlite::_registerTag() : impossible to register tag=$tag on id=$id&quot;</span>);
<a name="l00550"></a>00550             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554 
<a name="l00560"></a>00560     <span class="keyword">private</span> function _buildStructure()
<a name="l00561"></a>00561     {
<a name="l00562"></a>00562         $this-&gt;_query(<span class="stringliteral">&#39;DROP INDEX tag_id_index&#39;</span>);
<a name="l00563"></a>00563         $this-&gt;_query(<span class="stringliteral">&#39;DROP INDEX tag_name_index&#39;</span>);
<a name="l00564"></a>00564         $this-&gt;_query(<span class="stringliteral">&#39;DROP INDEX cache_id_expire_index&#39;</span>);
<a name="l00565"></a>00565         $this-&gt;_query(<span class="stringliteral">&#39;DROP TABLE version&#39;</span>);
<a name="l00566"></a>00566         $this-&gt;_query(<span class="stringliteral">&#39;DROP TABLE cache&#39;</span>);
<a name="l00567"></a>00567         $this-&gt;_query(<span class="stringliteral">&#39;DROP TABLE tag&#39;</span>);
<a name="l00568"></a>00568         $this-&gt;_query(<span class="stringliteral">&#39;CREATE TABLE version (num INTEGER PRIMARY KEY)&#39;</span>);
<a name="l00569"></a>00569         $this-&gt;_query(<span class="stringliteral">&#39;CREATE TABLE cache (id TEXT PRIMARY KEY, content BLOB, lastModified INTEGER, expire INTEGER)&#39;</span>);
<a name="l00570"></a>00570         $this-&gt;_query(<span class="stringliteral">&#39;CREATE TABLE tag (name TEXT, id TEXT)&#39;</span>);
<a name="l00571"></a>00571         $this-&gt;_query(<span class="stringliteral">&#39;CREATE INDEX tag_id_index ON tag(id)&#39;</span>);
<a name="l00572"></a>00572         $this-&gt;_query(<span class="stringliteral">&#39;CREATE INDEX tag_name_index ON tag(name)&#39;</span>);
<a name="l00573"></a>00573         $this-&gt;_query(<span class="stringliteral">&#39;CREATE INDEX cache_id_expire_index ON cache(id, expire)&#39;</span>);
<a name="l00574"></a>00574         $this-&gt;_query(<span class="stringliteral">&#39;INSERT INTO version (num) VALUES (1)&#39;</span>);
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576 
<a name="l00582"></a>00582     <span class="keyword">private</span> function _checkStructureVersion()
<a name="l00583"></a>00583     {
<a name="l00584"></a>00584         $result = $this-&gt;_query(<span class="stringliteral">&quot;SELECT num FROM version&quot;</span>);
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (!$result) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00586"></a>00586         $row = @sqlite_fetch_array($result);
<a name="l00587"></a>00587         <span class="keywordflow">if</span> (!$row) {
<a name="l00588"></a>00588             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590         <span class="keywordflow">if</span> (((<span class="keywordtype">int</span>) $row[<span class="stringliteral">&#39;num&#39;</span>]) != 1) {
<a name="l00591"></a>00591             <span class="comment">// old cache structure</span>
<a name="l00592"></a>00592             $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&#39;Zend_Cache_Backend_Sqlite::_checkStructureVersion() : old cache structure version detected =&gt; the cache is going to be dropped&#39;</span>);
<a name="l00593"></a>00593             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00594"></a>00594         }
<a name="l00595"></a>00595         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597 
<a name="l00615"></a>00615     <span class="keyword">private</span> function _clean($mode = <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>, $tags = array())
<a name="l00616"></a>00616     {
<a name="l00617"></a>00617         <span class="keywordflow">switch</span> ($mode) {
<a name="l00618"></a>00618             <span class="keywordflow">case</span> <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>:
<a name="l00619"></a>00619                 $res1 = $this-&gt;_query(<span class="stringliteral">&#39;DELETE FROM cache&#39;</span>);
<a name="l00620"></a>00620                 $res2 = $this-&gt;_query(<span class="stringliteral">&#39;DELETE FROM tag&#39;</span>);
<a name="l00621"></a>00621                 <span class="keywordflow">return</span> $res1 &amp;&amp; $res2;
<a name="l00622"></a>00622                 <span class="keywordflow">break</span>;
<a name="l00623"></a>00623             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_OLD:
<a name="l00624"></a>00624                 $mktime = time();
<a name="l00625"></a>00625                 $res1 = $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM tag WHERE id IN (SELECT id FROM cache WHERE expire&gt;0 AND expire&lt;=$mktime)&quot;</span>);
<a name="l00626"></a>00626                 $res2 = $this-&gt;_query(<span class="stringliteral">&quot;DELETE FROM cache WHERE expire&gt;0 AND expire&lt;=$mktime&quot;</span>);
<a name="l00627"></a>00627                 <span class="keywordflow">return</span> $res1 &amp;&amp; $res2;
<a name="l00628"></a>00628                 <span class="keywordflow">break</span>;
<a name="l00629"></a>00629             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_TAG:
<a name="l00630"></a>00630                 $ids = $this-&gt;<a class="code" href="class_zend___cache___backend___sqlite.html#ab5ba3730429676f2555bf765c56db804">getIdsMatchingTags</a>($tags);
<a name="l00631"></a>00631                 $result = <span class="keyword">true</span>;
<a name="l00632"></a>00632                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00633"></a>00633                     $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00634"></a>00634                 }
<a name="l00635"></a>00635                 <span class="keywordflow">return</span> $result;
<a name="l00636"></a>00636                 <span class="keywordflow">break</span>;
<a name="l00637"></a>00637             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_NOT_MATCHING_TAG:
<a name="l00638"></a>00638                 $ids = $this-&gt;<a class="code" href="class_zend___cache___backend___sqlite.html#af90b2d1c5962ba55891e92b1895df055">getIdsNotMatchingTags</a>($tags);
<a name="l00639"></a>00639                 $result = <span class="keyword">true</span>;
<a name="l00640"></a>00640                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00641"></a>00641                     $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00642"></a>00642                 }
<a name="l00643"></a>00643                 <span class="keywordflow">return</span> $result;
<a name="l00644"></a>00644                 <span class="keywordflow">break</span>;
<a name="l00645"></a>00645             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_ANY_TAG:
<a name="l00646"></a>00646                 $ids = $this-&gt;<a class="code" href="class_zend___cache___backend___sqlite.html#a5daca406882c003b1181a0ae7ab9f652">getIdsMatchingAnyTags</a>($tags);
<a name="l00647"></a>00647                 $result = <span class="keyword">true</span>;
<a name="l00648"></a>00648                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00649"></a>00649                     $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00650"></a>00650                 }
<a name="l00651"></a>00651                 <span class="keywordflow">return</span> $result;
<a name="l00652"></a>00652                 <span class="keywordflow">break</span>;
<a name="l00653"></a>00653             <span class="keywordflow">default</span>:
<a name="l00654"></a>00654                 <span class="keywordflow">break</span>;
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 
<a name="l00665"></a>00665     <span class="keyword">private</span> function _checkAndBuildStructure()
<a name="l00666"></a>00666     {
<a name="l00667"></a>00667         <span class="keywordflow">if</span> (!($this-&gt;_structureChecked)) {
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (!$this-&gt;_checkStructureVersion()) {
<a name="l00669"></a>00669                 $this-&gt;_buildStructure();
<a name="l00670"></a>00670                 <span class="keywordflow">if</span> (!$this-&gt;_checkStructureVersion()) {
<a name="l00671"></a>00671                     <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&quot;Impossible to build cache structure in &quot;</span> . $this-&gt;_options[<span class="stringliteral">&#39;cache_db_complete_path&#39;</span>]);
<a name="l00672"></a>00672                 }
<a name="l00673"></a>00673             }
<a name="l00674"></a>00674             $this-&gt;_structureChecked = <span class="keyword">true</span>;
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:16 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
