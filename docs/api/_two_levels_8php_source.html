<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/TwoLevels.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/TwoLevels.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00027"></a>00027 require_once <span class="stringliteral">&#39;Zend/Cache/Backend/ExtendedInterface.php&#39;</span>;
<a name="l00028"></a>00028 
<a name="l00032"></a>00032 require_once <span class="stringliteral">&#39;Zend/Cache/Backend.php&#39;</span>;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00042"></a><a class="code" href="class_zend___cache___backend___two_levels.html">00042</a> <span class="keyword">class </span><a class="code" href="class_zend___cache___backend___two_levels.html">Zend_Cache_Backend_TwoLevels</a> <span class="keyword">extends</span> <a class="code" href="class_zend___cache___backend.html">Zend_Cache_Backend</a> implements <a class="code" href="interface_zend___cache___backend___extended_interface.html">Zend_Cache_Backend_ExtendedInterface</a>
<a name="l00043"></a>00043 {
<a name="l00080"></a>00080     <span class="keyword">protected</span> $_options = array(
<a name="l00081"></a>00081         <span class="stringliteral">&#39;slow_backend&#39;</span> =&gt; <span class="stringliteral">&#39;File&#39;</span>,
<a name="l00082"></a>00082         <span class="stringliteral">&#39;fast_backend&#39;</span> =&gt; <span class="stringliteral">&#39;Apc&#39;</span>,
<a name="l00083"></a>00083         <span class="stringliteral">&#39;slow_backend_options&#39;</span> =&gt; array(),
<a name="l00084"></a>00084         <span class="stringliteral">&#39;fast_backend_options&#39;</span> =&gt; array(),
<a name="l00085"></a>00085         <span class="stringliteral">&#39;stats_update_factor&#39;</span> =&gt; 10,
<a name="l00086"></a>00086         <span class="stringliteral">&#39;slow_backend_custom_naming&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00087"></a>00087         <span class="stringliteral">&#39;fast_backend_custom_naming&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00088"></a>00088         <span class="stringliteral">&#39;slow_backend_autoload&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00089"></a>00089         <span class="stringliteral">&#39;fast_backend_autoload&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00090"></a>00090         <span class="stringliteral">&#39;auto_refresh_fast_cache&#39;</span> =&gt; <span class="keyword">true</span>
<a name="l00091"></a>00091     );
<a name="l00092"></a>00092 
<a name="l00098"></a>00098     <span class="keyword">protected</span> $_slowBackend;
<a name="l00099"></a>00099 
<a name="l00105"></a>00105     <span class="keyword">protected</span> $_fastBackend;
<a name="l00106"></a>00106 
<a name="l00112"></a>00112     <span class="keyword">protected</span> $_fastBackendFillingPercentage = null;
<a name="l00113"></a>00113 
<a name="l00121"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a2d2b2afcd896367c740d1eb4b486614b">00121</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a2d2b2afcd896367c740d1eb4b486614b">__construct</a>(array $options = array())
<a name="l00122"></a>00122     {
<a name="l00123"></a>00123         <a class="code" href="class_zend___cache___backend___two_levels.html#a2d2b2afcd896367c740d1eb4b486614b">parent::__construct</a>($options);
<a name="l00124"></a>00124         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;slow_backend&#39;</span>] === null) {
<a name="l00125"></a>00125             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;slow_backend option has to set&#39;</span>);
<a name="l00126"></a>00126         }
<a name="l00127"></a>00127         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;fast_backend&#39;</span>] === null) {
<a name="l00128"></a>00128             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;fast_backend option has to set&#39;</span>);
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         $this-&gt;_slowBackend = <a class="code" href="class_zend___cache.html#aa2a4309ad103bbe411ed7f45e432c232">Zend_Cache::_makeBackend</a>($this-&gt;_options[<span class="stringliteral">&#39;slow_backend&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;slow_backend_options&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;slow_backend_custom_naming&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;slow_backend_autoload&#39;</span>]);
<a name="l00131"></a>00131         $this-&gt;_fastBackend = <a class="code" href="class_zend___cache.html#aa2a4309ad103bbe411ed7f45e432c232">Zend_Cache::_makeBackend</a>($this-&gt;_options[<span class="stringliteral">&#39;fast_backend&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;fast_backend_options&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;fast_backend_custom_naming&#39;</span>], $this-&gt;_options[<span class="stringliteral">&#39;fast_backend_autoload&#39;</span>]);
<a name="l00132"></a>00132         <span class="keywordflow">if</span> (!in_array(<span class="stringliteral">&#39;Zend_Cache_Backend_ExtendedInterface&#39;</span>, class_implements($this-&gt;_slowBackend))) {
<a name="l00133"></a>00133             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;slow_backend must implement the Zend_Cache_Backend_ExtendedInterface interface&#39;</span>);
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (!in_array(<span class="stringliteral">&#39;Zend_Cache_Backend_ExtendedInterface&#39;</span>, class_implements($this-&gt;_fastBackend))) {
<a name="l00136"></a>00136             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;fast_backend must implement the Zend_Cache_Backend_ExtendedInterface interface&#39;</span>);
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138         $this-&gt;_slowBackend-&gt;setDirectives($this-&gt;_directives);
<a name="l00139"></a>00139         $this-&gt;_fastBackend-&gt;setDirectives($this-&gt;_directives);
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141 
<a name="l00148"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a59a4562cc98f0681e6b8f1a9332ef503">00148</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a59a4562cc98f0681e6b8f1a9332ef503">test</a>($id)
<a name="l00149"></a>00149     {
<a name="l00150"></a>00150         $fastTest = $this-&gt;_fastBackend-&gt;test($id);
<a name="l00151"></a>00151         <span class="keywordflow">if</span> ($fastTest) {
<a name="l00152"></a>00152             <span class="keywordflow">return</span> $fastTest;
<a name="l00153"></a>00153         } <span class="keywordflow">else</span> {
<a name="l00154"></a>00154             <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;test($id);
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157 
<a name="l00171"></a><a class="code" href="class_zend___cache___backend___two_levels.html#aa44a42045b5474f68998d8d6b75d9a10">00171</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#aa44a42045b5474f68998d8d6b75d9a10">save</a>($data, $id, $tags = array(), $specificLifetime = <span class="keyword">false</span>, $priority = 8)
<a name="l00172"></a>00172     {
<a name="l00173"></a>00173         $usage = $this-&gt;_getFastFillingPercentage(<span class="stringliteral">&#39;saving&#39;</span>);
<a name="l00174"></a>00174         $boolFast = <span class="keyword">true</span>;
<a name="l00175"></a>00175         $lifetime = $this-&gt;<a class="code" href="class_zend___cache___backend.html#aecc263de36b29abfcf4059a576340e1d">getLifetime</a>($specificLifetime);
<a name="l00176"></a>00176         $preparedData = $this-&gt;_prepareData($data, $lifetime, $priority);
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (($priority &gt; 0) &amp;&amp; (10 * $priority &gt;= $usage)) {
<a name="l00178"></a>00178             $fastLifetime = $this-&gt;_getFastLifetime($lifetime, $priority);
<a name="l00179"></a>00179             $boolFast = $this-&gt;_fastBackend-&gt;save($preparedData, $id, array(), $fastLifetime);
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         $boolSlow = $this-&gt;_slowBackend-&gt;save($preparedData, $id, $tags, $lifetime);
<a name="l00182"></a>00182         <span class="keywordflow">return</span> ($boolFast &amp;&amp; $boolSlow);
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 
<a name="l00194"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a0c06efe7760d74865b6708552f15c258">00194</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a0c06efe7760d74865b6708552f15c258">load</a>($id, $doNotTestCacheValidity = <span class="keyword">false</span>)
<a name="l00195"></a>00195     {
<a name="l00196"></a>00196         $res = $this-&gt;_fastBackend-&gt;load($id, $doNotTestCacheValidity);
<a name="l00197"></a>00197         <span class="keywordflow">if</span> ($res === <span class="keyword">false</span>) {
<a name="l00198"></a>00198             $res = $this-&gt;_slowBackend-&gt;load($id, $doNotTestCacheValidity);
<a name="l00199"></a>00199             <span class="keywordflow">if</span> ($res === <span class="keyword">false</span>) {
<a name="l00200"></a>00200                 <span class="comment">// there is no cache at all for this id</span>
<a name="l00201"></a>00201                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00202"></a>00202             }
<a name="l00203"></a>00203         }
<a name="l00204"></a>00204         $array = unserialize($res);
<a name="l00205"></a>00205         <span class="comment">// maybe, we have to refresh the fast cache ?</span>
<a name="l00206"></a>00206         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;auto_refresh_fast_cache&#39;</span>]) {
<a name="l00207"></a>00207             <span class="keywordflow">if</span> ($array[<span class="stringliteral">&#39;priority&#39;</span>] == 10) {
<a name="l00208"></a>00208                 <span class="comment">// no need to refresh the fast cache with priority = 10</span>
<a name="l00209"></a>00209                 <span class="keywordflow">return</span> $array[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l00210"></a>00210             }
<a name="l00211"></a>00211             $newFastLifetime = $this-&gt;_getFastLifetime($array[<span class="stringliteral">&#39;lifetime&#39;</span>], $array[<span class="stringliteral">&#39;priority&#39;</span>], time() - $array[<span class="stringliteral">&#39;expire&#39;</span>]);
<a name="l00212"></a>00212             <span class="comment">// we have the time to refresh the fast cache</span>
<a name="l00213"></a>00213             $usage = $this-&gt;_getFastFillingPercentage(<span class="stringliteral">&#39;loading&#39;</span>);
<a name="l00214"></a>00214             <span class="keywordflow">if</span> (($array[<span class="stringliteral">&#39;priority&#39;</span>] &gt; 0) &amp;&amp; (10 * $array[<span class="stringliteral">&#39;priority&#39;</span>] &gt;= $usage)) {
<a name="l00215"></a>00215                 <span class="comment">// we can refresh the fast cache</span>
<a name="l00216"></a>00216                 $preparedData = $this-&gt;_prepareData($array[<span class="stringliteral">&#39;data&#39;</span>], $array[<span class="stringliteral">&#39;lifetime&#39;</span>], $array[<span class="stringliteral">&#39;priority&#39;</span>]);
<a name="l00217"></a>00217                 $this-&gt;_fastBackend-&gt;save($preparedData, $id, array(), $newFastLifetime);
<a name="l00218"></a>00218             }
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220         <span class="keywordflow">return</span> $array[<span class="stringliteral">&#39;data&#39;</span>];
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222 
<a name="l00229"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a11f0aa9afc724ac4074e3ca127e79a2a">00229</a>     <span class="keyword">public</span> function <span class="keyword">remove</span>($id)
<a name="l00230"></a>00230     {
<a name="l00231"></a>00231         $boolFast = $this-&gt;_fastBackend-&gt;remove($id);
<a name="l00232"></a>00232         $boolSlow = $this-&gt;_slowBackend-&gt;remove($id);
<a name="l00233"></a>00233         <span class="keywordflow">return</span> $boolFast &amp;&amp; $boolSlow;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00254"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a177c269d89f9f4ec995fde6da6ae12d8">00254</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a177c269d89f9f4ec995fde6da6ae12d8">clean</a>($mode = <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>, $tags = array())
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256         <span class="keywordflow">switch</span>($mode) {
<a name="l00257"></a>00257             <span class="keywordflow">case</span> <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>:
<a name="l00258"></a>00258                 $boolFast = $this-&gt;_fastBackend-&gt;clean(<a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>);
<a name="l00259"></a>00259                 $boolSlow = $this-&gt;_slowBackend-&gt;clean(<a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>);
<a name="l00260"></a>00260                 <span class="keywordflow">return</span> $boolFast &amp;&amp; $boolSlow;
<a name="l00261"></a>00261                 <span class="keywordflow">break</span>;
<a name="l00262"></a>00262             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_OLD:
<a name="l00263"></a>00263                 <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;clean(Zend_Cache::CLEANING_MODE_OLD);
<a name="l00264"></a>00264             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_TAG:
<a name="l00265"></a>00265                 $ids = $this-&gt;_slowBackend-&gt;getIdsMatchingTags($tags);
<a name="l00266"></a>00266                 $res = <span class="keyword">true</span>;
<a name="l00267"></a>00267                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00268"></a>00268                     $bool = $this-&gt;<span class="keyword">remove</span>($id);
<a name="l00269"></a>00269                     $res = $res &amp;&amp; $bool;
<a name="l00270"></a>00270                 }
<a name="l00271"></a>00271                 <span class="keywordflow">return</span> $res;
<a name="l00272"></a>00272                 <span class="keywordflow">break</span>;
<a name="l00273"></a>00273             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_NOT_MATCHING_TAG:
<a name="l00274"></a>00274                 $ids = $this-&gt;_slowBackend-&gt;getIdsNotMatchingTags($tags);
<a name="l00275"></a>00275                 $res = <span class="keyword">true</span>;
<a name="l00276"></a>00276                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00277"></a>00277                     $bool = $this-&gt;<span class="keyword">remove</span>($id);
<a name="l00278"></a>00278                     $res = $res &amp;&amp; $bool;
<a name="l00279"></a>00279                 }
<a name="l00280"></a>00280                 <span class="keywordflow">return</span> $res;
<a name="l00281"></a>00281                 <span class="keywordflow">break</span>;
<a name="l00282"></a>00282             <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_ANY_TAG:
<a name="l00283"></a>00283                 $ids = $this-&gt;_slowBackend-&gt;getIdsMatchingAnyTags($tags);
<a name="l00284"></a>00284                 $res = <span class="keyword">true</span>;
<a name="l00285"></a>00285                 <span class="keywordflow">foreach</span> ($ids as $id) {
<a name="l00286"></a>00286                     $bool = $this-&gt;<span class="keyword">remove</span>($id);
<a name="l00287"></a>00287                     $res = $res &amp;&amp; $bool;
<a name="l00288"></a>00288                 }
<a name="l00289"></a>00289                 <span class="keywordflow">return</span> $res;
<a name="l00290"></a>00290                 <span class="keywordflow">break</span>;
<a name="l00291"></a>00291             <span class="keywordflow">default</span>:
<a name="l00292"></a>00292                 <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;Invalid mode for clean() method&#39;</span>);
<a name="l00293"></a>00293                 <span class="keywordflow">break</span>;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296 
<a name="l00302"></a><a class="code" href="class_zend___cache___backend___two_levels.html#ad79572b026977913d75446d20467eaaa">00302</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#ad79572b026977913d75446d20467eaaa">getIds</a>()
<a name="l00303"></a>00303     {
<a name="l00304"></a>00304         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getIds();
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306 
<a name="l00312"></a><a class="code" href="class_zend___cache___backend___two_levels.html#ae07173ab06a20e2f5bd928cc0518e01f">00312</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#ae07173ab06a20e2f5bd928cc0518e01f">getTags</a>()
<a name="l00313"></a>00313     {
<a name="l00314"></a>00314         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getTags();
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316 
<a name="l00325"></a><a class="code" href="class_zend___cache___backend___two_levels.html#ab5ba3730429676f2555bf765c56db804">00325</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#ab5ba3730429676f2555bf765c56db804">getIdsMatchingTags</a>($tags = array())
<a name="l00326"></a>00326     {
<a name="l00327"></a>00327         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getIdsMatchingTags($tags);
<a name="l00328"></a>00328     }
<a name="l00329"></a>00329 
<a name="l00338"></a><a class="code" href="class_zend___cache___backend___two_levels.html#af90b2d1c5962ba55891e92b1895df055">00338</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#af90b2d1c5962ba55891e92b1895df055">getIdsNotMatchingTags</a>($tags = array())
<a name="l00339"></a>00339     {
<a name="l00340"></a>00340         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getIdsNotMatchingTags($tags);
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342 
<a name="l00351"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a5daca406882c003b1181a0ae7ab9f652">00351</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a5daca406882c003b1181a0ae7ab9f652">getIdsMatchingAnyTags</a>($tags = array())
<a name="l00352"></a>00352     {
<a name="l00353"></a>00353         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getIdsMatchingAnyTags($tags);
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00362"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a274375a3bd0220c282ba260146a0a339">00362</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a274375a3bd0220c282ba260146a0a339">getFillingPercentage</a>()
<a name="l00363"></a>00363     {
<a name="l00364"></a>00364         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getFillingPercentage();
<a name="l00365"></a>00365     }
<a name="l00366"></a>00366 
<a name="l00378"></a><a class="code" href="class_zend___cache___backend___two_levels.html#ad9b728cfeebfcb620c24b2228b3e1218">00378</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#ad9b728cfeebfcb620c24b2228b3e1218">getMetadatas</a>($id)
<a name="l00379"></a>00379     {
<a name="l00380"></a>00380         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;getMetadatas($id);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00390"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a8660c88175edca5e9e9f7a725781e698">00390</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a8660c88175edca5e9e9f7a725781e698">touch</a>($id, $extraLifetime)
<a name="l00391"></a>00391     {
<a name="l00392"></a>00392         <span class="keywordflow">return</span> $this-&gt;_slowBackend-&gt;touch($id, $extraLifetime);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 
<a name="l00409"></a><a class="code" href="class_zend___cache___backend___two_levels.html#aef6a344a8de433b50039668ea77ed506">00409</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#aef6a344a8de433b50039668ea77ed506">getCapabilities</a>()
<a name="l00410"></a>00410     {
<a name="l00411"></a>00411         $slowBackendCapabilities = $this-&gt;_slowBackend-&gt;getCapabilities();
<a name="l00412"></a>00412         <span class="keywordflow">return</span> array(
<a name="l00413"></a>00413             <span class="stringliteral">&#39;automatic_cleaning&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;automatic_cleaning&#39;</span>],
<a name="l00414"></a>00414             <span class="stringliteral">&#39;tags&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;tags&#39;</span>],
<a name="l00415"></a>00415             <span class="stringliteral">&#39;expired_read&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;expired_read&#39;</span>],
<a name="l00416"></a>00416             <span class="stringliteral">&#39;priority&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;priority&#39;</span>],
<a name="l00417"></a>00417             <span class="stringliteral">&#39;infinite_lifetime&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;infinite_lifetime&#39;</span>],
<a name="l00418"></a>00418             <span class="stringliteral">&#39;get_list&#39;</span> =&gt; $slowBackendCapabilities[<span class="stringliteral">&#39;get_list&#39;</span>]
<a name="l00419"></a>00419         );
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421 
<a name="l00430"></a>00430     <span class="keyword">private</span> function _prepareData($data, $lifetime, $priority)
<a name="l00431"></a>00431     {
<a name="l00432"></a>00432         $lt = $lifetime;
<a name="l00433"></a>00433         <span class="keywordflow">if</span> ($lt === null) {
<a name="l00434"></a>00434             $lt = 9999999999;
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436         <span class="keywordflow">return</span> serialize(array(
<a name="l00437"></a>00437             <span class="stringliteral">&#39;data&#39;</span> =&gt; $data,
<a name="l00438"></a>00438             <span class="stringliteral">&#39;lifetime&#39;</span> =&gt; $lifetime,
<a name="l00439"></a>00439             <span class="stringliteral">&#39;expire&#39;</span> =&gt; time() + $lt,
<a name="l00440"></a>00440             <span class="stringliteral">&#39;priority&#39;</span> =&gt; $priority
<a name="l00441"></a>00441         ));
<a name="l00442"></a>00442     }
<a name="l00443"></a>00443 
<a name="l00452"></a>00452     <span class="keyword">private</span> function _getFastLifetime($lifetime, $priority, $maxLifetime = null)
<a name="l00453"></a>00453     {
<a name="l00454"></a>00454         <span class="keywordflow">if</span> ($lifetime === null) {
<a name="l00455"></a>00455             <span class="comment">// if lifetime is null, we have an infinite lifetime</span>
<a name="l00456"></a>00456             <span class="comment">// we need to use arbitrary lifetimes</span>
<a name="l00457"></a>00457             $fastLifetime = (int) (2592000 / (11 - $priority));
<a name="l00458"></a>00458         } <span class="keywordflow">else</span> {
<a name="l00459"></a>00459             $fastLifetime = (int) ($lifetime / (11 - $priority));
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (($maxLifetime !== null) &amp;&amp; ($maxLifetime &gt;= 0)) {
<a name="l00462"></a>00462             <span class="keywordflow">if</span> ($fastLifetime &gt; $maxLifetime) {
<a name="l00463"></a>00463                 <span class="keywordflow">return</span> $maxLifetime;
<a name="l00464"></a>00464             }
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466         <span class="keywordflow">return</span> $fastLifetime;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 
<a name="l00476"></a><a class="code" href="class_zend___cache___backend___two_levels.html#a1029d47e61a3510047583e01fa39b077">00476</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___two_levels.html#a1029d47e61a3510047583e01fa39b077">___expire</a>($id)
<a name="l00477"></a>00477     {
<a name="l00478"></a>00478         $this-&gt;_fastBackend-&gt;remove($id);
<a name="l00479"></a>00479         $this-&gt;_slowBackend-&gt;___expire($id);
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482     <span class="keyword">private</span> function _getFastFillingPercentage($mode)
<a name="l00483"></a>00483     {
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         <span class="keywordflow">if</span> ($mode == <span class="stringliteral">&#39;saving&#39;</span>) {
<a name="l00486"></a>00486             <span class="comment">// mode saving</span>
<a name="l00487"></a>00487             <span class="keywordflow">if</span> ($this-&gt;_fastBackendFillingPercentage === null) {
<a name="l00488"></a>00488                 $this-&gt;_fastBackendFillingPercentage = $this-&gt;_fastBackend-&gt;getFillingPercentage();
<a name="l00489"></a>00489             } <span class="keywordflow">else</span> {
<a name="l00490"></a>00490                 $rand = rand(1, $this-&gt;_options[<span class="stringliteral">&#39;stats_update_factor&#39;</span>]);
<a name="l00491"></a>00491                 <span class="keywordflow">if</span> ($rand == 1) {
<a name="l00492"></a>00492                     <span class="comment">// we force a refresh</span>
<a name="l00493"></a>00493                     $this-&gt;_fastBackendFillingPercentage = $this-&gt;_fastBackend-&gt;getFillingPercentage();
<a name="l00494"></a>00494                 }
<a name="l00495"></a>00495             }
<a name="l00496"></a>00496         } <span class="keywordflow">else</span> {
<a name="l00497"></a>00497             <span class="comment">// mode loading</span>
<a name="l00498"></a>00498             <span class="comment">// we compute the percentage only if it&#39;s not available in cache</span>
<a name="l00499"></a>00499             <span class="keywordflow">if</span> ($this-&gt;_fastBackendFillingPercentage === null) {
<a name="l00500"></a>00500                 $this-&gt;_fastBackendFillingPercentage = $this-&gt;_fastBackend-&gt;getFillingPercentage();
<a name="l00501"></a>00501             }
<a name="l00502"></a>00502         }
<a name="l00503"></a>00503         <span class="keywordflow">return</span> $this-&gt;_fastBackendFillingPercentage;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:16 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
