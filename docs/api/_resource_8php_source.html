<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/bin/Resource.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/bin/Resource.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?<a class="code" href="category_p_h_p.html">PHP</a>
<a name="l00002"></a>00002 
<a name="l00030"></a><a class="code" href="class_resource.html">00030</a> <span class="keyword">class </span><a class="code" href="class_resource.html">Resource</a>
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032     <span class="keyword">private</span> <span class="keyword">static</span> $_imageUrl;
<a name="l00033"></a>00033     <span class="keyword">private</span> <span class="keyword">static</span> $_cssUrl;
<a name="l00034"></a>00034     <span class="keyword">private</span> <span class="keyword">static</span> $_jsUrl;
<a name="l00035"></a>00035     <span class="keyword">private</span> <span class="keyword">static</span> $_currentTheme;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037     <span class="keyword">const</span> DEFAULT_THEME = THEME_NAME;
<a name="l00044"></a><a class="code" href="class_resource.html#a66826405edc53b33073ed69eac7b49f4">00044</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a66826405edc53b33073ed69eac7b49f4">loadMessage</a>($messageFile, $packageName=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00045"></a>00045     {
<a name="l00046"></a>00046         <span class="keywordflow">if</span> (isset($messageFile) &amp;&amp; $messageFile != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00047"></a>00047         {
<a name="l00048"></a>00048 
<a name="l00049"></a>00049             <span class="comment">// message file location order </span>
<a name="l00050"></a>00050             <span class="comment">// 1. MESSAGE_PATH.&quot;/&quot;.$messageFile</span>
<a name="l00051"></a>00051             <span class="comment">// 2. MODULE_PATH . &quot;/$moduleName/message/&quot; . $messageFile;</span>
<a name="l00052"></a>00052             <span class="comment">// 3. CORE_MODULE_PATH . &quot;/$moduleName/message/&quot; . $messageFile;</span>
<a name="l00053"></a>00053             <span class="comment">// APP_HOME / MESSAGE_PATH : APP_HOME / messages</span>
<a name="l00054"></a>00054             <span class="keywordflow">if</span> (is_file(MESSAGE_PATH . <span class="stringliteral">&quot;/&quot;</span> . $messageFile))
<a name="l00055"></a>00055             {
<a name="l00056"></a>00056                 <span class="keywordflow">return</span> parse_ini_file(MESSAGE_PATH . <span class="stringliteral">&quot;/&quot;</span> . $messageFile);
<a name="l00057"></a>00057             } <span class="keywordflow">else</span>
<a name="l00058"></a>00058             {
<a name="l00059"></a>00059                 <span class="keywordflow">if</span> (isset($packageName) &amp;&amp; $packageName != <span class="stringliteral">&quot;&quot;</span>)
<a name="l00060"></a>00060                 {
<a name="l00061"></a>00061                     $dirs = explode(<span class="charliteral">&#39;.&#39;</span>, $packageName);
<a name="l00062"></a>00062                     $moduleName = $dirs[0];
<a name="l00063"></a>00063                     $msgFile = MODULE_PATH . <span class="stringliteral">&quot;/$moduleName/message/&quot;</span> . $messageFile;
<a name="l00064"></a>00064                     <span class="keywordflow">if</span> (is_file($msgFile))
<a name="l00065"></a>00065                     {
<a name="l00066"></a>00066                         <span class="keywordflow">return</span> parse_ini_file($msgFile);
<a name="l00067"></a>00067                     } <span class="keywordflow">else</span>
<a name="l00068"></a>00068                     {
<a name="l00069"></a>00069                         $errmsg = <a class="code" href="class_resource.html#ac6905723ead55f99e9e96d722bf39289">self::getMessage</a>(<span class="stringliteral">&quot;SYS_ERROR_INVALID_MSGFILE&quot;</span>, array($msgFile));
<a name="l00070"></a>00070                         trigger_error($errmsg, E_USER_ERROR);
<a name="l00071"></a>00071                     }
<a name="l00072"></a>00072                 } <span class="keywordflow">else</span>
<a name="l00073"></a>00073                 {
<a name="l00074"></a>00074                     $errmsg = <a class="code" href="class_resource.html#ac6905723ead55f99e9e96d722bf39289">self::getMessage</a>(<span class="stringliteral">&quot;SYS_ERROR_INVALID_MSGFILE&quot;</span>, array(MESSAGE_PATH . <span class="stringliteral">&quot;/&quot;</span> . $messageFile));
<a name="l00075"></a>00075                     trigger_error($errmsg, E_USER_ERROR);
<a name="l00076"></a>00076                 }
<a name="l00077"></a>00077             }
<a name="l00078"></a>00078         }
<a name="l00079"></a>00079         <span class="keywordflow">return</span> null;
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 
<a name="l00088"></a><a class="code" href="class_resource.html#ac6905723ead55f99e9e96d722bf39289">00088</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#ac6905723ead55f99e9e96d722bf39289">getMessage</a>($msgId, $params=array())
<a name="l00089"></a>00089     {
<a name="l00090"></a>00090         $message = constant($msgId);
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (isset($message))
<a name="l00092"></a>00092         {
<a name="l00093"></a>00093             $message = I18n::t($message, $msgId, <span class="stringliteral">&#39;system&#39;</span>);
<a name="l00094"></a>00094             $result = vsprintf($message, $params);
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096         <span class="keywordflow">return</span> $result;
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098 
<a name="l00103"></a><a class="code" href="class_resource.html#a7b561ddf50dd090a4e4d4e4f0cf54d78">00103</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a7b561ddf50dd090a4e4d4e4f0cf54d78">getImageUrl</a>()
<a name="l00104"></a>00104     {
<a name="l00105"></a>00105         <span class="keywordflow">if</span> (isset(self::$_imageUrl))
<a name="l00106"></a>00106             <span class="keywordflow">return</span> self::$_imageUrl;
<a name="l00107"></a>00107         $useTheme = !defined(<span class="stringliteral">&#39;USE_THEME&#39;</span>) ? 0 : USE_THEME;
<a name="l00108"></a>00108         $themeUrl = !defined(<span class="stringliteral">&#39;THEME_URL&#39;</span>) ? <span class="stringliteral">&quot;../themes&quot;</span> : THEME_URL;
<a name="l00109"></a>00109         $themeName = Resource::getCurrentTheme();
<a name="l00110"></a>00110         <span class="keywordflow">if</span> ($useTheme)
<a name="l00111"></a>00111             self::$_imageUrl = <span class="stringliteral">&quot;$themeUrl/$themeName/images&quot;</span>;
<a name="l00112"></a>00112         <span class="keywordflow">else</span>
<a name="l00113"></a>00113             self::$_imageUrl = <span class="stringliteral">&quot;../images&quot;</span>;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115         <span class="keywordflow">return</span> self::$_imageUrl;
<a name="l00116"></a>00116     }
<a name="l00117"></a>00117 
<a name="l00122"></a><a class="code" href="class_resource.html#a867ba152a2aeeae244630f0f9da79d0d">00122</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a867ba152a2aeeae244630f0f9da79d0d">getCssUrl</a>()
<a name="l00123"></a>00123     {
<a name="l00124"></a>00124         <span class="keywordflow">if</span> (isset(self::$_cssUrl))
<a name="l00125"></a>00125             <span class="keywordflow">return</span> self::$_cssUrl;
<a name="l00126"></a>00126         $useTheme = !defined(<span class="stringliteral">&#39;USE_THEME&#39;</span>) ? 0 : USE_THEME;
<a name="l00127"></a>00127         $themeUrl = !defined(<span class="stringliteral">&#39;THEME_URL&#39;</span>) ? APP_URL . <span class="stringliteral">&quot;/themes&quot;</span> : THEME_URL;
<a name="l00128"></a>00128               $themeName = Resource::getCurrentTheme();
<a name="l00129"></a>00129         <span class="keywordflow">if</span> ($useTheme)
<a name="l00130"></a>00130             self::$_cssUrl = <span class="stringliteral">&quot;$themeUrl/$themeName/css&quot;</span>;
<a name="l00131"></a>00131         <span class="keywordflow">else</span>
<a name="l00132"></a>00132             self::$_cssUrl = APP_URL . <span class="stringliteral">&quot;/css&quot;</span>;
<a name="l00133"></a>00133         <span class="keywordflow">return</span> self::$_cssUrl;
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 
<a name="l00140"></a><a class="code" href="class_resource.html#a38ea79def78fdc6f486da392bd2b9188">00140</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a38ea79def78fdc6f486da392bd2b9188">getJsUrl</a>()
<a name="l00141"></a>00141     {
<a name="l00142"></a>00142         <span class="keywordflow">if</span> (isset(self::$_jsUrl))
<a name="l00143"></a>00143             <span class="keywordflow">return</span> self::$_jsUrl;
<a name="l00144"></a>00144         self::$_jsUrl = !defined(<span class="stringliteral">&#39;JS_URL&#39;</span>) ? APP_URL . <span class="stringliteral">&quot;/js&quot;</span> : JS_URL;
<a name="l00145"></a>00145         <span class="keywordflow">return</span> self::$_jsUrl;
<a name="l00146"></a>00146     }
<a name="l00147"></a>00147 
<a name="l00152"></a><a class="code" href="class_resource.html#a1f8104d8aa899c9c115363799ed0cbde">00152</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a1f8104d8aa899c9c115363799ed0cbde">getSmartyTemplate</a>()
<a name="l00153"></a>00153     {
<a name="l00154"></a>00154        <span class="keywordflow">if</span>(extension_loaded(<span class="stringliteral">&#39;ionCube Loader&#39;</span>)){
<a name="l00155"></a>00155               include_once(SMARTY_DIR . <span class="stringliteral">&quot;Smarty.class.php&quot;</span>);
<a name="l00156"></a>00156        }<span class="keywordflow">else</span>{
<a name="l00157"></a>00157               include_once(SMARTY_DIR . <span class="stringliteral">&quot;Smarty.class.src.php&quot;</span>);
<a name="l00158"></a>00158        }
<a name="l00159"></a>00159         $smarty = <span class="keyword">new</span> Smarty;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         $useTheme = !defined(<span class="stringliteral">&#39;USE_THEME&#39;</span>) ? 0 : USE_THEME;
<a name="l00162"></a>00162         <span class="keywordflow">if</span> ($useTheme)
<a name="l00163"></a>00163         {
<a name="l00164"></a>00164             $theme = Resource::getCurrentTheme();
<a name="l00165"></a>00165             $themePath = $theme;    <span class="comment">// BizSystem::configuration()-&gt;GetThemePath($theme);</span>
<a name="l00166"></a>00166             <span class="keywordflow">if</span> (is_dir(THEME_PATH . <span class="stringliteral">&quot;/&quot;</span> . $themePath . <span class="stringliteral">&quot;/template&quot;</span>))
<a name="l00167"></a>00167             {
<a name="l00168"></a>00168                 $templateRoot = THEME_PATH . <span class="stringliteral">&quot;/&quot;</span> . $themePath . <span class="stringliteral">&quot;/template&quot;</span>;
<a name="l00169"></a>00169             } <span class="keywordflow">else</span>
<a name="l00170"></a>00170             {
<a name="l00171"></a>00171                 $templateRoot = THEME_PATH . <span class="stringliteral">&quot;/&quot;</span> . $themePath . <span class="stringliteral">&quot;/templates&quot;</span>;
<a name="l00172"></a>00172             }
<a name="l00173"></a>00173             $smarty-&gt;template_dir = $templateRoot;
<a name="l00174"></a>00174             $smarty-&gt;compile_dir = defined(<span class="stringliteral">&#39;SMARTY_CPL_PATH&#39;</span>) ? SMARTY_CPL_PATH.<span class="stringliteral">&quot;/&quot;</span>.$themePath : $templateRoot . <span class="stringliteral">&quot;/cpl&quot;</span>;
<a name="l00175"></a>00175             $smarty-&gt;config_dir = $templateRoot . <span class="stringliteral">&quot;/cfg&quot;</span>;
<a name="l00176"></a>00176                      <span class="keywordflow">if</span> (!file_exists($smarty-&gt;compile_dir)) {
<a name="l00177"></a>00177                 @mkdir($smarty-&gt;compile_dir, 0777);
<a name="l00178"></a>00178             }
<a name="l00179"></a>00179             <span class="comment">// load the config file which has the images and css url defined</span>
<a name="l00180"></a>00180             $smarty-&gt;config_load(<span class="stringliteral">&#39;tpl.conf&#39;</span>);
<a name="l00181"></a>00181         } <span class="keywordflow">else</span>
<a name="l00182"></a>00182         {
<a name="l00183"></a>00183             <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;SMARTY_TPL_PATH&#39;</span>))
<a name="l00184"></a>00184                 $smarty-&gt;template_dir = SMARTY_TPL_PATH;
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;SMARTY_CPL_PATH&#39;</span>))
<a name="l00186"></a>00186                 $smarty-&gt;compile_dir = SMARTY_CPL_PATH.<span class="stringliteral">&quot;/&quot;</span>.$themePath;
<a name="l00187"></a>00187             <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;SMARTY_CFG_PATH&#39;</span>))
<a name="l00188"></a>00188                 $smarty-&gt;config_dir = SMARTY_CFG_PATH;
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190         <span class="keywordflow">if</span>(!is_dir($smarty-&gt;compile_dir)){
<a name="l00191"></a>00191               mkdir($smarty-&gt;compile_dir,0777);
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193         <span class="comment">// load the config file which has the images and css url defined</span>
<a name="l00194"></a>00194         $smarty-&gt;assign(<span class="stringliteral">&#39;app_url&#39;</span>, APP_URL);
<a name="l00195"></a>00195         $smarty-&gt;assign(<span class="stringliteral">&#39;app_index&#39;</span>, APP_INDEX);
<a name="l00196"></a>00196         $smarty-&gt;assign(<span class="stringliteral">&#39;js_url&#39;</span>, JS_URL);
<a name="l00197"></a>00197         $smarty-&gt;assign(<span class="stringliteral">&#39;css_url&#39;</span>, THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/css&quot;</span>);
<a name="l00198"></a>00198         $smarty-&gt;assign(<span class="stringliteral">&#39;resource_url&#39;</span>, RESOURCE_URL );
<a name="l00199"></a>00199         $smarty-&gt;assign(<span class="stringliteral">&#39;resource_php&#39;</span>, RESOURCE_PHP );
<a name="l00200"></a>00200         $smarty-&gt;assign(<span class="stringliteral">&#39;theme_js_url&#39;</span>, THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/js&quot;</span>);
<a name="l00201"></a>00201         $smarty-&gt;assign(<span class="stringliteral">&#39;theme_url&#39;</span>, THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme);
<a name="l00202"></a>00202         $smarty-&gt;assign(<span class="stringliteral">&#39;image_url&#39;</span>, THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/images&quot;</span>);
<a name="l00203"></a>00203         $smarty-&gt;assign(<span class="stringliteral">&#39;lang&#39;</span>, strtolower(I18n::getCurrentLangCode()));
<a name="l00204"></a>00204         $smarty-&gt;assign(<span class="stringliteral">&#39;lang_name&#39;</span>, I18n::getCurrentLangCode());
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         <span class="keywordflow">return</span> $smarty;
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00213"></a><a class="code" href="class_resource.html#ad15c7aaf2cda13ae9e0d32429f666fc3">00213</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#ad15c7aaf2cda13ae9e0d32429f666fc3">getZendTemplate</a>()
<a name="l00214"></a>00214     {
<a name="l00215"></a>00215         <span class="comment">// now assign the book data to a Zend_View instance</span>
<a name="l00216"></a>00216         <span class="comment">//Zend_Loader::loadClass(&#39;Zend_View&#39;);</span>
<a name="l00217"></a>00217         require_once <span class="stringliteral">&#39;Zend/View.php&#39;</span>;
<a name="l00218"></a>00218         $view = <span class="keyword">new</span> Zend_View();
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (defined(<span class="stringliteral">&#39;SMARTY_TPL_PATH&#39;</span>))
<a name="l00220"></a>00220             $view-&gt;setScriptPath(SMARTY_TPL_PATH);
<a name="l00221"></a>00221 
<a name="l00222"></a>00222         $theme = Resource::getCurrentTheme();            
<a name="l00223"></a>00223             
<a name="l00224"></a>00224         <span class="comment">// load the config file which has the images and css url defined</span>
<a name="l00225"></a>00225         $view-&gt;app_url = APP_URL;
<a name="l00226"></a>00226         $view-&gt;app_index = APP_INDEX;
<a name="l00227"></a>00227         $view-&gt;js_url = JS_URL;
<a name="l00228"></a>00228         $view-&gt;css_url = THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/css&quot;</span>;
<a name="l00229"></a>00229         $view-&gt;resource_url = RESOURCE_URL;    
<a name="l00230"></a>00230         $view-&gt;theme_js_url = THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/js&quot;</span>;
<a name="l00231"></a>00231         $view-&gt;theme_url = THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme;
<a name="l00232"></a>00232         $view-&gt;image_url = THEME_URL . <span class="stringliteral">&quot;/&quot;</span> . $theme . <span class="stringliteral">&quot;/images&quot;</span>;
<a name="l00233"></a>00233         $view-&gt;lang = strtolower(I18n::getCurrentLangCode());            
<a name="l00234"></a>00234             
<a name="l00235"></a>00235         <span class="keywordflow">return</span> $view;
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237 
<a name="l00248"></a><a class="code" href="class_resource.html#af50fc124cc93de9390ce723c36530129">00248</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#af50fc124cc93de9390ce723c36530129">getXmlFileWithPath</a>($xmlObj)
<a name="l00249"></a>00249     {
<a name="l00250"></a>00250         $xmlFile = $xmlObj;
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (strpos($xmlObj, <span class="stringliteral">&quot;.xml&quot;</span>) &gt; 0)  <span class="comment">// remove .xml suffix if any</span>
<a name="l00252"></a>00252             $xmlFile = substr($xmlObj, 0, strlen($xmlObj) - 4);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         <span class="comment">// replace &quot;.&quot; with &quot;/&quot;</span>
<a name="l00255"></a>00255         $xmlFile = str_replace(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;/&quot;</span>, $xmlFile);
<a name="l00256"></a>00256         <span class="comment">// check the leading char &#39;@&#39;</span>
<a name="l00257"></a>00257         $checkExtModule = <span class="keyword">true</span>;
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (strpos($xmlFile, <span class="charliteral">&#39;@&#39;</span>) === 0) {
<a name="l00259"></a>00259             $xmlFile = substr($xmlFile, 1);
<a name="l00260"></a>00260             $checkExtModule = <span class="keyword">false</span>;
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262         $xmlFile .= <span class="stringliteral">&quot;.xml&quot;</span>;
<a name="l00263"></a>00263         $xmlFile = <span class="stringliteral">&quot;/&quot;</span> . $xmlFile;
<a name="l00264"></a>00264         
<a name="l00265"></a>00265         <span class="comment">// search in modules directory first</span>
<a name="l00266"></a>00266         $xmlFileList[] = MODULE_PATH . $xmlFile;
<a name="l00267"></a>00267         $xmlFileList[] = APP_HOME . $xmlFile;
<a name="l00268"></a>00268         $xmlFileList[] = OPENBIZ_META . $xmlFile;
<a name="l00269"></a>00269         <span class="keywordflow">if</span> ($checkExtModule &amp;&amp; defined(<span class="stringliteral">&#39;MODULE_EX_PATH&#39;</span>)) array_unshift($xmlFileList, MODULE_EX_PATH . $xmlFile);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="keywordflow">foreach</span> ($xmlFileList as $xmlFileItem)
<a name="l00272"></a>00272         {
<a name="l00273"></a>00273             <span class="keywordflow">if</span> (file_exists($xmlFileItem))
<a name="l00274"></a>00274                 <span class="keywordflow">return</span> $xmlFileItem;
<a name="l00275"></a>00275         }        
<a name="l00276"></a>00276         <span class="keywordflow">return</span> null;
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278 
<a name="l00285"></a><a class="code" href="class_resource.html#afb794bcc37996f735dfc6e7ddddf961c">00285</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#afb794bcc37996f735dfc6e7ddddf961c">getTplFileWithPath</a>($templateFile, $packageName)
<a name="l00286"></a>00286     {
<a name="l00287"></a>00287         <span class="comment">//for not changing a lot things, the best injection point is added theme support here.</span>
<a name="l00288"></a>00288               $theme = Resource::getCurrentTheme();
<a name="l00289"></a>00289         $themePath = $theme;    <span class="comment">// BizSystem::configuration()-&gt;GetThemePath($theme);</span>
<a name="l00290"></a>00290         <span class="keywordflow">if</span> ($themePath)
<a name="l00291"></a>00291             $templateRoot = THEME_PATH . <span class="stringliteral">&quot;/&quot;</span> . $themePath . <span class="stringliteral">&quot;/template&quot;</span>;
<a name="l00292"></a>00292         <span class="keywordflow">else</span>
<a name="l00293"></a>00293             $templateRoot = SMARTY_TPL_PATH;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         $names = explode(<span class="stringliteral">&quot;.&quot;</span>, $packageName);
<a name="l00296"></a>00296         <span class="keywordflow">if</span> (count($names) &gt; 0)
<a name="l00297"></a>00297             $moduleName = $names[0];
<a name="l00298"></a>00298         $packagePath = str_replace(<span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;/&#39;</span>, $packageName);
<a name="l00299"></a>00299         <span class="comment">// check the leading char &#39;@&#39;</span>
<a name="l00300"></a>00300         $checkExtModule = <span class="keyword">true</span>;
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (strpos($packagePath, <span class="charliteral">&#39;@&#39;</span>) === 0) {
<a name="l00302"></a>00302             $packagePath = substr($packagePath, 1);
<a name="l00303"></a>00303             $checkExtModule = <span class="keyword">false</span>;
<a name="l00304"></a>00304         }
<a name="l00305"></a>00305         
<a name="l00306"></a>00306         $searchTpls = array(
<a name="l00307"></a>00307             MODULE_PATH . <span class="stringliteral">&quot;/$packagePath/template/$templateFile&quot;</span>,
<a name="l00308"></a>00308             dirname(MODULE_PATH . <span class="stringliteral">&quot;/$packagePath&quot;</span>) . <span class="stringliteral">&quot;/template/$templateFile&quot;</span>,
<a name="l00309"></a>00309             MODULE_PATH . <span class="stringliteral">&quot;/$moduleName/template/$templateFile&quot;</span>,
<a name="l00310"></a>00310             <span class="comment">//MODULE_PATH.&quot;/common/template/$templateFile&quot;,</span>
<a name="l00311"></a>00311             $templateRoot . <span class="stringliteral">&quot;/$templateFile&quot;</span>
<a name="l00312"></a>00312         );
<a name="l00313"></a>00313         <span class="keywordflow">if</span> ($checkExtModule &amp;&amp; defined(<span class="stringliteral">&#39;MODULE_EX_PATH&#39;</span>)) array_unshift($searchTpls, MODULE_EX_PATH . <span class="stringliteral">&quot;/$packagePath/template/$templateFile&quot;</span>);
<a name="l00314"></a>00314         <span class="keywordflow">foreach</span> ($searchTpls as $tplFile)
<a name="l00315"></a>00315         {
<a name="l00316"></a>00316             <span class="keywordflow">if</span> (file_exists($tplFile))
<a name="l00317"></a>00317             {
<a name="l00318"></a>00318                 <span class="keywordflow">return</span> $tplFile;
<a name="l00319"></a>00319             }
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321         $errmsg = <a class="code" href="class_resource.html#ac6905723ead55f99e9e96d722bf39289">BizSystem::getMessage</a>(<span class="stringliteral">&quot;UNABLE_TO_LOCATE_TEMPLATE_FILE&quot;</span>, array($templateFile));
<a name="l00322"></a>00322         trigger_error($errmsg, E_USER_ERROR);
<a name="l00323"></a>00323         <span class="keywordflow">return</span> null;
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325 
<a name="l00332"></a><a class="code" href="class_resource.html#a6bbd0684f00be761ca64e9c4eb57a0c7">00332</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_resource.html#a6bbd0684f00be761ca64e9c4eb57a0c7">getLibFileWithPath</a>($className, $packageName=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (!$className)
<a name="l00335"></a>00335             <span class="keywordflow">return</span>;
<a name="l00336"></a>00336         <span class="comment">// search it in cache first</span>
<a name="l00337"></a>00337         $cacheKey = $className . <span class="stringliteral">&quot;_path&quot;</span>;
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (extension_loaded(<span class="charliteral">&#39;0&#39;</span>) &amp;&amp; ($filePath = apc_fetch($cacheKey)) != null)
<a name="l00339"></a>00339             <span class="keywordflow">return</span> $filePath;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341         <span class="keywordflow">if</span> (strpos($className, <span class="stringliteral">&quot;.&quot;</span>) &gt; 0)
<a name="l00342"></a>00342             $className = str_replace(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;/&quot;</span>, $className);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         $filePath = null;
<a name="l00345"></a>00345         $classFile = $className . <span class="stringliteral">&quot;.php&quot;</span>;
<a name="l00346"></a>00346         $classFile_0 = $className . <span class="stringliteral">&quot;.php&quot;</span>;
<a name="l00347"></a>00347         <span class="comment">// convert package name to path, add it to classfile</span>
<a name="l00348"></a>00348         $classFileIsFound = <span class="keyword">false</span>;
<a name="l00349"></a>00349         <span class="keywordflow">if</span> ($packageName)
<a name="l00350"></a>00350         {
<a name="l00351"></a>00351             $path = str_replace(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;/&quot;</span>, $packageName);
<a name="l00352"></a>00352             <span class="comment">// check the leading char &#39;@&#39;</span>
<a name="l00353"></a>00353             $checkExtModule = <span class="keyword">true</span>;
<a name="l00354"></a>00354             <span class="keywordflow">if</span> (strpos($path, <span class="charliteral">&#39;@&#39;</span>) === 0) {
<a name="l00355"></a>00355                 $path = substr($path, 1);
<a name="l00356"></a>00356                 $checkExtModule = <span class="keyword">false</span>;
<a name="l00357"></a>00357             }
<a name="l00358"></a>00358             
<a name="l00359"></a>00359             <span class="comment">// search in apphome/modules directory first, search in apphome/bin directory then</span>
<a name="l00360"></a>00360             $classFiles[0] = MODULE_PATH . <span class="stringliteral">&quot;/&quot;</span> . $path . <span class="stringliteral">&quot;/&quot;</span> . $classFile;
<a name="l00361"></a>00361             $classFiles[1] = APP_HOME . <span class="stringliteral">&quot;/bin/&quot;</span> . $path . <span class="stringliteral">&quot;/&quot;</span> . $classFile;
<a name="l00362"></a>00362             <span class="keywordflow">if</span> ($checkExtModule &amp;&amp; defined(<span class="stringliteral">&#39;MODULE_EX_PATH&#39;</span>)) array_unshift($classFiles, MODULE_EX_PATH . <span class="stringliteral">&quot;/&quot;</span> . $path . <span class="stringliteral">&quot;/&quot;</span> . $classFile);
<a name="l00363"></a>00363             <span class="keywordflow">foreach</span> ($classFiles as $classFile)
<a name="l00364"></a>00364             {
<a name="l00365"></a>00365                 <span class="keywordflow">if</span> (file_exists($classFile))
<a name="l00366"></a>00366                 {
<a name="l00367"></a>00367                     $filePath = $classFile;
<a name="l00368"></a>00368                     $classFileIsFound = <span class="keyword">true</span>;
<a name="l00369"></a>00369                     <span class="keywordflow">break</span>;
<a name="l00370"></a>00370                 }
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="keywordflow">if</span> (!$classFileIsFound)
<a name="l00375"></a>00375             $filePath = self::_getCoreLibFilePath($className);
<a name="l00376"></a>00376         <span class="comment">// cache it to save file search</span>
<a name="l00377"></a>00377         <span class="keywordflow">if</span> ($filePath &amp;&amp; extension_loaded(<span class="stringliteral">&#39;apc&#39;</span>))
<a name="l00378"></a>00378             apc_store($cacheKey, $filePath);
<a name="l00379"></a>00379         <span class="comment">/*if (!file_exists($filePath)) {</span>
<a name="l00380"></a>00380 <span class="comment">            trigger_error(&quot;Cannot find the library file of $className&quot;, E_USER_ERROR);</span>
<a name="l00381"></a>00381 <span class="comment">        }*/</span>
<a name="l00382"></a>00382         <span class="keywordflow">return</span> $filePath;
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384 
<a name="l00391"></a>00391     <span class="keyword">private</span> <span class="keyword">static</span> function _getCoreLibFilePath($className)
<a name="l00392"></a>00392     {
<a name="l00393"></a>00393         $classFile = $className . <span class="stringliteral">&#39;.php&#39;</span>;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395         <span class="comment">// TODO: search the file under bin/, bin/data, bin/ui. bin/service, bin/easy, bin/easy/element.</span>
<a name="l00396"></a>00396         $corePaths = array(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;data/&#39;</span>, <span class="stringliteral">&#39;easy/&#39;</span>, <span class="stringliteral">&#39;easy/element/&#39;</span>, <span class="stringliteral">&#39;ui/&#39;</span>, <span class="stringliteral">&#39;service/&#39;</span>);
<a name="l00397"></a>00397         <span class="keywordflow">foreach</span> ($corePaths as $path)
<a name="l00398"></a>00398         {
<a name="l00399"></a>00399             $_classFile = OPENBIZ_BIN . $path . $classFile;
<a name="l00400"></a>00400             <span class="keywordflow">if</span> (file_exists($_classFile))
<a name="l00401"></a>00401                 <span class="keywordflow">return</span> $_classFile;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403         <span class="keywordflow">return</span> null;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 
<a name="l00416"></a><a class="code" href="class_resource.html#afb3b9597319d812f889a89ab0c7c5e4b">00416</a>     <span class="keyword">public</span> <span class="keyword">static</span> function &amp;<a class="code" href="class_resource.html#afb3b9597319d812f889a89ab0c7c5e4b">getXmlArray</a>($xmlFile)
<a name="l00417"></a>00417     {
<a name="l00418"></a>00418         $objXmlFileName = $xmlFile;
<a name="l00419"></a>00419         <span class="comment">//$objCmpFileName = dirname($objXmlFileName) . &quot;/__cmp/&quot; . basename($objXmlFileName, &quot;xml&quot;) . &quot;.cmp&quot;;</span>
<a name="l00420"></a>00420         $_crc32 = sprintf(<span class="stringliteral">&#39;%08X&#39;</span>, crc32(dirname($objXmlFileName)));
<a name="l00421"></a>00421         $objCmpFileName = CACHE_METADATA_PATH . <span class="charliteral">&#39;/&#39;</span> . $_crc32 . <span class="charliteral">&#39;_&#39;</span>
<a name="l00422"></a>00422                 . basename($objXmlFileName, <span class="stringliteral">&quot;xml&quot;</span>) . <span class="stringliteral">&quot;cmp&quot;</span>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         $xmlArr = null;
<a name="l00425"></a>00425         <span class="comment">//$cacheKey = substr($objXmlFileName, strlen(META_PATH)+1);</span>
<a name="l00426"></a>00426         $cacheKey = $objXmlFileName;
<a name="l00427"></a>00427         $findInCache = <span class="keyword">false</span>;
<a name="l00428"></a>00428         <span class="keywordflow">if</span> (file_exists($objCmpFileName)
<a name="l00429"></a>00429                 &amp;&amp; (filemtime($objCmpFileName) &gt; filemtime($objXmlFileName)))
<a name="l00430"></a>00430         {
<a name="l00431"></a>00431             <span class="comment">// search in cache first</span>
<a name="l00432"></a>00432             <span class="keywordflow">if</span> (!$xmlArr &amp;&amp; extension_loaded(<span class="stringliteral">&#39;apc&#39;</span>))
<a name="l00433"></a>00433             {
<a name="l00434"></a>00434                 <span class="keywordflow">if</span> (($xmlArr = apc_fetch($cacheKey)) != null)
<a name="l00435"></a>00435                 {
<a name="l00436"></a>00436                     $findInCache = <span class="keyword">true</span>;
<a name="l00437"></a>00437                 }
<a name="l00438"></a>00438             }
<a name="l00439"></a>00439             <span class="keywordflow">if</span> (!$xmlArr)
<a name="l00440"></a>00440             {
<a name="l00441"></a>00441                 $content_array = file($objCmpFileName);
<a name="l00442"></a>00442                 $xmlArr = unserialize(implode(<span class="stringliteral">&quot;&quot;</span>, $content_array));
<a name="l00443"></a>00443             }
<a name="l00444"></a>00444         } <span class="keywordflow">else</span>
<a name="l00445"></a>00445         {
<a name="l00446"></a>00446               <span class="keywordflow">if</span>(extension_loaded(<span class="stringliteral">&#39;ionCube Loader&#39;</span>)){
<a name="l00447"></a>00447               include_once(OPENBIZ_BIN . <span class="stringliteral">&quot;util/xmltoarray.php&quot;</span>);
<a name="l00448"></a>00448               }<span class="keywordflow">else</span>{
<a name="l00449"></a>00449                      include_once(OPENBIZ_BIN . <span class="stringliteral">&quot;util/xmltoarray.src.php&quot;</span>);
<a name="l00450"></a>00450               }
<a name="l00451"></a>00451             $parser = <span class="keyword">new</span> <a class="code" href="class_x_m_l_parser.html">XMLParser</a>($objXmlFileName, <span class="stringliteral">&#39;file&#39;</span>, 1);
<a name="l00452"></a>00452             $xmlArr = $parser-&gt;getTree();
<a name="l00453"></a>00453             <span class="comment">// simple validate the xml array</span>
<a name="l00454"></a>00454             $root_keys = array_keys($xmlArr);
<a name="l00455"></a>00455             $root_key = $root_keys[0];
<a name="l00456"></a>00456             <span class="keywordflow">if</span> (!$root_key || $root_key == <span class="stringliteral">&quot;&quot;</span>)
<a name="l00457"></a>00457             {
<a name="l00458"></a>00458                 trigger_error(<span class="stringliteral">&quot;Metadata file parsing error for file $objXmlFileName. Please double check your metadata xml file again.&quot;</span>, E_USER_ERROR);
<a name="l00459"></a>00459             }
<a name="l00460"></a>00460             $xmlArrStr = serialize($xmlArr);
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (!file_exists(dirname($objCmpFileName)))
<a name="l00462"></a>00462                 mkdir(dirname($objCmpFileName));
<a name="l00463"></a>00463             $cmp_file = fopen($objCmpFileName, <span class="charliteral">&#39;w&#39;</span>) or die(<span class="stringliteral">&quot;can&#39;t open cmp file to write&quot;</span>);
<a name="l00464"></a>00464             fwrite($cmp_file, $xmlArrStr) or die(<span class="stringliteral">&quot;can&#39;t write to the cmp file&quot;</span>);
<a name="l00465"></a>00465             fclose($cmp_file);
<a name="l00466"></a>00466         }
<a name="l00467"></a>00467         <span class="comment">// save to cache to avoid file processing overhead</span>
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (!$findInCache &amp;&amp; extension_loaded(<span class="stringliteral">&#39;apc&#39;</span>))
<a name="l00469"></a>00469         {
<a name="l00470"></a>00470             apc_store($cacheKey, $xmlArr);
<a name="l00471"></a>00471         }
<a name="l00472"></a>00472         <span class="keywordflow">return</span> $xmlArr;
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474        <span class="keyword">public</span> <span class="keyword">static</span> function getCurrentTheme ()
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476        <span class="keywordflow">if</span> (Resource::$_currentTheme != null)
<a name="l00477"></a>00477             <span class="keywordflow">return</span> Resource::$_currentTheme;
<a name="l00478"></a>00478             
<a name="l00479"></a>00479         $currentTheme = <a class="code" href="class_biz_system.html#af4e34e77c3fcde41b5c49a48a0b58b0d">BizSystem::sessionContext</a>()-&gt;getVar(<span class="stringliteral">&quot;THEME&quot;</span>);        
<a name="l00480"></a>00480         <span class="comment">// default language</span>
<a name="l00481"></a>00481         <span class="keywordflow">if</span> ($currentTheme == <span class="stringliteral">&quot;&quot;</span>){
<a name="l00482"></a>00482               $currentTheme = BizSystem::getUserPreference(<span class="stringliteral">&quot;theme&quot;</span>);
<a name="l00483"></a>00483               
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485         <span class="keywordflow">if</span>($currentTheme == <span class="stringliteral">&quot;&quot;</span>){
<a name="l00486"></a>00486             $currentTheme = Resource::DEFAULT_THEME;
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488         <span class="comment">// language from url</span>
<a name="l00489"></a>00489         <span class="keywordflow">if</span> (isset($_GET[<span class="stringliteral">&#39;theme&#39;</span>])){
<a name="l00490"></a>00490             $currentTheme = $_GET[<span class="stringliteral">&#39;theme&#39;</span>];
<a name="l00491"></a>00491             <a class="code" href="class_biz_system.html#af4e34e77c3fcde41b5c49a48a0b58b0d">BizSystem::sessionContext</a>()-&gt;setVar(<span class="stringliteral">&quot;THEME&quot;</span>,$currentTheme );
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="comment">// TODO: user pereference has language setting</span>
<a name="l00495"></a>00495         
<a name="l00496"></a>00496         <a class="code" href="class_biz_system.html#af4e34e77c3fcde41b5c49a48a0b58b0d">BizSystem::sessionContext</a>()-&gt;setVar(<span class="stringliteral">&quot;THEME&quot;</span>, $currentTheme);
<a name="l00497"></a>00497         Resource::$_currentTheme = $currentTheme;
<a name="l00498"></a>00498         
<a name="l00499"></a>00499         <span class="keywordflow">return</span> $currentTheme;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:09:13 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
