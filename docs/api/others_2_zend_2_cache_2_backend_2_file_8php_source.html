<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/File.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Cache/Backend/File.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00026"></a>00026 require_once <span class="stringliteral">&#39;Zend/Cache/Backend/ExtendedInterface.php&#39;</span>;
<a name="l00027"></a>00027 
<a name="l00031"></a>00031 require_once <span class="stringliteral">&#39;Zend/Cache/Backend.php&#39;</span>;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 
<a name="l00040"></a><a class="code" href="class_zend___cache___backend___file.html">00040</a> <span class="keyword">class </span><a class="code" href="class_zend___cache___backend___file.html">Zend_Cache_Backend_File</a> <span class="keyword">extends</span> <a class="code" href="class_zend___cache___backend.html">Zend_Cache_Backend</a> implements <a class="code" href="interface_zend___cache___backend___extended_interface.html">Zend_Cache_Backend_ExtendedInterface</a>
<a name="l00041"></a>00041 {
<a name="l00090"></a>00090     <span class="keyword">protected</span> $_options = array(
<a name="l00091"></a>00091         <span class="stringliteral">&#39;cache_dir&#39;</span> =&gt; null,
<a name="l00092"></a>00092         <span class="stringliteral">&#39;file_locking&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00093"></a>00093         <span class="stringliteral">&#39;read_control&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00094"></a>00094         <span class="stringliteral">&#39;read_control_type&#39;</span> =&gt; <span class="stringliteral">&#39;crc32&#39;</span>,
<a name="l00095"></a>00095         <span class="stringliteral">&#39;hashed_directory_level&#39;</span> =&gt; 0,
<a name="l00096"></a>00096         <span class="stringliteral">&#39;hashed_directory_umask&#39;</span> =&gt; 0700,
<a name="l00097"></a>00097         <span class="stringliteral">&#39;file_name_prefix&#39;</span> =&gt; <span class="stringliteral">&#39;zend_cache&#39;</span>,
<a name="l00098"></a>00098         <span class="stringliteral">&#39;cache_file_umask&#39;</span> =&gt; 0600,
<a name="l00099"></a>00099         <span class="stringliteral">&#39;metadatas_array_max_size&#39;</span> =&gt; 100
<a name="l00100"></a>00100     );
<a name="l00101"></a>00101 
<a name="l00107"></a>00107     <span class="keyword">protected</span> $_metadatasArray = array();
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00117"></a><a class="code" href="class_zend___cache___backend___file.html#a2d2b2afcd896367c740d1eb4b486614b">00117</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a2d2b2afcd896367c740d1eb4b486614b">__construct</a>(array $options = array())
<a name="l00118"></a>00118     {
<a name="l00119"></a>00119         <a class="code" href="class_zend___cache___backend___file.html#a2d2b2afcd896367c740d1eb4b486614b">parent::__construct</a>($options);
<a name="l00120"></a>00120         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>] !== null) { <span class="comment">// particular case for this option</span>
<a name="l00121"></a>00121             $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a44923b70cd7afb57cbd0c351a494ac68">setCacheDir</a>($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>]);
<a name="l00122"></a>00122         } <span class="keywordflow">else</span> {
<a name="l00123"></a>00123             $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a44923b70cd7afb57cbd0c351a494ac68">setCacheDir</a>(self::getTmpDir() . DIRECTORY_SEPARATOR, <span class="keyword">false</span>);
<a name="l00124"></a>00124         }
<a name="l00125"></a>00125         <span class="keywordflow">if</span> (isset($this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>])) { <span class="comment">// particular case for this option</span>
<a name="l00126"></a>00126             <span class="keywordflow">if</span> (!preg_match(<span class="stringliteral">&#39;~^[\w]+$~&#39;</span>, $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>])) {
<a name="l00127"></a>00127                 <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;Invalid file_name_prefix : must use only [a-zA-A0-9_]&#39;</span>);
<a name="l00128"></a>00128             }
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;metadatas_array_max_size&#39;</span>] &lt; 10) {
<a name="l00131"></a>00131             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;Invalid metadatas_array_max_size, must be &gt; 10&#39;</span>);
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>]) &amp;&amp; is_string($options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>])) {
<a name="l00134"></a>00134             <span class="comment">// See #ZF-4422</span>
<a name="l00135"></a>00135             $this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>] = octdec($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>]);
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (isset($options[<span class="stringliteral">&#39;cache_file_umask&#39;</span>]) &amp;&amp; is_string($options[<span class="stringliteral">&#39;cache_file_umask&#39;</span>])) {
<a name="l00138"></a>00138             <span class="comment">// See #ZF-4422</span>
<a name="l00139"></a>00139             $this-&gt;_options[<span class="stringliteral">&#39;cache_file_umask&#39;</span>] = octdec($this-&gt;_options[<span class="stringliteral">&#39;cache_file_umask&#39;</span>]);
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142 
<a name="l00151"></a><a class="code" href="class_zend___cache___backend___file.html#a44923b70cd7afb57cbd0c351a494ac68">00151</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a44923b70cd7afb57cbd0c351a494ac68">setCacheDir</a>($value, $trailingSeparator = <span class="keyword">true</span>)
<a name="l00152"></a>00152     {
<a name="l00153"></a>00153         <span class="keywordflow">if</span> (!is_dir($value)) {
<a name="l00154"></a>00154             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;cache_dir must be a directory&#39;</span>);
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (!is_writable($value)) {
<a name="l00157"></a>00157             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;cache_dir is not writable&#39;</span>);
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159         <span class="keywordflow">if</span> ($trailingSeparator) {
<a name="l00160"></a>00160             <span class="comment">// add a trailing DIRECTORY_SEPARATOR if necessary</span>
<a name="l00161"></a>00161             $value = rtrim(realpath($value), <span class="stringliteral">&#39;\\/&#39;</span>) . DIRECTORY_SEPARATOR;
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163         $this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>] = $value;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00173"></a><a class="code" href="class_zend___cache___backend___file.html#a0c06efe7760d74865b6708552f15c258">00173</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a0c06efe7760d74865b6708552f15c258">load</a>($id, $doNotTestCacheValidity = <span class="keyword">false</span>)
<a name="l00174"></a>00174     {
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (!($this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ac50879defc45545458f20fb1c974153b">_test</a>($id, $doNotTestCacheValidity))) {
<a name="l00176"></a>00176             <span class="comment">// The cache is not hit !</span>
<a name="l00177"></a>00177             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179         $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00180"></a>00180         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a724cd179de7016a379f02f4cf304a644">_file</a>($id);
<a name="l00181"></a>00181         $data = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a27beef2aacc686abbce207150de04320">_fileGetContents</a>($file);
<a name="l00182"></a>00182         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;read_control&#39;</span>]) {
<a name="l00183"></a>00183             $hashData = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a8e610043f21951d5c53b42d1ec95a634">_hash</a>($data, $this-&gt;_options[<span class="stringliteral">&#39;read_control_type&#39;</span>]);
<a name="l00184"></a>00184             $hashControl = $metadatas[<span class="stringliteral">&#39;hash&#39;</span>];
<a name="l00185"></a>00185             <span class="keywordflow">if</span> ($hashData != $hashControl) {
<a name="l00186"></a>00186                 <span class="comment">// Problem detected by the read control !</span>
<a name="l00187"></a>00187                 $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&#39;Zend_Cache_Backend_File::load() / read_control : stored hash and computed hash do not match&#39;</span>);
<a name="l00188"></a>00188                 $this-&gt;<span class="keyword">remove</span>($id);
<a name="l00189"></a>00189                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00190"></a>00190             }
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         <span class="keywordflow">return</span> $data;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00201"></a><a class="code" href="class_zend___cache___backend___file.html#a59a4562cc98f0681e6b8f1a9332ef503">00201</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a59a4562cc98f0681e6b8f1a9332ef503">test</a>($id)
<a name="l00202"></a>00202     {
<a name="l00203"></a>00203         clearstatcache();
<a name="l00204"></a>00204         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ac50879defc45545458f20fb1c974153b">_test</a>($id, <span class="keyword">false</span>);
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206 
<a name="l00219"></a><a class="code" href="class_zend___cache___backend___file.html#a3b7f710e6c22b1b9d610a8acdc554869">00219</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a3b7f710e6c22b1b9d610a8acdc554869">save</a>($data, $id, $tags = array(), $specificLifetime = <span class="keyword">false</span>)
<a name="l00220"></a>00220     {
<a name="l00221"></a>00221         clearstatcache();
<a name="l00222"></a>00222         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a724cd179de7016a379f02f4cf304a644">_file</a>($id);
<a name="l00223"></a>00223         $path = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">_path</a>($id);
<a name="l00224"></a>00224         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>] &gt; 0) {
<a name="l00225"></a>00225             <span class="keywordflow">if</span> (!is_writable($path)) {
<a name="l00226"></a>00226                 <span class="comment">// maybe, we just have to build the directory structure</span>
<a name="l00227"></a>00227                 $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a7640f3b7778af6240f9995cf5da417e3">_recursiveMkdirAndChmod</a>($id);
<a name="l00228"></a>00228             }
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (!is_writable($path)) {
<a name="l00230"></a>00230                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;read_control&#39;</span>]) {
<a name="l00234"></a>00234             $hash = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a8e610043f21951d5c53b42d1ec95a634">_hash</a>($data, $this-&gt;_options[<span class="stringliteral">&#39;read_control_type&#39;</span>]);
<a name="l00235"></a>00235         } <span class="keywordflow">else</span> {
<a name="l00236"></a>00236             $hash = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         $metadatas = array(
<a name="l00239"></a>00239             <span class="stringliteral">&#39;hash&#39;</span> =&gt; $hash,
<a name="l00240"></a>00240             <span class="stringliteral">&#39;mtime&#39;</span> =&gt; time(),
<a name="l00241"></a>00241             <span class="stringliteral">&#39;expire&#39;</span> =&gt; $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a1b6e82c9882e9160ada4c723323fbe1a">_expireTime</a>($this-&gt;<a class="code" href="class_zend___cache___backend.html#aecc263de36b29abfcf4059a576340e1d">getLifetime</a>($specificLifetime)),
<a name="l00242"></a>00242             <span class="stringliteral">&#39;tags&#39;</span> =&gt; $tags
<a name="l00243"></a>00243         );
<a name="l00244"></a>00244         $res = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">_setMetadatas</a>($id, $metadatas);
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (!$res) {
<a name="l00246"></a>00246             $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&#39;Zend_Cache_Backend_File::save() / error on saving metadata&#39;</span>);
<a name="l00247"></a>00247             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249         $res = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a3c8cdbad3bcd2b73458402fc181ea159">_filePutContents</a>($file, $data);
<a name="l00250"></a>00250         <span class="keywordflow">return</span> $res;
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252 
<a name="l00259"></a><a class="code" href="class_zend___cache___backend___file.html#a11f0aa9afc724ac4074e3ca127e79a2a">00259</a>     <span class="keyword">public</span> function <span class="keyword">remove</span>($id)
<a name="l00260"></a>00260     {
<a name="l00261"></a>00261         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a724cd179de7016a379f02f4cf304a644">_file</a>($id);
<a name="l00262"></a>00262         $boolRemove   = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a16cc07e4919f0cb3636489428d09819b">_remove</a>($file);
<a name="l00263"></a>00263         $boolMetadata = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a9fa034f510d2a9d0a24c77cf509450a0">_delMetadatas</a>($id);
<a name="l00264"></a>00264         <span class="keywordflow">return</span> $boolMetadata &amp;&amp; $boolRemove;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266 
<a name="l00284"></a><a class="code" href="class_zend___cache___backend___file.html#a177c269d89f9f4ec995fde6da6ae12d8">00284</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a177c269d89f9f4ec995fde6da6ae12d8">clean</a>($mode = <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>, $tags = array())
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286         <span class="comment">// We use this protected method to hide the recursive stuff</span>
<a name="l00287"></a>00287         clearstatcache();
<a name="l00288"></a>00288         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a7659c6568447455919e4860c2dd213c6">_clean</a>($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], $mode, $tags);
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00296"></a><a class="code" href="class_zend___cache___backend___file.html#ad79572b026977913d75446d20467eaaa">00296</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#ad79572b026977913d75446d20467eaaa">getIds</a>()
<a name="l00297"></a>00297     {
<a name="l00298"></a>00298         <span class="keywordflow">return</span> $this-&gt;_get($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], <span class="stringliteral">&#39;ids&#39;</span>, array());
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 
<a name="l00306"></a><a class="code" href="class_zend___cache___backend___file.html#ae07173ab06a20e2f5bd928cc0518e01f">00306</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#ae07173ab06a20e2f5bd928cc0518e01f">getTags</a>()
<a name="l00307"></a>00307     {
<a name="l00308"></a>00308         <span class="keywordflow">return</span> $this-&gt;_get($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], <span class="stringliteral">&#39;tags&#39;</span>, array());
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00319"></a><a class="code" href="class_zend___cache___backend___file.html#ab5ba3730429676f2555bf765c56db804">00319</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#ab5ba3730429676f2555bf765c56db804">getIdsMatchingTags</a>($tags = array())
<a name="l00320"></a>00320     {
<a name="l00321"></a>00321         <span class="keywordflow">return</span> $this-&gt;_get($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], <span class="stringliteral">&#39;matching&#39;</span>, $tags);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323 
<a name="l00332"></a><a class="code" href="class_zend___cache___backend___file.html#af90b2d1c5962ba55891e92b1895df055">00332</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#af90b2d1c5962ba55891e92b1895df055">getIdsNotMatchingTags</a>($tags = array())
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <span class="keywordflow">return</span> $this-&gt;_get($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], <span class="stringliteral">&#39;notMatching&#39;</span>, $tags);
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336 
<a name="l00345"></a><a class="code" href="class_zend___cache___backend___file.html#a5daca406882c003b1181a0ae7ab9f652">00345</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a5daca406882c003b1181a0ae7ab9f652">getIdsMatchingAnyTags</a>($tags = array())
<a name="l00346"></a>00346     {
<a name="l00347"></a>00347         <span class="keywordflow">return</span> $this-&gt;_get($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>], <span class="stringliteral">&#39;matchingAny&#39;</span>, $tags);
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00356"></a><a class="code" href="class_zend___cache___backend___file.html#a274375a3bd0220c282ba260146a0a339">00356</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a274375a3bd0220c282ba260146a0a339">getFillingPercentage</a>()
<a name="l00357"></a>00357     {
<a name="l00358"></a>00358         $free = disk_free_space($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>]);
<a name="l00359"></a>00359         $total = disk_total_space($this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>]);
<a name="l00360"></a>00360         <span class="keywordflow">if</span> ($total == 0) {
<a name="l00361"></a>00361             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;can\&#39;t get disk_total_space&#39;</span>);
<a name="l00362"></a>00362         } <span class="keywordflow">else</span> {
<a name="l00363"></a>00363             <span class="keywordflow">if</span> ($free &gt;= $total) {
<a name="l00364"></a>00364                 <span class="keywordflow">return</span> 100;
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366             <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>) (100. * ($total - $free) / $total));
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00381"></a><a class="code" href="class_zend___cache___backend___file.html#ad9b728cfeebfcb620c24b2228b3e1218">00381</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#ad9b728cfeebfcb620c24b2228b3e1218">getMetadatas</a>($id)
<a name="l00382"></a>00382     {
<a name="l00383"></a>00383         $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (!$metadatas) {
<a name="l00385"></a>00385             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (time() &gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>]) {
<a name="l00388"></a>00388             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390         <span class="keywordflow">return</span> array(
<a name="l00391"></a>00391             <span class="stringliteral">&#39;expire&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>],
<a name="l00392"></a>00392             <span class="stringliteral">&#39;tags&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;tags&#39;</span>],
<a name="l00393"></a>00393             <span class="stringliteral">&#39;mtime&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;mtime&#39;</span>]
<a name="l00394"></a>00394         );
<a name="l00395"></a>00395     }
<a name="l00396"></a>00396 
<a name="l00404"></a><a class="code" href="class_zend___cache___backend___file.html#a8660c88175edca5e9e9f7a725781e698">00404</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a8660c88175edca5e9e9f7a725781e698">touch</a>($id, $extraLifetime)
<a name="l00405"></a>00405     {
<a name="l00406"></a>00406         $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (!$metadatas) {
<a name="l00408"></a>00408             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (time() &gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>]) {
<a name="l00411"></a>00411             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00412"></a>00412         }
<a name="l00413"></a>00413         $newMetadatas = array(
<a name="l00414"></a>00414             <span class="stringliteral">&#39;hash&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;hash&#39;</span>],
<a name="l00415"></a>00415             <span class="stringliteral">&#39;mtime&#39;</span> =&gt; time(),
<a name="l00416"></a>00416             <span class="stringliteral">&#39;expire&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>] + $extraLifetime,
<a name="l00417"></a>00417             <span class="stringliteral">&#39;tags&#39;</span> =&gt; $metadatas[<span class="stringliteral">&#39;tags&#39;</span>]
<a name="l00418"></a>00418         );
<a name="l00419"></a>00419         $res = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">_setMetadatas</a>($id, $newMetadatas);
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (!$res) {
<a name="l00421"></a>00421             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00440"></a><a class="code" href="class_zend___cache___backend___file.html#aef6a344a8de433b50039668ea77ed506">00440</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#aef6a344a8de433b50039668ea77ed506">getCapabilities</a>()
<a name="l00441"></a>00441     {
<a name="l00442"></a>00442         <span class="keywordflow">return</span> array(
<a name="l00443"></a>00443             <span class="stringliteral">&#39;automatic_cleaning&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00444"></a>00444             <span class="stringliteral">&#39;tags&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00445"></a>00445             <span class="stringliteral">&#39;expired_read&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00446"></a>00446             <span class="stringliteral">&#39;priority&#39;</span> =&gt; <span class="keyword">false</span>,
<a name="l00447"></a>00447             <span class="stringliteral">&#39;infinite_lifetime&#39;</span> =&gt; <span class="keyword">true</span>,
<a name="l00448"></a>00448             <span class="stringliteral">&#39;get_list&#39;</span> =&gt; <span class="keyword">true</span>
<a name="l00449"></a>00449         );
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451 
<a name="l00459"></a><a class="code" href="class_zend___cache___backend___file.html#a1029d47e61a3510047583e01fa39b077">00459</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___cache___backend___file.html#a1029d47e61a3510047583e01fa39b077">___expire</a>($id)
<a name="l00460"></a>00460     {
<a name="l00461"></a>00461         $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00462"></a>00462         <span class="keywordflow">if</span> ($metadatas) {
<a name="l00463"></a>00463             $metadatas[<span class="stringliteral">&#39;expire&#39;</span>] = 1;
<a name="l00464"></a>00464             $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">_setMetadatas</a>($id, $metadatas);
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467 
<a name="l00474"></a><a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">00474</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id)
<a name="l00475"></a>00475     {
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (isset($this-&gt;_metadatasArray[$id])) {
<a name="l00477"></a>00477             <span class="keywordflow">return</span> $this-&gt;_metadatasArray[$id];
<a name="l00478"></a>00478         } <span class="keywordflow">else</span> {
<a name="l00479"></a>00479             $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a5f3c06d79ed2e8838d4c77139f83a072">_loadMetadatas</a>($id);
<a name="l00480"></a>00480             <span class="keywordflow">if</span> (!$metadatas) {
<a name="l00481"></a>00481                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00482"></a>00482             }
<a name="l00483"></a>00483             $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">_setMetadatas</a>($id, $metadatas, <span class="keyword">false</span>);
<a name="l00484"></a>00484             <span class="keywordflow">return</span> $metadatas;
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00496"></a><a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">00496</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#ab4887a28ce02b5554d8c413b9e0fa0c6">_setMetadatas</a>($id, $metadatas, $save = <span class="keyword">true</span>)
<a name="l00497"></a>00497     {
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (count($this-&gt;_metadatasArray) &gt;= $this-&gt;_options[<span class="stringliteral">&#39;metadatas_array_max_size&#39;</span>]) {
<a name="l00499"></a>00499             $n = (int) ($this-&gt;_options[<span class="stringliteral">&#39;metadatas_array_max_size&#39;</span>] / 10);
<a name="l00500"></a>00500             $this-&gt;_metadatasArray = array_slice($this-&gt;_metadatasArray, $n);
<a name="l00501"></a>00501         }
<a name="l00502"></a>00502         <span class="keywordflow">if</span> ($save) {
<a name="l00503"></a>00503             $result = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a90163425c45a6921395af2b3c71d7382">_saveMetadatas</a>($id, $metadatas);
<a name="l00504"></a>00504             <span class="keywordflow">if</span> (!$result) {
<a name="l00505"></a>00505                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00506"></a>00506             }
<a name="l00507"></a>00507         }
<a name="l00508"></a>00508         $this-&gt;_metadatasArray[$id] = $metadatas;
<a name="l00509"></a>00509         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00518"></a><a class="code" href="class_zend___cache___backend___file.html#a9fa034f510d2a9d0a24c77cf509450a0">00518</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a9fa034f510d2a9d0a24c77cf509450a0">_delMetadatas</a>($id)
<a name="l00519"></a>00519     {
<a name="l00520"></a>00520         <span class="keywordflow">if</span> (isset($this-&gt;_metadatasArray[$id])) {
<a name="l00521"></a>00521             unset($this-&gt;_metadatasArray[$id]);
<a name="l00522"></a>00522         }
<a name="l00523"></a>00523         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a2b984310d95beafa54c47bf73f237021">_metadatasFile</a>($id);
<a name="l00524"></a>00524         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a16cc07e4919f0cb3636489428d09819b">_remove</a>($file);
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 
<a name="l00532"></a><a class="code" href="class_zend___cache___backend___file.html#a6b7a017135bdee5062185fa1d918dfad">00532</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a6b7a017135bdee5062185fa1d918dfad">_cleanMetadatas</a>()
<a name="l00533"></a>00533     {
<a name="l00534"></a>00534         $this-&gt;_metadatasArray = array();
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536 
<a name="l00543"></a><a class="code" href="class_zend___cache___backend___file.html#a5f3c06d79ed2e8838d4c77139f83a072">00543</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a5f3c06d79ed2e8838d4c77139f83a072">_loadMetadatas</a>($id)
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a2b984310d95beafa54c47bf73f237021">_metadatasFile</a>($id);
<a name="l00546"></a>00546         $result = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a27beef2aacc686abbce207150de04320">_fileGetContents</a>($file);
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (!$result) {
<a name="l00548"></a>00548             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         $tmp = @unserialize($result);
<a name="l00551"></a>00551         <span class="keywordflow">return</span> $tmp;
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00561"></a><a class="code" href="class_zend___cache___backend___file.html#a90163425c45a6921395af2b3c71d7382">00561</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a90163425c45a6921395af2b3c71d7382">_saveMetadatas</a>($id, $metadatas)
<a name="l00562"></a>00562     {
<a name="l00563"></a>00563         $file = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a2b984310d95beafa54c47bf73f237021">_metadatasFile</a>($id);
<a name="l00564"></a>00564         $result = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a3c8cdbad3bcd2b73458402fc181ea159">_filePutContents</a>($file, serialize($metadatas));
<a name="l00565"></a>00565         <span class="keywordflow">if</span> (!$result) {
<a name="l00566"></a>00566             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00569"></a>00569     }
<a name="l00570"></a>00570 
<a name="l00577"></a><a class="code" href="class_zend___cache___backend___file.html#a2b984310d95beafa54c47bf73f237021">00577</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a2b984310d95beafa54c47bf73f237021">_metadatasFile</a>($id)
<a name="l00578"></a>00578     {
<a name="l00579"></a>00579         $path = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">_path</a>($id);
<a name="l00580"></a>00580         $fileName = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ac51e112821315da3f896cb5702c687e3">_idToFileName</a>(<span class="stringliteral">&#39;internal-metadatas---&#39;</span> . $id);
<a name="l00581"></a>00581         <span class="keywordflow">return</span> $path . $fileName;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00590"></a><a class="code" href="class_zend___cache___backend___file.html#a812c43f85aaa736247cbbec1ee2ec6a8">00590</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a812c43f85aaa736247cbbec1ee2ec6a8">_isMetadatasFile</a>($fileName)
<a name="l00591"></a>00591     {
<a name="l00592"></a>00592         $id = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#aed8b65352bd25cffcf1417086183bc37">_fileNameToId</a>($fileName);
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (substr($id, 0, 21) == <span class="stringliteral">&#39;internal-metadatas---&#39;</span>) {
<a name="l00594"></a>00594             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00595"></a>00595         } <span class="keywordflow">else</span> {
<a name="l00596"></a>00596             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599 
<a name="l00609"></a><a class="code" href="class_zend___cache___backend___file.html#a16cc07e4919f0cb3636489428d09819b">00609</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a16cc07e4919f0cb3636489428d09819b">_remove</a>($file)
<a name="l00610"></a>00610     {
<a name="l00611"></a>00611         <span class="keywordflow">if</span> (!is_file($file)) {
<a name="l00612"></a>00612             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614         <span class="keywordflow">if</span> (!@unlink($file)) {
<a name="l00615"></a>00615 <span class="preprocessor">            # we can&#39;t remove the file (because of locks or any problem)</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span>            $this-&gt;<a class="code" href="class_zend___cache___backend.html#a3ae77371a39ff503fe83e8e20b24486b">_log</a>(<span class="stringliteral">&quot;Zend_Cache_Backend_File::_remove() : we can&#39;t remove $file&quot;</span>);
<a name="l00617"></a>00617             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621 
<a name="l00641"></a><a class="code" href="class_zend___cache___backend___file.html#a7659c6568447455919e4860c2dd213c6">00641</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a7659c6568447455919e4860c2dd213c6">_clean</a>($dir, $mode = <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>, $tags = array())
<a name="l00642"></a>00642     {
<a name="l00643"></a>00643         <span class="keywordflow">if</span> (!is_dir($dir)) {
<a name="l00644"></a>00644             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00645"></a>00645         }
<a name="l00646"></a>00646         $result = <span class="keyword">true</span>;
<a name="l00647"></a>00647         $prefix = $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>];
<a name="l00648"></a>00648         $glob = @glob($dir . $prefix . <span class="stringliteral">&#39;--*&#39;</span>);
<a name="l00649"></a>00649         <span class="keywordflow">if</span> ($glob === <span class="keyword">false</span>) {
<a name="l00650"></a>00650             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652         <span class="keywordflow">foreach</span> ($glob as $file)  {
<a name="l00653"></a>00653             <span class="keywordflow">if</span> (is_file($file)) {
<a name="l00654"></a>00654                 $fileName = basename($file);
<a name="l00655"></a>00655                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a812c43f85aaa736247cbbec1ee2ec6a8">_isMetadatasFile</a>($fileName)) {
<a name="l00656"></a>00656                     <span class="comment">// in CLEANING_MODE_ALL, we drop anything, even remainings old metadatas files</span>
<a name="l00657"></a>00657                     <span class="keywordflow">if</span> ($mode != <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>) {
<a name="l00658"></a>00658                         <span class="keywordflow">continue</span>;
<a name="l00659"></a>00659                     }
<a name="l00660"></a>00660                 }
<a name="l00661"></a>00661                 $id = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#aed8b65352bd25cffcf1417086183bc37">_fileNameToId</a>($fileName);
<a name="l00662"></a>00662                 $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00663"></a>00663                 <span class="keywordflow">if</span> ($metadatas === FALSE) {
<a name="l00664"></a>00664                     $metadatas = array(<span class="stringliteral">&#39;expire&#39;</span> =&gt; 1, <span class="stringliteral">&#39;tags&#39;</span> =&gt; array());
<a name="l00665"></a>00665                 }
<a name="l00666"></a>00666                 <span class="keywordflow">switch</span> ($mode) {
<a name="l00667"></a>00667                     <span class="keywordflow">case</span> <a class="code" href="class_zend___cache.html#ab0aa96114be1ec971695407c9d3a4344">Zend_Cache::CLEANING_MODE_ALL</a>:
<a name="l00668"></a>00668                         $res = $this-&gt;<span class="keyword">remove</span>($id);
<a name="l00669"></a>00669                         <span class="keywordflow">if</span> (!$res) {
<a name="l00670"></a>00670                             <span class="comment">// in this case only, we accept a problem with the metadatas file drop</span>
<a name="l00671"></a>00671                             $res = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a16cc07e4919f0cb3636489428d09819b">_remove</a>($file);
<a name="l00672"></a>00672                         }
<a name="l00673"></a>00673                         $result = $result &amp;&amp; $res;
<a name="l00674"></a>00674                         <span class="keywordflow">break</span>;
<a name="l00675"></a>00675                     <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_OLD:
<a name="l00676"></a>00676                         <span class="keywordflow">if</span> (time() &gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>]) {
<a name="l00677"></a>00677                             $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00678"></a>00678                         }
<a name="l00679"></a>00679                         <span class="keywordflow">break</span>;
<a name="l00680"></a>00680                     <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_TAG:
<a name="l00681"></a>00681                         $matching = <span class="keyword">true</span>;
<a name="l00682"></a>00682                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00683"></a>00683                             <span class="keywordflow">if</span> (!in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00684"></a>00684                                 $matching = <span class="keyword">false</span>;
<a name="l00685"></a>00685                                 <span class="keywordflow">break</span>;
<a name="l00686"></a>00686                             }
<a name="l00687"></a>00687                         }
<a name="l00688"></a>00688                         <span class="keywordflow">if</span> ($matching) {
<a name="l00689"></a>00689                             $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00690"></a>00690                         }
<a name="l00691"></a>00691                         <span class="keywordflow">break</span>;
<a name="l00692"></a>00692                     <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_NOT_MATCHING_TAG:
<a name="l00693"></a>00693                         $matching = <span class="keyword">false</span>;
<a name="l00694"></a>00694                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00695"></a>00695                             <span class="keywordflow">if</span> (in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00696"></a>00696                                 $matching = <span class="keyword">true</span>;
<a name="l00697"></a>00697                                 <span class="keywordflow">break</span>;
<a name="l00698"></a>00698                             }
<a name="l00699"></a>00699                         }
<a name="l00700"></a>00700                         <span class="keywordflow">if</span> (!$matching) {
<a name="l00701"></a>00701                             $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00702"></a>00702                         }
<a name="l00703"></a>00703                         <span class="keywordflow">break</span>;
<a name="l00704"></a>00704                     <span class="keywordflow">case</span> Zend_Cache::CLEANING_MODE_MATCHING_ANY_TAG:
<a name="l00705"></a>00705                         $matching = <span class="keyword">false</span>;
<a name="l00706"></a>00706                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00707"></a>00707                             <span class="keywordflow">if</span> (in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00708"></a>00708                                 $matching = <span class="keyword">true</span>;
<a name="l00709"></a>00709                                 <span class="keywordflow">break</span>;
<a name="l00710"></a>00710                             }
<a name="l00711"></a>00711                         }
<a name="l00712"></a>00712                         <span class="keywordflow">if</span> ($matching) {
<a name="l00713"></a>00713                             $result = $this-&gt;<span class="keyword">remove</span>($id) &amp;&amp; $result;
<a name="l00714"></a>00714                         }
<a name="l00715"></a>00715                         <span class="keywordflow">break</span>;
<a name="l00716"></a>00716                     <span class="keywordflow">default</span>:
<a name="l00717"></a>00717                         <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;Invalid mode for clean() method&#39;</span>);
<a name="l00718"></a>00718                         <span class="keywordflow">break</span>;
<a name="l00719"></a>00719                 }
<a name="l00720"></a>00720             }
<a name="l00721"></a>00721             <span class="keywordflow">if</span> ((is_dir($file)) and ($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>]&gt;0)) {
<a name="l00722"></a>00722                 <span class="comment">// Recursive call</span>
<a name="l00723"></a>00723                 $result = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a7659c6568447455919e4860c2dd213c6">_clean</a>($file . DIRECTORY_SEPARATOR, $mode, $tags) &amp;&amp; $result;
<a name="l00724"></a>00724                 <span class="keywordflow">if</span> ($mode==<span class="stringliteral">&#39;all&#39;</span>) {
<a name="l00725"></a>00725                     <span class="comment">// if mode==&#39;all&#39;, we try to drop the structure too</span>
<a name="l00726"></a>00726                     @rmdir($file);
<a name="l00727"></a>00727                 }
<a name="l00728"></a>00728             }
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730         <span class="keywordflow">return</span> $result;
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="keyword">protected</span> function _get($dir, $mode, $tags = array())
<a name="l00734"></a>00734     {
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (!is_dir($dir)) {
<a name="l00736"></a>00736             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738         $result = array();
<a name="l00739"></a>00739         $prefix = $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>];
<a name="l00740"></a>00740         $glob = @glob($dir . $prefix . <span class="stringliteral">&#39;--*&#39;</span>);
<a name="l00741"></a>00741         <span class="keywordflow">if</span> ($glob === <span class="keyword">false</span>) {
<a name="l00742"></a>00742             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00743"></a>00743         }
<a name="l00744"></a>00744         <span class="keywordflow">foreach</span> ($glob as $file)  {
<a name="l00745"></a>00745             <span class="keywordflow">if</span> (is_file($file)) {
<a name="l00746"></a>00746                 $fileName = basename($file);
<a name="l00747"></a>00747                 $id = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#aed8b65352bd25cffcf1417086183bc37">_fileNameToId</a>($fileName);
<a name="l00748"></a>00748                 $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00749"></a>00749                 <span class="keywordflow">if</span> ($metadatas === FALSE) {
<a name="l00750"></a>00750                     <span class="keywordflow">continue</span>;
<a name="l00751"></a>00751                 }
<a name="l00752"></a>00752                 <span class="keywordflow">if</span> (time() &gt; $metadatas[<span class="stringliteral">&#39;expire&#39;</span>]) {
<a name="l00753"></a>00753                     <span class="keywordflow">continue</span>;
<a name="l00754"></a>00754                 }
<a name="l00755"></a>00755                 <span class="keywordflow">switch</span> ($mode) {
<a name="l00756"></a>00756                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;ids&#39;</span>:
<a name="l00757"></a>00757                         $result[] = $id;
<a name="l00758"></a>00758                         <span class="keywordflow">break</span>;
<a name="l00759"></a>00759                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;tags&#39;</span>:
<a name="l00760"></a>00760                         $result = array_unique(array_merge($result, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>]));
<a name="l00761"></a>00761                         <span class="keywordflow">break</span>;
<a name="l00762"></a>00762                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;matching&#39;</span>:
<a name="l00763"></a>00763                         $matching = <span class="keyword">true</span>;
<a name="l00764"></a>00764                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00765"></a>00765                             <span class="keywordflow">if</span> (!in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00766"></a>00766                                 $matching = <span class="keyword">false</span>;
<a name="l00767"></a>00767                                 <span class="keywordflow">break</span>;
<a name="l00768"></a>00768                             }
<a name="l00769"></a>00769                         }
<a name="l00770"></a>00770                         <span class="keywordflow">if</span> ($matching) {
<a name="l00771"></a>00771                             $result[] = $id;
<a name="l00772"></a>00772                         }
<a name="l00773"></a>00773                         <span class="keywordflow">break</span>;
<a name="l00774"></a>00774                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;notMatching&#39;</span>:
<a name="l00775"></a>00775                         $matching = <span class="keyword">false</span>;
<a name="l00776"></a>00776                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00777"></a>00777                             <span class="keywordflow">if</span> (in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00778"></a>00778                                 $matching = <span class="keyword">true</span>;
<a name="l00779"></a>00779                                 <span class="keywordflow">break</span>;
<a name="l00780"></a>00780                             }
<a name="l00781"></a>00781                         }
<a name="l00782"></a>00782                         <span class="keywordflow">if</span> (!$matching) {
<a name="l00783"></a>00783                             $result[] = $id;
<a name="l00784"></a>00784                         }
<a name="l00785"></a>00785                         <span class="keywordflow">break</span>;
<a name="l00786"></a>00786                     <span class="keywordflow">case</span> <span class="stringliteral">&#39;matchingAny&#39;</span>:
<a name="l00787"></a>00787                         $matching = <span class="keyword">false</span>;
<a name="l00788"></a>00788                         <span class="keywordflow">foreach</span> ($tags as $tag) {
<a name="l00789"></a>00789                             <span class="keywordflow">if</span> (in_array($tag, $metadatas[<span class="stringliteral">&#39;tags&#39;</span>])) {
<a name="l00790"></a>00790                                 $matching = <span class="keyword">true</span>;
<a name="l00791"></a>00791                                 <span class="keywordflow">break</span>;
<a name="l00792"></a>00792                             }
<a name="l00793"></a>00793                         }
<a name="l00794"></a>00794                         <span class="keywordflow">if</span> ($matching) {
<a name="l00795"></a>00795                             $result[] = $id;
<a name="l00796"></a>00796                         }
<a name="l00797"></a>00797                         <span class="keywordflow">break</span>;
<a name="l00798"></a>00798                     <span class="keywordflow">default</span>:
<a name="l00799"></a>00799                         <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&#39;Invalid mode for _get() method&#39;</span>);
<a name="l00800"></a>00800                         <span class="keywordflow">break</span>;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803             <span class="keywordflow">if</span> ((is_dir($file)) and ($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>]&gt;0)) {
<a name="l00804"></a>00804                 <span class="comment">// Recursive call</span>
<a name="l00805"></a>00805                 $result = array_unique(array_merge($result, $this-&gt;_get($file . DIRECTORY_SEPARATOR, $mode, $tags)));
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808         <span class="keywordflow">return</span> array_unique($result);
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00816"></a><a class="code" href="class_zend___cache___backend___file.html#a1b6e82c9882e9160ada4c723323fbe1a">00816</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a1b6e82c9882e9160ada4c723323fbe1a">_expireTime</a>($lifetime)
<a name="l00817"></a>00817     {
<a name="l00818"></a>00818         <span class="keywordflow">if</span> ($lifetime === null) {
<a name="l00819"></a>00819             <span class="keywordflow">return</span> 9999999999;
<a name="l00820"></a>00820         }
<a name="l00821"></a>00821         <span class="keywordflow">return</span> time() + $lifetime;
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823 
<a name="l00832"></a><a class="code" href="class_zend___cache___backend___file.html#a8e610043f21951d5c53b42d1ec95a634">00832</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a8e610043f21951d5c53b42d1ec95a634">_hash</a>($data, $controlType)
<a name="l00833"></a>00833     {
<a name="l00834"></a>00834         <span class="keywordflow">switch</span> ($controlType) {
<a name="l00835"></a>00835         <span class="keywordflow">case</span> <span class="stringliteral">&#39;md5&#39;</span>:
<a name="l00836"></a>00836             <span class="keywordflow">return</span> md5($data);
<a name="l00837"></a>00837         <span class="keywordflow">case</span> <span class="stringliteral">&#39;crc32&#39;</span>:
<a name="l00838"></a>00838             <span class="keywordflow">return</span> crc32($data);
<a name="l00839"></a>00839         <span class="keywordflow">case</span> <span class="stringliteral">&#39;strlen&#39;</span>:
<a name="l00840"></a>00840             <span class="keywordflow">return</span> strlen($data);
<a name="l00841"></a>00841         <span class="keywordflow">case</span> <span class="stringliteral">&#39;adler32&#39;</span>:
<a name="l00842"></a>00842             <span class="keywordflow">return</span> hash(<span class="stringliteral">&#39;adler32&#39;</span>, $data);
<a name="l00843"></a>00843         <span class="keywordflow">default</span>:
<a name="l00844"></a>00844             <a class="code" href="class_zend___cache.html#aa759b8586c8aca902bd2b96d8ce65ab1">Zend_Cache::throwException</a>(<span class="stringliteral">&quot;Incorrect hash function : $controlType&quot;</span>);
<a name="l00845"></a>00845         }
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00854"></a><a class="code" href="class_zend___cache___backend___file.html#ac51e112821315da3f896cb5702c687e3">00854</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#ac51e112821315da3f896cb5702c687e3">_idToFileName</a>($id)
<a name="l00855"></a>00855     {
<a name="l00856"></a>00856         $prefix = $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>];
<a name="l00857"></a>00857         $result = $prefix . <span class="stringliteral">&#39;---&#39;</span> . $id;
<a name="l00858"></a>00858         <span class="keywordflow">return</span> $result;
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860 
<a name="l00867"></a><a class="code" href="class_zend___cache___backend___file.html#a724cd179de7016a379f02f4cf304a644">00867</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a724cd179de7016a379f02f4cf304a644">_file</a>($id)
<a name="l00868"></a>00868     {
<a name="l00869"></a>00869         $path = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">_path</a>($id);
<a name="l00870"></a>00870         $fileName = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ac51e112821315da3f896cb5702c687e3">_idToFileName</a>($id);
<a name="l00871"></a>00871         <span class="keywordflow">return</span> $path . $fileName;
<a name="l00872"></a>00872     }
<a name="l00873"></a>00873 
<a name="l00881"></a><a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">00881</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">_path</a>($id, $parts = <span class="keyword">false</span>)
<a name="l00882"></a>00882     {
<a name="l00883"></a>00883         $partsArray = array();
<a name="l00884"></a>00884         $root = $this-&gt;_options[<span class="stringliteral">&#39;cache_dir&#39;</span>];
<a name="l00885"></a>00885         $prefix = $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>];
<a name="l00886"></a>00886         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>]&gt;0) {
<a name="l00887"></a>00887             $hash = hash(<span class="stringliteral">&#39;adler32&#39;</span>, $id);
<a name="l00888"></a>00888             <span class="keywordflow">for</span> ($i=0 ; $i &lt; $this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>] ; $i++) {
<a name="l00889"></a>00889                 $root = $root . $prefix . <span class="stringliteral">&#39;--&#39;</span> . substr($hash, 0, $i + 1) . DIRECTORY_SEPARATOR;
<a name="l00890"></a>00890                 $partsArray[] = $root;
<a name="l00891"></a>00891             }
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893         <span class="keywordflow">if</span> ($parts) {
<a name="l00894"></a>00894             <span class="keywordflow">return</span> $partsArray;
<a name="l00895"></a>00895         } <span class="keywordflow">else</span> {
<a name="l00896"></a>00896             <span class="keywordflow">return</span> $root;
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899 
<a name="l00906"></a><a class="code" href="class_zend___cache___backend___file.html#a7640f3b7778af6240f9995cf5da417e3">00906</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a7640f3b7778af6240f9995cf5da417e3">_recursiveMkdirAndChmod</a>($id)
<a name="l00907"></a>00907     {
<a name="l00908"></a>00908         <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_level&#39;</span>] &lt;=0) {
<a name="l00909"></a>00909             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00910"></a>00910         }
<a name="l00911"></a>00911         $partsArray = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#a355657d6585dd6b49f0b26265a988949">_path</a>($id, <span class="keyword">true</span>);
<a name="l00912"></a>00912         <span class="keywordflow">foreach</span> ($partsArray as $part) {
<a name="l00913"></a>00913             <span class="keywordflow">if</span> (!is_dir($part)) {
<a name="l00914"></a>00914                 @mkdir($part, $this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>]);
<a name="l00915"></a>00915                 @chmod($part, $this-&gt;_options[<span class="stringliteral">&#39;hashed_directory_umask&#39;</span>]); <span class="comment">// see #ZF-320 (this line is required in some configurations)</span>
<a name="l00916"></a>00916             }
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920 
<a name="l00928"></a><a class="code" href="class_zend___cache___backend___file.html#ac50879defc45545458f20fb1c974153b">00928</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#ac50879defc45545458f20fb1c974153b">_test</a>($id, $doNotTestCacheValidity)
<a name="l00929"></a>00929     {
<a name="l00930"></a>00930         $metadatas = $this-&gt;<a class="code" href="class_zend___cache___backend___file.html#ae6126fb3d43a3dc7fa624727f7019924">_getMetadatas</a>($id);
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (!$metadatas) {
<a name="l00932"></a>00932             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934         <span class="keywordflow">if</span> ($doNotTestCacheValidity || (time() &lt;= $metadatas[<span class="stringliteral">&#39;expire&#39;</span>])) {
<a name="l00935"></a>00935             <span class="keywordflow">return</span> $metadatas[<span class="stringliteral">&#39;mtime&#39;</span>];
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00938"></a>00938     }
<a name="l00939"></a>00939 
<a name="l00946"></a><a class="code" href="class_zend___cache___backend___file.html#a27beef2aacc686abbce207150de04320">00946</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a27beef2aacc686abbce207150de04320">_fileGetContents</a>($file)
<a name="l00947"></a>00947     {
<a name="l00948"></a>00948         $result = <span class="keyword">false</span>;
<a name="l00949"></a>00949         <span class="keywordflow">if</span> (!is_file($file)) {
<a name="l00950"></a>00950             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952         $f = @fopen($file, <span class="stringliteral">&#39;rb&#39;</span>);
<a name="l00953"></a>00953         <span class="keywordflow">if</span> ($f) {
<a name="l00954"></a>00954             <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;file_locking&#39;</span>]) @flock($f, LOCK_SH);
<a name="l00955"></a>00955             $result = stream_get_contents($f);
<a name="l00956"></a>00956             <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;file_locking&#39;</span>]) @flock($f, LOCK_UN);
<a name="l00957"></a>00957             @fclose($f);
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959         <span class="keywordflow">return</span> $result;
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961 
<a name="l00969"></a><a class="code" href="class_zend___cache___backend___file.html#a3c8cdbad3bcd2b73458402fc181ea159">00969</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#a3c8cdbad3bcd2b73458402fc181ea159">_filePutContents</a>($file, $string)
<a name="l00970"></a>00970     {
<a name="l00971"></a>00971         $result = <span class="keyword">false</span>;
<a name="l00972"></a>00972         $f = @fopen($file, <span class="stringliteral">&#39;ab+&#39;</span>);
<a name="l00973"></a>00973         <span class="keywordflow">if</span> ($f) {
<a name="l00974"></a>00974             <span class="keywordflow">if</span> ($this-&gt;_options[<span class="stringliteral">&#39;file_locking&#39;</span>]) @flock($f, LOCK_EX);
<a name="l00975"></a>00975             fseek($f, 0);
<a name="l00976"></a>00976             ftruncate($f, 0);
<a name="l00977"></a>00977             $tmp = @fwrite($f, $string);
<a name="l00978"></a>00978             <span class="keywordflow">if</span> (!($tmp === FALSE)) {
<a name="l00979"></a>00979                 $result = <span class="keyword">true</span>;
<a name="l00980"></a>00980             }
<a name="l00981"></a>00981             @fclose($f);
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983         @chmod($file, $this-&gt;_options[<span class="stringliteral">&#39;cache_file_umask&#39;</span>]);
<a name="l00984"></a>00984         <span class="keywordflow">return</span> $result;
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986 
<a name="l00993"></a><a class="code" href="class_zend___cache___backend___file.html#aed8b65352bd25cffcf1417086183bc37">00993</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___cache___backend___file.html#aed8b65352bd25cffcf1417086183bc37">_fileNameToId</a>($fileName)
<a name="l00994"></a>00994     {
<a name="l00995"></a>00995         $prefix = $this-&gt;_options[<span class="stringliteral">&#39;file_name_prefix&#39;</span>];
<a name="l00996"></a>00996         <span class="keywordflow">return</span> preg_replace(<span class="stringliteral">&#39;~^&#39;</span> . $prefix . <span class="stringliteral">&#39;---(.*)$~&#39;</span>, <span class="stringliteral">&#39;$1&#39;</span>, $fileName);
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998 
<a name="l00999"></a>00999 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:15 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
