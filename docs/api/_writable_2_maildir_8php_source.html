<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Mail/Storage/Writable/Maildir.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/others/Zend/Mail/Storage/Writable/Maildir.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00027"></a>00027 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Folder/Maildir.php&#39;</span>;
<a name="l00028"></a>00028 
<a name="l00032"></a>00032 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Writable/Interface.php&#39;</span>;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00042"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html">00042</a> <span class="keyword">class </span><a class="code" href="class_zend___mail___storage___writable___maildir.html">Zend_Mail_Storage_Writable_Maildir</a> <span class="keyword">extends</span>    <a class="code" href="class_zend___mail___storage___folder___maildir.html">Zend_Mail_Storage_Folder_Maildir</a>
<a name="l00043"></a>00043                                          implements <a class="code" href="interface_zend___mail___storage___writable___interface.html">Zend_Mail_Storage_Writable_Interface</a>
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045     <span class="comment">// TODO: init maildir (+ constructor option create if not found)</span>
<a name="l00046"></a>00046 
<a name="l00051"></a>00051     <span class="keyword">protected</span> $_quota;
<a name="l00052"></a>00052 
<a name="l00062"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a6e2b9b2f1ec39e0b1ede8ea8c86f6f63">00062</a>     <span class="keyword">public</span> <span class="keyword">static</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a6e2b9b2f1ec39e0b1ede8ea8c86f6f63">initMaildir</a>($dir)
<a name="l00063"></a>00063     {
<a name="l00064"></a>00064         <span class="keywordflow">if</span> (file_exists($dir)) {
<a name="l00065"></a>00065             <span class="keywordflow">if</span> (!is_dir($dir)) {
<a name="l00069"></a>00069                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00070"></a>00070                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;maildir must be a directory if already exists&#39;</span>);
<a name="l00071"></a>00071             }
<a name="l00072"></a>00072         } <span class="keywordflow">else</span> {
<a name="l00073"></a>00073             <span class="keywordflow">if</span> (!mkdir($dir)) {
<a name="l00077"></a>00077                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00078"></a>00078                 $dir = dirname($dir);
<a name="l00079"></a>00079                 <span class="keywordflow">if</span> (!file_exists($dir)) {
<a name="l00080"></a>00080                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;parent $dir not found&quot;</span>);
<a name="l00081"></a>00081                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!is_dir($dir)) {
<a name="l00082"></a>00082                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;parent $dir not a directory&quot;</span>);
<a name="l00083"></a>00083                 } <span class="keywordflow">else</span> {
<a name="l00084"></a>00084                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot create maildir&#39;</span>);
<a name="l00085"></a>00085                 }
<a name="l00086"></a>00086             }
<a name="l00087"></a>00087         }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;cur&#39;</span>, <span class="stringliteral">&#39;tmp&#39;</span>, <span class="stringliteral">&#39;new&#39;</span>) as $subdir) {
<a name="l00090"></a>00090             <span class="keywordflow">if</span> (!@mkdir($dir . DIRECTORY_SEPARATOR . $subdir)) {
<a name="l00091"></a>00091                 <span class="comment">// ignore if dir exists (i.e. was already valid maildir or two processes try to create one)</span>
<a name="l00092"></a>00092                 <span class="keywordflow">if</span> (!file_exists($dir . DIRECTORY_SEPARATOR . $subdir)) {
<a name="l00096"></a>00096                     require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00097"></a>00097                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;could not create subdir &#39;</span> . $subdir);
<a name="l00098"></a>00098                 }
<a name="l00099"></a>00099             }
<a name="l00100"></a>00100         }
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00111"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a9162320adff1a1a4afd7f2372f753a3e">00111</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a9162320adff1a1a4afd7f2372f753a3e">__construct</a>($params) {
<a name="l00112"></a>00112         <span class="keywordflow">if</span> (is_array($params)) {
<a name="l00113"></a>00113             $params = (object)$params;
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="keywordflow">if</span> (!empty($params-&gt;create) &amp;&amp; isset($params-&gt;dirname) &amp;&amp; !file_exists($params-&gt;dirname . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span>)) {
<a name="l00117"></a>00117             <a class="code" href="class_zend___mail___storage___writable___maildir.html#a6e2b9b2f1ec39e0b1ede8ea8c86f6f63">self::initMaildir</a>($params-&gt;dirname);
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         <a class="code" href="class_zend___mail___storage___writable___maildir.html#a9162320adff1a1a4afd7f2372f753a3e">parent::__construct</a>($params);
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122 
<a name="l00134"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a6a7b46e549a41d5b85129b5e26e5d78f">00134</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a6a7b46e549a41d5b85129b5e26e5d78f">createFolder</a>($name, $parentFolder = null)
<a name="l00135"></a>00135     {
<a name="l00136"></a>00136         <span class="keywordflow">if</span> ($parentFolder instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>) {
<a name="l00137"></a>00137             $folder = $parentFolder-&gt;getGlobalName() . $this-&gt;_delim . $name;
<a name="l00138"></a>00138         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($parentFolder != null) {
<a name="l00139"></a>00139             $folder = rtrim($parentFolder, $this-&gt;_delim) . $this-&gt;_delim . $name;
<a name="l00140"></a>00140         } <span class="keywordflow">else</span> {
<a name="l00141"></a>00141             $folder = $name;
<a name="l00142"></a>00142         }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144         $folder = trim($folder, $this-&gt;_delim);
<a name="l00145"></a>00145 
<a name="l00146"></a>00146         <span class="comment">// first we check if we try to create a folder that does exist</span>
<a name="l00147"></a>00147         $exists = null;
<a name="l00148"></a>00148         <span class="keywordflow">try</span> {
<a name="l00149"></a>00149             $exists = $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($folder);
<a name="l00150"></a>00150         } <span class="keywordflow">catch</span> (<a class="code" href="class_zend___mail___exception.html">Zend_Mail_Exception</a> $e) {
<a name="l00151"></a>00151             <span class="comment">// ok</span>
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         <span class="keywordflow">if</span> ($exists) {
<a name="l00157"></a>00157             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00158"></a>00158             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;folder already exists&#39;</span>);
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="keywordflow">if</span> (strpos($folder, $this-&gt;_delim . $this-&gt;_delim) !== <span class="keyword">false</span>) {
<a name="l00165"></a>00165             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00166"></a>00166             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;invalid name - folder parts may not be empty&#39;</span>);
<a name="l00167"></a>00167         }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="keywordflow">if</span> (strpos($folder, <span class="stringliteral">&#39;INBOX&#39;</span> . $this-&gt;_delim) === 0) {
<a name="l00170"></a>00170             $folder = substr($folder, 6);
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         $fulldir = $this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $folder;
<a name="l00174"></a>00174 
<a name="l00175"></a>00175         <span class="comment">// check if we got tricked and would create a dir outside of the rootdir or not as direct child</span>
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (strpos($folder, DIRECTORY_SEPARATOR) !== <span class="keyword">false</span> || strpos($folder, <span class="charliteral">&#39;/&#39;</span>) !== <span class="keyword">false</span>
<a name="l00177"></a>00177             || dirname($fulldir) . DIRECTORY_SEPARATOR != $this-&gt;_rootdir) {
<a name="l00181"></a>00181             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00182"></a>00182             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;invalid name - no directory seprator allowed in folder name&#39;</span>);
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185         <span class="comment">// has a parent folder?</span>
<a name="l00186"></a>00186         $parent = null;
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (strpos($folder, $this-&gt;_delim)) {
<a name="l00188"></a>00188             <span class="comment">// let&#39;s see if the parent folder exists</span>
<a name="l00189"></a>00189             $parent = substr($folder, 0, strrpos($folder, $this-&gt;_delim));
<a name="l00190"></a>00190             <span class="keywordflow">try</span> {
<a name="l00191"></a>00191                 $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($parent);
<a name="l00192"></a>00192             } <span class="keywordflow">catch</span> (<a class="code" href="class_zend___mail___exception.html">Zend_Mail_Exception</a> $e) {
<a name="l00193"></a>00193                 <span class="comment">// does not - create parent folder</span>
<a name="l00194"></a>00194                 $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a6a7b46e549a41d5b85129b5e26e5d78f">createFolder</a>($parent);
<a name="l00195"></a>00195             }
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="keywordflow">if</span> (!@mkdir($fulldir) || !@mkdir($fulldir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span>)) {
<a name="l00202"></a>00202             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00203"></a>00203             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;error while creating new folder, may be created incompletly&#39;</span>);
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206         mkdir($fulldir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;new&#39;</span>);
<a name="l00207"></a>00207         mkdir($fulldir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;tmp&#39;</span>);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         $localName = $parent ? substr($folder, strlen($parent) + 1) : $folder;
<a name="l00210"></a>00210         $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($parent)-&gt;$localName = <span class="keyword">new</span> Zend_Mail_Storage_Folder($localName, $folder, <span class="keyword">true</span>);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="keywordflow">return</span> $fulldir;
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00222"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a83ba66d88511e1aaad03c049ae9e8e75">00222</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a83ba66d88511e1aaad03c049ae9e8e75">removeFolder</a>($name)
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224         <span class="comment">// TODO: This could fail in the middle of the task, which is not optimal.</span>
<a name="l00225"></a>00225         <span class="comment">// But there is no defined standard way to mark a folder as removed and there is no atomar fs-op</span>
<a name="l00226"></a>00226         <span class="comment">// to remove a directory. Also moving the folder to a/the trash folder is not possible, as</span>
<a name="l00227"></a>00227         <span class="comment">// all parent folders must be created. What we could do is add a dash to the front of the</span>
<a name="l00228"></a>00228         <span class="comment">// directory name and it should be ignored as long as other processes obey the standard.</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         <span class="keywordflow">if</span> ($name instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>) {
<a name="l00231"></a>00231             $name = $name-&gt;getGlobalName();
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         $name = trim($name, $this-&gt;_delim);
<a name="l00235"></a>00235         <span class="keywordflow">if</span> (strpos($name, <span class="stringliteral">&#39;INBOX&#39;</span> . $this-&gt;_delim) === 0) {
<a name="l00236"></a>00236             $name = substr($name, 6);
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="comment">// check if folder exists and has no children</span>
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (!$this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($name)-&gt;isLeaf()) {
<a name="l00244"></a>00244             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00245"></a>00245             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;delete children first&#39;</span>);
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <span class="keywordflow">if</span> ($name == <span class="stringliteral">&#39;INBOX&#39;</span> || $name == DIRECTORY_SEPARATOR || $name == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00252"></a>00252             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00253"></a>00253             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;wont delete INBOX&#39;</span>);
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="keywordflow">if</span> ($name == $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a11d856c85bcf54f7f5b4dd4779dcc2d7">getCurrentFolder</a>()) {
<a name="l00260"></a>00260             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00261"></a>00261             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;wont delete selected folder&#39;</span>);
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;tmp&#39;</span>, <span class="stringliteral">&#39;new&#39;</span>, <span class="stringliteral">&#39;cur&#39;</span>, <span class="charliteral">&#39;.&#39;</span>) as $subdir) {
<a name="l00265"></a>00265             $dir = $this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $name . DIRECTORY_SEPARATOR . $subdir;
<a name="l00266"></a>00266             <span class="keywordflow">if</span> (!file_exists($dir)) {
<a name="l00267"></a>00267                 <span class="keywordflow">continue</span>;
<a name="l00268"></a>00268             }
<a name="l00269"></a>00269             $dh = opendir($dir);
<a name="l00270"></a>00270             <span class="keywordflow">if</span> (!$dh) {
<a name="l00274"></a>00274                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00275"></a>00275                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;error opening $subdir&quot;</span>);
<a name="l00276"></a>00276             }
<a name="l00277"></a>00277             <span class="keywordflow">while</span> (($entry = readdir($dh)) !== <span class="keyword">false</span>) {
<a name="l00278"></a>00278                 <span class="keywordflow">if</span> ($entry == <span class="charliteral">&#39;.&#39;</span> || $entry == <span class="stringliteral">&#39;..&#39;</span>) {
<a name="l00279"></a>00279                     <span class="keywordflow">continue</span>;
<a name="l00280"></a>00280                 }
<a name="l00281"></a>00281                 <span class="keywordflow">if</span> (!unlink($dir . DIRECTORY_SEPARATOR . $entry)) {
<a name="l00285"></a>00285                     require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00286"></a>00286                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;error cleaning $subdir&quot;</span>);
<a name="l00287"></a>00287                 }
<a name="l00288"></a>00288             }
<a name="l00289"></a>00289             closedir($dh);
<a name="l00290"></a>00290             <span class="keywordflow">if</span> ($subdir !== <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00291"></a>00291                 <span class="keywordflow">if</span> (!rmdir($dir)) {
<a name="l00295"></a>00295                     require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00296"></a>00296                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;error removing $subdir&quot;</span>);
<a name="l00297"></a>00297                 }
<a name="l00298"></a>00298             }
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (!rmdir($this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $name)) {
<a name="l00302"></a>00302             <span class="comment">// at least we should try to make it a valid maildir again</span>
<a name="l00303"></a>00303             mkdir($this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $name . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span>);
<a name="l00307"></a>00307             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00308"></a>00308             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;error removing maindir&quot;</span>);
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         $parent = strpos($name, $this-&gt;_delim) ? substr($name, 0, strrpos($name, $this-&gt;_delim)) : null;
<a name="l00312"></a>00312         $localName = $parent ? substr($name, strlen($parent) + 1) : $name;
<a name="l00313"></a>00313         unset($this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($parent)-&gt;$localName);
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315 
<a name="l00326"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#ac5e5f0cd4c82fc707f3ff5abd20d9910">00326</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#ac5e5f0cd4c82fc707f3ff5abd20d9910">renameFolder</a>($oldName, $newName)
<a name="l00327"></a>00327     {
<a name="l00328"></a>00328         <span class="comment">// TODO: This is also not atomar and has similar problems as removeFolder()</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         <span class="keywordflow">if</span> ($oldName instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>) {
<a name="l00331"></a>00331             $oldName = $oldName-&gt;getGlobalName();
<a name="l00332"></a>00332         }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334         $oldName = trim($oldName, $this-&gt;_delim);
<a name="l00335"></a>00335         <span class="keywordflow">if</span> (strpos($oldName, <span class="stringliteral">&#39;INBOX&#39;</span> . $this-&gt;_delim) === 0) {
<a name="l00336"></a>00336             $oldName = substr($oldName, 6);
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         $newName = trim($newName, $this-&gt;_delim);
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (strpos($newName, <span class="stringliteral">&#39;INBOX&#39;</span> . $this-&gt;_delim) === 0) {
<a name="l00341"></a>00341             $newName = substr($newName, 6);
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         <span class="keywordflow">if</span> (strpos($newName, $oldName . $this-&gt;_delim) === 0) {
<a name="l00348"></a>00348             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00349"></a>00349             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;new folder cannot be a child of old folder&#39;</span>);
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">// check if folder exists and has no children</span>
<a name="l00353"></a>00353         $folder = $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($oldName);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="keywordflow">if</span> ($oldName == <span class="stringliteral">&#39;INBOX&#39;</span> || $oldName == DIRECTORY_SEPARATOR || $oldName == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00359"></a>00359             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00360"></a>00360             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;wont rename INBOX&#39;</span>);
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">if</span> ($oldName == $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a11d856c85bcf54f7f5b4dd4779dcc2d7">getCurrentFolder</a>()) {
<a name="l00367"></a>00367             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00368"></a>00368             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;wont rename selected folder&#39;</span>);
<a name="l00369"></a>00369         }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371         $newdir = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a6a7b46e549a41d5b85129b5e26e5d78f">createFolder</a>($newName);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="keywordflow">if</span> (!$folder-&gt;isLeaf()) {
<a name="l00374"></a>00374             <span class="keywordflow">foreach</span> ($folder as $k =&gt; $v) {
<a name="l00375"></a>00375                 $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#ac5e5f0cd4c82fc707f3ff5abd20d9910">renameFolder</a>($v-&gt;getGlobalName(), $newName . $this-&gt;_delim . $k);
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         $olddir = $this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $folder;
<a name="l00380"></a>00380         <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;tmp&#39;</span>, <span class="stringliteral">&#39;new&#39;</span>, <span class="stringliteral">&#39;cur&#39;</span>) as $subdir) {
<a name="l00381"></a>00381             $subdir = DIRECTORY_SEPARATOR . $subdir;
<a name="l00382"></a>00382             <span class="keywordflow">if</span> (!file_exists($olddir . $subdir)) {
<a name="l00383"></a>00383                 <span class="keywordflow">continue</span>;
<a name="l00384"></a>00384             }
<a name="l00385"></a>00385             <span class="comment">// using copy or moving files would be even better - but also much slower</span>
<a name="l00386"></a>00386             <span class="keywordflow">if</span> (!rename($olddir . $subdir, $newdir . $subdir)) {
<a name="l00390"></a>00390                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00391"></a>00391                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;error while moving &#39;</span> . $subdir);
<a name="l00392"></a>00392             }
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394         <span class="comment">// create a dummy if removing fails - otherwise we can&#39;t read it next time</span>
<a name="l00395"></a>00395         mkdir($olddir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span>);
<a name="l00396"></a>00396         $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a83ba66d88511e1aaad03c049ae9e8e75">removeFolder</a>($oldName);
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398 
<a name="l00412"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a2de06f6a9f111484eb74dae178965954">00412</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a2de06f6a9f111484eb74dae178965954">_createUniqueId</a>()
<a name="l00413"></a>00413     {
<a name="l00414"></a>00414         $id = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00415"></a>00415         $id .= function_exists(<span class="stringliteral">&#39;microtime&#39;</span>) ? microtime(<span class="keyword">true</span>) : (time() . <span class="charliteral">&#39; &#39;</span> . rand(0, 100000));
<a name="l00416"></a>00416         $id .= <span class="charliteral">&#39;.&#39;</span> . (function_exists(<span class="stringliteral">&#39;posix_getpid&#39;</span>) ? posix_getpid() : rand(50, 65535));
<a name="l00417"></a>00417         $id .= <span class="charliteral">&#39;.&#39;</span> . php_uname(<span class="charliteral">&#39;n&#39;</span>);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="keywordflow">return</span> $id;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421 
<a name="l00433"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">00433</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">_createTmpFile</a>($folder = <span class="stringliteral">&#39;INBOX&#39;</span>)
<a name="l00434"></a>00434     {
<a name="l00435"></a>00435         <span class="keywordflow">if</span> ($folder == <span class="stringliteral">&#39;INBOX&#39;</span>) {
<a name="l00436"></a>00436             $tmpdir = $this-&gt;_rootdir . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;tmp&#39;</span> . DIRECTORY_SEPARATOR;
<a name="l00437"></a>00437         } <span class="keywordflow">else</span> {
<a name="l00438"></a>00438             $tmpdir = $this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $folder . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;tmp&#39;</span> . DIRECTORY_SEPARATOR;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440         <span class="keywordflow">if</span> (!file_exists($tmpdir)) {
<a name="l00441"></a>00441             <span class="keywordflow">if</span> (!mkdir($tmpdir)) {
<a name="l00445"></a>00445                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00446"></a>00446                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;problems creating tmp dir&#39;</span>);
<a name="l00447"></a>00447             }
<a name="l00448"></a>00448         }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="comment">// we should retry to create a unique id if a file with the same name exists</span>
<a name="l00451"></a>00451         <span class="comment">// to avoid a script timeout we only wait 1 second (instead of 2) and stop</span>
<a name="l00452"></a>00452         <span class="comment">// after a defined retry count</span>
<a name="l00453"></a>00453         <span class="comment">// if you change this variable take into account that it can take up to $max_tries seconds</span>
<a name="l00454"></a>00454         <span class="comment">// normally we should have a valid unique name after the first try, we&#39;re just following the &quot;standard&quot; here</span>
<a name="l00455"></a>00455         $max_tries = 5;
<a name="l00456"></a>00456         <span class="keywordflow">for</span> ($i = 0; $i &lt; $max_tries; ++$i) {
<a name="l00457"></a>00457             $uniq = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a2de06f6a9f111484eb74dae178965954">_createUniqueId</a>();
<a name="l00458"></a>00458             <span class="keywordflow">if</span> (!file_exists($tmpdir . $uniq)) {
<a name="l00459"></a>00459                 <span class="comment">// here is the race condition! - as defined in the standard</span>
<a name="l00460"></a>00460                 <span class="comment">// to avoid having a long time between stat()ing the file and creating it we&#39;re opening it here</span>
<a name="l00461"></a>00461                 <span class="comment">// to mark the filename as taken</span>
<a name="l00462"></a>00462                 $fh = fopen($tmpdir . $uniq, <span class="charliteral">&#39;w&#39;</span>);
<a name="l00463"></a>00463                 <span class="keywordflow">if</span> (!$fh) {
<a name="l00467"></a>00467                     require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00468"></a>00468                     <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;could not open temp file&#39;</span>);
<a name="l00469"></a>00469                 }
<a name="l00470"></a>00470                 <span class="keywordflow">break</span>;
<a name="l00471"></a>00471             }
<a name="l00472"></a>00472             sleep(1);
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475         <span class="keywordflow">if</span> (!$fh) {
<a name="l00479"></a>00479             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00480"></a>00480             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&quot;tried $max_tries unique ids for a temp file, but all were taken&quot;</span>
<a name="l00481"></a>00481                                                 . <span class="stringliteral">&#39; - giving up&#39;</span>);
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;dirname&#39;</span> =&gt; $this-&gt;_rootdir . <span class="charliteral">&#39;.&#39;</span> . $folder, <span class="stringliteral">&#39;uniq&#39;</span> =&gt; $uniq, <span class="stringliteral">&#39;filename&#39;</span> =&gt; $tmpdir . $uniq,
<a name="l00485"></a>00485                      <span class="stringliteral">&#39;handle&#39;</span> =&gt; $fh);
<a name="l00486"></a>00486     }
<a name="l00487"></a>00487 
<a name="l00495"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">00495</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">_getInfoString</a>(&amp;$flags)
<a name="l00496"></a>00496     {
<a name="l00497"></a>00497         <span class="comment">// accessing keys is easier, faster and it removes duplicated flags</span>
<a name="l00498"></a>00498         $wanted_flags = array_flip($flags);
<a name="l00499"></a>00499         <span class="keywordflow">if</span> (isset($wanted_flags[Zend_Mail_Storage::FLAG_RECENT])) {
<a name="l00503"></a>00503             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00504"></a>00504             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;recent flag may not be set&#39;</span>);
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         $info = <span class="stringliteral">&#39;:2,&#39;</span>;
<a name="l00508"></a>00508         $flags = array();
<a name="l00509"></a>00509         <span class="keywordflow">foreach</span> (Zend_Mail_Storage_Maildir::$_knownFlags as $char =&gt; $flag) {
<a name="l00510"></a>00510             <span class="keywordflow">if</span> (!isset($wanted_flags[$flag])) {
<a name="l00511"></a>00511                 <span class="keywordflow">continue</span>;
<a name="l00512"></a>00512             }
<a name="l00513"></a>00513             $info .= $char;
<a name="l00514"></a>00514             $flags[$char] = $flag;
<a name="l00515"></a>00515             unset($wanted_flags[$flag]);
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518         <span class="keywordflow">if</span> (!empty($wanted_flags)) {
<a name="l00519"></a>00519             $wanted_flags = implode(<span class="stringliteral">&#39;, &#39;</span>, array_keys($wanted_flags));
<a name="l00523"></a>00523             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00524"></a>00524             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;unknown flag(s): &#39;</span> . $wanted_flags);
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordflow">return</span> $info;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00540"></a>00540      <span class="comment">// not yet * @param string|Zend_Mail_Message|Zend_Mime_Message $message message as string or instance of message class</span>
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a7d339befef6f6df545a5db22b817203e">00542</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a7d339befef6f6df545a5db22b817203e">appendMessage</a>($message, $folder = null, $flags = null, $recent = <span class="keyword">false</span>)
<a name="l00543"></a>00543     {
<a name="l00544"></a>00544         <span class="keywordflow">if</span> ($this-&gt;_quota &amp;&amp; $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a044924171dabec43ea3c23a33940f927">checkQuota</a>()) {
<a name="l00548"></a>00548             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00549"></a>00549             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;storage is over quota!&#39;</span>);
<a name="l00550"></a>00550         }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="keywordflow">if</span> ($folder === null) {
<a name="l00553"></a>00553             $folder = $this-&gt;_currentFolder;
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556         <span class="keywordflow">if</span> (!($folder instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>)) {
<a name="l00557"></a>00557             $folder = $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($folder);
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">if</span> ($flags === null) {
<a name="l00561"></a>00561             $flags = array(Zend_Mail_Storage::FLAG_SEEN);
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         $info = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">_getInfoString</a>($flags);
<a name="l00564"></a>00564         $temp_file = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">_createTmpFile</a>($folder-&gt;getGlobalName());
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="comment">// TODO: handle class instances for $message</span>
<a name="l00567"></a>00567         <span class="keywordflow">if</span> (is_resource($message) &amp;&amp; get_resource_type($message) == <span class="stringliteral">&#39;stream&#39;</span>) {
<a name="l00568"></a>00568             stream_copy_to_stream($message, $temp_file[<span class="stringliteral">&#39;handle&#39;</span>]);
<a name="l00569"></a>00569         } <span class="keywordflow">else</span> {
<a name="l00570"></a>00570             fputs($temp_file[<span class="stringliteral">&#39;handle&#39;</span>], $message);
<a name="l00571"></a>00571         }
<a name="l00572"></a>00572         fclose($temp_file[<span class="stringliteral">&#39;handle&#39;</span>]);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         <span class="comment">// we&#39;re adding the size to the filename for maildir++</span>
<a name="l00575"></a>00575         $size = filesize($temp_file[<span class="stringliteral">&#39;filename&#39;</span>]);
<a name="l00576"></a>00576         <span class="keywordflow">if</span> ($size !== <span class="keyword">false</span>) {
<a name="l00577"></a>00577             $info = <span class="stringliteral">&#39;,S=&#39;</span> . $size . $info;
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579         $new_filename = $temp_file[<span class="stringliteral">&#39;dirname&#39;</span>] . DIRECTORY_SEPARATOR;
<a name="l00580"></a>00580         $new_filename .= $recent ? <span class="stringliteral">&#39;new&#39;</span> : <span class="stringliteral">&#39;cur&#39;</span>;
<a name="l00581"></a>00581         $new_filename .= DIRECTORY_SEPARATOR . $temp_file[<span class="stringliteral">&#39;uniq&#39;</span>] . $info;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         <span class="comment">// we&#39;re throwing any exception after removing our temp file and saving it to this variable instead</span>
<a name="l00584"></a>00584         $exception = null;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (!link($temp_file[<span class="stringliteral">&#39;filename&#39;</span>], $new_filename)) {
<a name="l00590"></a>00590             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00591"></a>00591             $exception = <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot link message file to final dir&#39;</span>);
<a name="l00592"></a>00592         }
<a name="l00593"></a>00593         @unlink($temp_file[<span class="stringliteral">&#39;filename&#39;</span>]);
<a name="l00594"></a>00594 
<a name="l00595"></a>00595         <span class="keywordflow">if</span> ($exception) {
<a name="l00596"></a>00596             <span class="keywordflow">throw</span> $exception;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         $this-&gt;_files[] = array(<span class="stringliteral">&#39;uniq&#39;</span>     =&gt; $temp_file[<span class="stringliteral">&#39;uniq&#39;</span>],
<a name="l00600"></a>00600                                 <span class="stringliteral">&#39;flags&#39;</span>    =&gt; $flags,
<a name="l00601"></a>00601                                 <span class="stringliteral">&#39;filename&#39;</span> =&gt; $new_filename);
<a name="l00602"></a>00602         <span class="keywordflow">if</span> ($this-&gt;_quota) {
<a name="l00603"></a>00603             $this-&gt;_addQuotaEntry((<span class="keywordtype">int</span>)$size, 1);
<a name="l00604"></a>00604         }
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606 
<a name="l00615"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a6552f112bcd1f8c379d10a58c020575f">00615</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a6552f112bcd1f8c379d10a58c020575f">copyMessage</a>($id, $folder)
<a name="l00616"></a>00616     {
<a name="l00617"></a>00617         <span class="keywordflow">if</span> ($this-&gt;_quota &amp;&amp; $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a044924171dabec43ea3c23a33940f927">checkQuota</a>()) {
<a name="l00621"></a>00621             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00622"></a>00622             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;storage is over quota!&#39;</span>);
<a name="l00623"></a>00623         }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (!($folder instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>)) {
<a name="l00626"></a>00626             $folder = $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($folder);
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         $filedata = $this-&gt;<a class="code" href="class_zend___mail___storage___maildir.html#ad4d3bda2ce188994c4d7216d2c40283e">_getFileData</a>($id);
<a name="l00630"></a>00630         $old_file = $filedata[<span class="stringliteral">&#39;filename&#39;</span>];
<a name="l00631"></a>00631         $flags = $filedata[<span class="stringliteral">&#39;flags&#39;</span>];
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">// copied message can&#39;t be recent</span>
<a name="l00634"></a>00634         <span class="keywordflow">while</span> (($key = array_search(Zend_Mail_Storage::FLAG_RECENT, $flags)) !== <span class="keyword">false</span>) {
<a name="l00635"></a>00635             unset($flags[$key]);
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637         $info = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">_getInfoString</a>($flags);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <span class="comment">// we&#39;re creating the copy as temp file before moving to cur/</span>
<a name="l00640"></a>00640         $temp_file = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">_createTmpFile</a>($folder-&gt;getGlobalName());
<a name="l00641"></a>00641         <span class="comment">// we don&#39;t write directly to the file</span>
<a name="l00642"></a>00642         fclose($temp_file[<span class="stringliteral">&#39;handle&#39;</span>]);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644         <span class="comment">// we&#39;re adding the size to the filename for maildir++</span>
<a name="l00645"></a>00645         $size = filesize($old_file);
<a name="l00646"></a>00646         <span class="keywordflow">if</span> ($size !== <span class="keyword">false</span>) {
<a name="l00647"></a>00647             $info = <span class="stringliteral">&#39;,S=&#39;</span> . $size . $info;
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         $new_file = $temp_file[<span class="stringliteral">&#39;dirname&#39;</span>] . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span> . DIRECTORY_SEPARATOR . $temp_file[<span class="stringliteral">&#39;uniq&#39;</span>] . $info;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="comment">// we&#39;re throwing any exception after removing our temp file and saving it to this variable instead</span>
<a name="l00653"></a>00653         $exception = null;
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (!copy($old_file, $temp_file[<span class="stringliteral">&#39;filename&#39;</span>])) {
<a name="l00659"></a>00659             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00660"></a>00660             $exception = <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot copy message file&#39;</span>);
<a name="l00661"></a>00661         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!link($temp_file[<span class="stringliteral">&#39;filename&#39;</span>], $new_file)) {
<a name="l00665"></a>00665             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00666"></a>00666             $exception = <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot link message file to final dir&#39;</span>);
<a name="l00667"></a>00667         }
<a name="l00668"></a>00668         @unlink($temp_file[<span class="stringliteral">&#39;filename&#39;</span>]);
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         <span class="keywordflow">if</span> ($exception) {
<a name="l00671"></a>00671             <span class="keywordflow">throw</span> $exception;
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         <span class="keywordflow">if</span> ($folder-&gt;getGlobalName() == $this-&gt;_currentFolder
<a name="l00675"></a>00675             || ($this-&gt;_currentFolder == <span class="stringliteral">&#39;INBOX&#39;</span> &amp;&amp; $folder-&gt;getGlobalName() == <span class="charliteral">&#39;/&#39;</span>)) {
<a name="l00676"></a>00676             $this-&gt;_files[] = array(<span class="stringliteral">&#39;uniq&#39;</span>     =&gt; $temp_file[<span class="stringliteral">&#39;uniq&#39;</span>],
<a name="l00677"></a>00677                                     <span class="stringliteral">&#39;flags&#39;</span>    =&gt; $flags,
<a name="l00678"></a>00678                                     <span class="stringliteral">&#39;filename&#39;</span> =&gt; $new_file);
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         <span class="keywordflow">if</span> ($this-&gt;_quota) {
<a name="l00682"></a>00682             $this-&gt;_addQuotaEntry((<span class="keywordtype">int</span>)$size, 1);
<a name="l00683"></a>00683         }
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 
<a name="l00694"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a51c2c71aa4218dc4438e415ffde1bf50">00694</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a51c2c71aa4218dc4438e415ffde1bf50">moveMessage</a>($id, $folder) {
<a name="l00695"></a>00695         <span class="keywordflow">if</span> (!($folder instanceof <a class="code" href="class_zend___mail___storage___folder.html">Zend_Mail_Storage_Folder</a>)) {
<a name="l00696"></a>00696             $folder = $this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>($folder);
<a name="l00697"></a>00697         }
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <span class="keywordflow">if</span> ($folder-&gt;getGlobalName() == $this-&gt;_currentFolder
<a name="l00700"></a>00700             || ($this-&gt;_currentFolder == <span class="stringliteral">&#39;INBOX&#39;</span> &amp;&amp; $folder-&gt;getGlobalName() == <span class="charliteral">&#39;/&#39;</span>)) {
<a name="l00704"></a>00704             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00705"></a>00705             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;target is current folder&#39;</span>);
<a name="l00706"></a>00706         }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         $filedata = $this-&gt;<a class="code" href="class_zend___mail___storage___maildir.html#ad4d3bda2ce188994c4d7216d2c40283e">_getFileData</a>($id);
<a name="l00709"></a>00709         $old_file = $filedata[<span class="stringliteral">&#39;filename&#39;</span>];
<a name="l00710"></a>00710         $flags = $filedata[<span class="stringliteral">&#39;flags&#39;</span>];
<a name="l00711"></a>00711 
<a name="l00712"></a>00712         <span class="comment">// moved message can&#39;t be recent</span>
<a name="l00713"></a>00713         <span class="keywordflow">while</span> (($key = array_search(Zend_Mail_Storage::FLAG_RECENT, $flags)) !== <span class="keyword">false</span>) {
<a name="l00714"></a>00714             unset($flags[$key]);
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716         $info = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">_getInfoString</a>($flags);
<a name="l00717"></a>00717 
<a name="l00718"></a>00718         <span class="comment">// reserving a new name</span>
<a name="l00719"></a>00719         $temp_file = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">_createTmpFile</a>($folder-&gt;getGlobalName());
<a name="l00720"></a>00720         fclose($temp_file[<span class="stringliteral">&#39;handle&#39;</span>]);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <span class="comment">// we&#39;re adding the size to the filename for maildir++</span>
<a name="l00723"></a>00723         $size = filesize($old_file);
<a name="l00724"></a>00724         <span class="keywordflow">if</span> ($size !== <span class="keyword">false</span>) {
<a name="l00725"></a>00725             $info = <span class="stringliteral">&#39;,S=&#39;</span> . $size . $info;
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         $new_file = $temp_file[<span class="stringliteral">&#39;dirname&#39;</span>] . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span> . DIRECTORY_SEPARATOR . $temp_file[<span class="stringliteral">&#39;uniq&#39;</span>] . $info;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         <span class="comment">// we&#39;re throwing any exception after removing our temp file and saving it to this variable instead</span>
<a name="l00731"></a>00731         $exception = null;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <span class="keywordflow">if</span> (!rename($old_file, $new_file)) {
<a name="l00737"></a>00737             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00738"></a>00738             $exception = <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot move message file&#39;</span>);
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740         @unlink($temp_file[<span class="stringliteral">&#39;filename&#39;</span>]);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742         <span class="keywordflow">if</span> ($exception) {
<a name="l00743"></a>00743             <span class="keywordflow">throw</span> $exception;
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746         unset($this-&gt;_files[$id - 1]);
<a name="l00747"></a>00747         <span class="comment">// remove the gap</span>
<a name="l00748"></a>00748         $this-&gt;_files = array_values($this-&gt;_files);
<a name="l00749"></a>00749     }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751 
<a name="l00761"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#ad6d27674edc1f8b1072d1bededc93cfb">00761</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#ad6d27674edc1f8b1072d1bededc93cfb">setFlags</a>($id, $flags)
<a name="l00762"></a>00762     {
<a name="l00763"></a>00763         $info = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a957d920b01f7e098dfc05ba9b01029b2">_getInfoString</a>($flags);
<a name="l00764"></a>00764         $filedata = $this-&gt;<a class="code" href="class_zend___mail___storage___maildir.html#ad4d3bda2ce188994c4d7216d2c40283e">_getFileData</a>($id);
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         <span class="comment">// NOTE: double dirname to make sure we always move to cur. if recent flag has been set (message is in new) it will be moved to cur.</span>
<a name="l00767"></a>00767         $new_filename = dirname(dirname($filedata[<span class="stringliteral">&#39;filename&#39;</span>])) . DIRECTORY_SEPARATOR . <span class="stringliteral">&#39;cur&#39;</span> . DIRECTORY_SEPARATOR . <span class="stringliteral">&quot;$filedata[uniq]$info&quot;</span>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (!@rename($filedata[<span class="stringliteral">&#39;filename&#39;</span>], $new_filename)) {
<a name="l00773"></a>00773             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00774"></a>00774             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot rename file&#39;</span>);
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         $filedata[<span class="stringliteral">&#39;flags&#39;</span>]    = $flags;
<a name="l00778"></a>00778         $filedata[<span class="stringliteral">&#39;filename&#39;</span>] = $new_filename;
<a name="l00779"></a>00779 
<a name="l00780"></a>00780         $this-&gt;_files[$id - 1] = $filedata;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 
<a name="l00790"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#ae0124a1a7eb88dee437cdde75692d06c">00790</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#ae0124a1a7eb88dee437cdde75692d06c">removeMessage</a>($id)
<a name="l00791"></a>00791     {
<a name="l00792"></a>00792         $filename = $this-&gt;<a class="code" href="class_zend___mail___storage___maildir.html#ad4d3bda2ce188994c4d7216d2c40283e">_getFileData</a>($id, <span class="stringliteral">&#39;filename&#39;</span>);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794         <span class="keywordflow">if</span> ($this-&gt;_quota) {
<a name="l00795"></a>00795             $size = filesize($filename);
<a name="l00796"></a>00796         }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (!@unlink($filename)) {
<a name="l00802"></a>00802             require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00803"></a>00803             <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot remove message&#39;</span>);
<a name="l00804"></a>00804         }
<a name="l00805"></a>00805         unset($this-&gt;_files[$id - 1]);
<a name="l00806"></a>00806         <span class="comment">// remove the gap</span>
<a name="l00807"></a>00807         $this-&gt;_files = array_values($this-&gt;_files);
<a name="l00808"></a>00808         <span class="keywordflow">if</span> ($this-&gt;_quota) {
<a name="l00809"></a>00809             $this-&gt;_addQuotaEntry(0 - (<span class="keywordtype">int</span>)$size, -1);
<a name="l00810"></a>00810         }
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812 
<a name="l00824"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#ae8145d59a378d3a92852f6ba36c2d1b0">00824</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#ae8145d59a378d3a92852f6ba36c2d1b0">setQuota</a>($value) {
<a name="l00825"></a>00825         $this-&gt;_quota = $value;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827 
<a name="l00835"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a77e0c37b8c4fdab8a08f3bebae070e05">00835</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a77e0c37b8c4fdab8a08f3bebae070e05">getQuota</a>($fromStorage = <span class="keyword">false</span>) {
<a name="l00836"></a>00836         <span class="keywordflow">if</span> ($fromStorage) {
<a name="l00837"></a>00837             $fh = @fopen($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>, <span class="charliteral">&#39;r&#39;</span>);
<a name="l00838"></a>00838             <span class="keywordflow">if</span> (!$fh) {
<a name="l00842"></a>00842                 require_once <span class="stringliteral">&#39;Zend/Mail/Storage/Exception.php&#39;</span>;
<a name="l00843"></a>00843                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;cannot open maildirsize&#39;</span>);
<a name="l00844"></a>00844             }
<a name="l00845"></a>00845             $definition = fgets($fh);
<a name="l00846"></a>00846             fclose($fh);
<a name="l00847"></a>00847             $definition = explode(<span class="charliteral">&#39;,&#39;</span>, trim($definition));
<a name="l00848"></a>00848             $quota = array();
<a name="l00849"></a>00849             <span class="keywordflow">foreach</span> ($definition as $member) {
<a name="l00850"></a>00850                 $key = $member[strlen($member) - 1];
<a name="l00851"></a>00851                 <span class="keywordflow">if</span> ($key == <span class="charliteral">&#39;S&#39;</span> || $key == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l00852"></a>00852                     $key = $key == <span class="charliteral">&#39;C&#39;</span> ? <span class="stringliteral">&#39;count&#39;</span> : <span class="stringliteral">&#39;size&#39;</span>;
<a name="l00853"></a>00853                 }
<a name="l00854"></a>00854                 $quota[$key] = substr($member, 0, -1);
<a name="l00855"></a>00855             }
<a name="l00856"></a>00856             <span class="keywordflow">return</span> $quota;
<a name="l00857"></a>00857         }
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="keywordflow">return</span> $this-&gt;_quota;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861 
<a name="l00865"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a2477b65daff71af2bf3013903b53a908">00865</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a2477b65daff71af2bf3013903b53a908">_calculateMaildirsize</a>() {
<a name="l00866"></a>00866         $timestamps = array();
<a name="l00867"></a>00867         $messages = 0;
<a name="l00868"></a>00868         $total_size = 0;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (is_array($this-&gt;_quota)) {
<a name="l00871"></a>00871             $quota = $this-&gt;_quota;
<a name="l00872"></a>00872         } <span class="keywordflow">else</span> {
<a name="l00873"></a>00873             <span class="keywordflow">try</span> {
<a name="l00874"></a>00874                 $quota = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a77e0c37b8c4fdab8a08f3bebae070e05">getQuota</a>(<span class="keyword">true</span>);
<a name="l00875"></a>00875             } <span class="keywordflow">catch</span> (<a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a> $e) {
<a name="l00876"></a>00876                 <span class="keywordflow">throw</span> <span class="keyword">new</span> <a class="code" href="class_zend___mail___storage___exception.html">Zend_Mail_Storage_Exception</a>(<span class="stringliteral">&#39;no quota defintion found&#39;</span>);
<a name="l00877"></a>00877             }
<a name="l00878"></a>00878         }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         $folders = <span class="keyword">new</span> RecursiveIteratorIterator($this-&gt;<a class="code" href="class_zend___mail___storage___folder___maildir.html#a2fff03ee7acae699bffca0b3eecb3089">getFolders</a>(), RecursiveIteratorIterator::SELF_FIRST);
<a name="l00881"></a>00881         <span class="keywordflow">foreach</span> ($folders as $folder) {
<a name="l00882"></a>00882             $subdir = $folder-&gt;getGlobalName();
<a name="l00883"></a>00883             <span class="keywordflow">if</span> ($subdir == <span class="stringliteral">&#39;INBOX&#39;</span>) {
<a name="l00884"></a>00884                 $subdir = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00885"></a>00885             } <span class="keywordflow">else</span> {
<a name="l00886"></a>00886                 $subdir = <span class="charliteral">&#39;.&#39;</span> . $subdir;
<a name="l00887"></a>00887             }
<a name="l00888"></a>00888             <span class="keywordflow">if</span> ($subdir == <span class="stringliteral">&#39;Trash&#39;</span>) {
<a name="l00889"></a>00889                 <span class="keywordflow">continue</span>;
<a name="l00890"></a>00890             }
<a name="l00891"></a>00891 
<a name="l00892"></a>00892             <span class="keywordflow">foreach</span> (array(<span class="stringliteral">&#39;cur&#39;</span>, <span class="stringliteral">&#39;new&#39;</span>) as $subsubdir) {
<a name="l00893"></a>00893                 $dirname = $this-&gt;_rootdir . $subdir . DIRECTORY_SEPARATOR . $subsubdir . DIRECTORY_SEPARATOR;
<a name="l00894"></a>00894                 <span class="keywordflow">if</span> (!file_exists($dirname)) {
<a name="l00895"></a>00895                     <span class="keywordflow">continue</span>;
<a name="l00896"></a>00896                 }
<a name="l00897"></a>00897                 <span class="comment">// NOTE: we are using mtime instead of &quot;the latest timestamp&quot;. The latest would be atime</span>
<a name="l00898"></a>00898                 <span class="comment">// and as we are accessing the directory it would make the whole calculation useless.</span>
<a name="l00899"></a>00899                 $timestamps[$dirname] = filemtime($dirname);
<a name="l00900"></a>00900 
<a name="l00901"></a>00901                 $dh = opendir($dirname);
<a name="l00902"></a>00902                 <span class="comment">// NOTE: Should have been checked in constructor. Not throwing an exception here, quotas will</span>
<a name="l00903"></a>00903                 <span class="comment">// therefore not be fully enforeced, but next request will fail anyway, if problem persists.</span>
<a name="l00904"></a>00904                 <span class="keywordflow">if</span> (!$dh) {
<a name="l00905"></a>00905                     <span class="keywordflow">continue</span>;
<a name="l00906"></a>00906                 }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 
<a name="l00909"></a>00909                 <span class="keywordflow">while</span> (($entry = readdir()) !== <span class="keyword">false</span>) {
<a name="l00910"></a>00910                     <span class="keywordflow">if</span> ($entry[0] == <span class="charliteral">&#39;.&#39;</span> || !is_file($dirname . $entry)) {
<a name="l00911"></a>00911                         <span class="keywordflow">continue</span>;
<a name="l00912"></a>00912                     }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914                     <span class="keywordflow">if</span> (strpos($entry, <span class="stringliteral">&#39;,S=&#39;</span>)) {
<a name="l00915"></a>00915                         strtok($entry, <span class="charliteral">&#39;=&#39;</span>);
<a name="l00916"></a>00916                         $filesize = strtok(<span class="charliteral">&#39;:&#39;</span>);
<a name="l00917"></a>00917                         <span class="keywordflow">if</span> (is_numeric($filesize)) {
<a name="l00918"></a>00918                             $total_size += $filesize;
<a name="l00919"></a>00919                             ++$messages;
<a name="l00920"></a>00920                             <span class="keywordflow">continue</span>;
<a name="l00921"></a>00921                         }
<a name="l00922"></a>00922                     }
<a name="l00923"></a>00923                     $size = filesize($dirname . $entry);
<a name="l00924"></a>00924                     <span class="keywordflow">if</span> ($size === <span class="keyword">false</span>) {
<a name="l00925"></a>00925                         <span class="comment">// ignore, as we assume file got removed</span>
<a name="l00926"></a>00926                         <span class="keywordflow">continue</span>;
<a name="l00927"></a>00927                     }
<a name="l00928"></a>00928                     $total_size += $size;
<a name="l00929"></a>00929                     ++$messages;
<a name="l00930"></a>00930                 }
<a name="l00931"></a>00931             }
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934         $tmp = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a9fce9bec180895e1b2905b52d4c35add">_createTmpFile</a>();
<a name="l00935"></a>00935         $fh = $tmp[<span class="stringliteral">&#39;handle&#39;</span>];
<a name="l00936"></a>00936         $definition = array();
<a name="l00937"></a>00937         <span class="keywordflow">foreach</span> ($quota as $type =&gt; $value) {
<a name="l00938"></a>00938             <span class="keywordflow">if</span> ($type == <span class="stringliteral">&#39;size&#39;</span> || $type == <span class="stringliteral">&#39;count&#39;</span>) {
<a name="l00939"></a>00939                 $type = $type == <span class="stringliteral">&#39;count&#39;</span> ? <span class="charliteral">&#39;C&#39;</span> : <span class="charliteral">&#39;S&#39;</span>;
<a name="l00940"></a>00940             }
<a name="l00941"></a>00941             $definition[] = $value . $type;
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943         $definition = implode(<span class="charliteral">&#39;,&#39;</span>, $definition);
<a name="l00944"></a>00944         fputs($fh, <span class="stringliteral">&quot;$definition\n&quot;</span>);
<a name="l00945"></a>00945         fputs($fh, <span class="stringliteral">&quot;$total_size $messages\n&quot;</span>);
<a name="l00946"></a>00946         fclose($fh);
<a name="l00947"></a>00947         rename($tmp[<span class="stringliteral">&#39;filename&#39;</span>], $this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>);
<a name="l00948"></a>00948         <span class="keywordflow">foreach</span> ($timestamps as $dir =&gt; $timestamp) {
<a name="l00949"></a>00949             <span class="keywordflow">if</span> ($timestamp &lt; filemtime($dir)) {
<a name="l00950"></a>00950                 unlink($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>);
<a name="l00951"></a>00951                 <span class="keywordflow">break</span>;
<a name="l00952"></a>00952             }
<a name="l00953"></a>00953         }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;size&#39;</span> =&gt; $total_size, <span class="stringliteral">&#39;count&#39;</span> =&gt; $messages, <span class="stringliteral">&#39;quota&#39;</span> =&gt; $quota);
<a name="l00956"></a>00956     }
<a name="l00957"></a>00957 
<a name="l00961"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#ae2b6403ef9d92fba723903f057694137">00961</a>     <span class="keyword">protected</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#ae2b6403ef9d92fba723903f057694137">_calculateQuota</a>($forceRecalc = <span class="keyword">false</span>) {
<a name="l00962"></a>00962         $fh = null;
<a name="l00963"></a>00963         $total_size = 0;
<a name="l00964"></a>00964         $messages   = 0;
<a name="l00965"></a>00965         $maildirsize = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00966"></a>00966         <span class="keywordflow">if</span> (!$forceRecalc &amp;&amp; file_exists($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>) &amp;&amp; filesize($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>) &lt; 5120) {
<a name="l00967"></a>00967             $fh = fopen($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>, <span class="charliteral">&#39;r&#39;</span>);
<a name="l00968"></a>00968         }
<a name="l00969"></a>00969         <span class="keywordflow">if</span> ($fh) {
<a name="l00970"></a>00970             $maildirsize = fread($fh, 5120);
<a name="l00971"></a>00971             <span class="keywordflow">if</span> (strlen($maildirsize) &gt;= 5120) {
<a name="l00972"></a>00972                 fclose($fh);
<a name="l00973"></a>00973                 $fh = null;
<a name="l00974"></a>00974                 $maildirsize = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00975"></a>00975             }
<a name="l00976"></a>00976         }
<a name="l00977"></a>00977         <span class="keywordflow">if</span> (!$fh) {
<a name="l00978"></a>00978             $result = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a2477b65daff71af2bf3013903b53a908">_calculateMaildirsize</a>();
<a name="l00979"></a>00979             $total_size = $result[<span class="stringliteral">&#39;size&#39;</span>];
<a name="l00980"></a>00980             $messages   = $result[<span class="stringliteral">&#39;count&#39;</span>];
<a name="l00981"></a>00981             $quota      = $result[<span class="stringliteral">&#39;quota&#39;</span>];
<a name="l00982"></a>00982         } <span class="keywordflow">else</span> {
<a name="l00983"></a>00983             $maildirsize = explode(<span class="stringliteral">&quot;\n&quot;</span>, $maildirsize);
<a name="l00984"></a>00984             <span class="keywordflow">if</span> (is_array($this-&gt;_quota)) {
<a name="l00985"></a>00985                 $quota = $this-&gt;_quota;
<a name="l00986"></a>00986             } <span class="keywordflow">else</span> {
<a name="l00987"></a>00987                 $definition = explode(<span class="charliteral">&#39;,&#39;</span>, $maildirsize[0]);
<a name="l00988"></a>00988                 $quota = array();
<a name="l00989"></a>00989                 <span class="keywordflow">foreach</span> ($definition as $member) {
<a name="l00990"></a>00990                     $key = $member[strlen($member) - 1];
<a name="l00991"></a>00991                     <span class="keywordflow">if</span> ($key == <span class="charliteral">&#39;S&#39;</span> || $key == <span class="charliteral">&#39;C&#39;</span>) {
<a name="l00992"></a>00992                         $key = $key == <span class="charliteral">&#39;C&#39;</span> ? <span class="stringliteral">&#39;count&#39;</span> : <span class="stringliteral">&#39;size&#39;</span>;
<a name="l00993"></a>00993                     }
<a name="l00994"></a>00994                     $quota[$key] = substr($member, 0, -1);
<a name="l00995"></a>00995                 }
<a name="l00996"></a>00996             }
<a name="l00997"></a>00997             unset($maildirsize[0]);
<a name="l00998"></a>00998             <span class="keywordflow">foreach</span> ($maildirsize as $line) {
<a name="l00999"></a>00999                 list($size, $count) = explode(<span class="charliteral">&#39; &#39;</span>, trim($line));
<a name="l01000"></a>01000                 $total_size += $size;
<a name="l01001"></a>01001                 $messages   += $count;
<a name="l01002"></a>01002             }
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         $over_quota = <span class="keyword">false</span>;
<a name="l01006"></a>01006         $over_quota = $over_quota || (isset($quota[<span class="stringliteral">&#39;size&#39;</span>])  &amp;&amp; $total_size &gt; $quota[<span class="stringliteral">&#39;size&#39;</span>]);
<a name="l01007"></a>01007         $over_quota = $over_quota || (isset($quota[<span class="stringliteral">&#39;count&#39;</span>]) &amp;&amp; $messages   &gt; $quota[<span class="stringliteral">&#39;count&#39;</span>]);
<a name="l01008"></a>01008         <span class="comment">// NOTE: $maildirsize equals false if it wasn&#39;t set (AKA we recalculated) or it&#39;s only</span>
<a name="l01009"></a>01009         <span class="comment">// one line, because $maildirsize[0] gets unsetted.</span>
<a name="l01010"></a>01010         <span class="comment">// Also we&#39;re using local time to calculate the 15 minute offset. Touching a file just for known the</span>
<a name="l01011"></a>01011         <span class="comment">// local time of the file storage isn&#39;t worth the hassle.</span>
<a name="l01012"></a>01012         <span class="keywordflow">if</span> ($over_quota &amp;&amp; ($maildirsize || filemtime($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>) &gt; time() - 900)) {
<a name="l01013"></a>01013             $result = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#a2477b65daff71af2bf3013903b53a908">_calculateMaildirsize</a>();
<a name="l01014"></a>01014             $total_size = $result[<span class="stringliteral">&#39;size&#39;</span>];
<a name="l01015"></a>01015             $messages   = $result[<span class="stringliteral">&#39;count&#39;</span>];
<a name="l01016"></a>01016             $quota      = $result[<span class="stringliteral">&#39;quota&#39;</span>];
<a name="l01017"></a>01017             $over_quota = <span class="keyword">false</span>;
<a name="l01018"></a>01018             $over_quota = $over_quota || (isset($quota[<span class="stringliteral">&#39;size&#39;</span>])  &amp;&amp; $total_size &gt; $quota[<span class="stringliteral">&#39;size&#39;</span>]);
<a name="l01019"></a>01019             $over_quota = $over_quota || (isset($quota[<span class="stringliteral">&#39;count&#39;</span>]) &amp;&amp; $messages   &gt; $quota[<span class="stringliteral">&#39;count&#39;</span>]);
<a name="l01020"></a>01020         }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="keywordflow">if</span> ($fh) {
<a name="l01023"></a>01023             <span class="comment">// TODO is there a safe way to keep the handle open for writing?</span>
<a name="l01024"></a>01024             fclose($fh);
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027         <span class="keywordflow">return</span> array(<span class="stringliteral">&#39;size&#39;</span> =&gt; $total_size, <span class="stringliteral">&#39;count&#39;</span> =&gt; $messages, <span class="stringliteral">&#39;quota&#39;</span> =&gt; $quota, <span class="stringliteral">&#39;over_quota&#39;</span> =&gt; $over_quota);
<a name="l01028"></a>01028     }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     <span class="keyword">protected</span> function _addQuotaEntry($size, $count = 1) {
<a name="l01031"></a>01031         <span class="keywordflow">if</span> (!file_exists($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>)) {
<a name="l01032"></a>01032             <span class="comment">// TODO: should get file handler from _calculateQuota</span>
<a name="l01033"></a>01033         }
<a name="l01034"></a>01034         $size = (int)$size;
<a name="l01035"></a>01035         $count = (int)$count;
<a name="l01036"></a>01036         file_put_contents($this-&gt;_rootdir . <span class="stringliteral">&#39;maildirsize&#39;</span>, <span class="stringliteral">&quot;$size $count\n&quot;</span>, FILE_APPEND);
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 
<a name="l01045"></a><a class="code" href="class_zend___mail___storage___writable___maildir.html#a044924171dabec43ea3c23a33940f927">01045</a>     <span class="keyword">public</span> function <a class="code" href="class_zend___mail___storage___writable___maildir.html#a044924171dabec43ea3c23a33940f927">checkQuota</a>($detailedResponse = <span class="keyword">false</span>, $forceRecalc = <span class="keyword">false</span>) {
<a name="l01046"></a>01046         $result = $this-&gt;<a class="code" href="class_zend___mail___storage___writable___maildir.html#ae2b6403ef9d92fba723903f057694137">_calculateQuota</a>($forceRecalc);
<a name="l01047"></a>01047         <span class="keywordflow">return</span> $detailedResponse ? $result : $result[<span class="stringliteral">&#39;over_quota&#39;</span>];
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049 }
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:01:18 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
