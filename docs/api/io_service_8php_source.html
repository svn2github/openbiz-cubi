<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>openbiz: E:/E/GEAMP/www/openbiz/openbiz/bin/service/ioService.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>E:/E/GEAMP/www/openbiz/openbiz/bin/service/ioService.php</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00025"></a><a class="code" href="classio_service.html">00025</a> <span class="keyword">class </span><a class="code" href="classio_service.html">ioService</a>
<a name="l00026"></a>00026 {
<a name="l00033"></a><a class="code" href="classio_service.html#a847d8d60f037d0a016aca7006cf9dec6">00033</a>     <span class="keyword">public</span> function <a class="code" href="classio_service.html#a847d8d60f037d0a016aca7006cf9dec6">__construct</a>(&amp;$xmlArr)
<a name="l00034"></a>00034     {
<a name="l00035"></a>00035     }
<a name="l00036"></a>00036 
<a name="l00043"></a><a class="code" href="classio_service.html#a116b6d77b02984fa8e1fc72b90997c81">00043</a>     <span class="keyword">public</span> function <a class="code" href="classio_service.html#a116b6d77b02984fa8e1fc72b90997c81">exportXML</a>($objName)
<a name="l00044"></a>00044     {
<a name="l00045"></a>00045         <span class="comment">// get the current UI bizobj</span>
<a name="l00046"></a>00046         <span class="comment">/* @var $bizForm EasyForm */</span>
<a name="l00047"></a>00047         $bizForm = <a class="code" href="class_biz_system.html#adf8b5ec7deab8481298eb73aa56493a0">BizSystem::getObject</a>($objName);    <span class="comment">// get the existing bizform object</span>
<a name="l00048"></a>00048         $bizObj = $bizForm-&gt;getDataObj();
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         $recList = array();
<a name="l00051"></a>00051         $bizObj-&gt;fetchRecords(<span class="stringliteral">&quot;&quot;</span>, $recList, -1, -1, <span class="keyword">false</span>);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         $xmlString = <span class="stringliteral">&quot;&lt;?xml version=&#39;1.0&#39; standalone=&#39;yes&#39;?&gt;\n&quot;</span>;
<a name="l00054"></a>00054         $xmlString .= <span class="stringliteral">&quot;&lt;BizDataObj Name=\&quot;&quot;</span>.$bizObj-&gt;m_Name.<span class="stringliteral">&quot;\&quot;&gt;\n&quot;</span>;
<a name="l00055"></a>00055         <span class="keywordflow">foreach</span> ($recList as $rec)
<a name="l00056"></a>00056         {
<a name="l00057"></a>00057             $xmlRecord = <span class="stringliteral">&quot;\t&lt;Record&gt;\n&quot;</span>;
<a name="l00058"></a>00058             <span class="keywordflow">foreach</span> ($rec as $fld=&gt;$val)
<a name="l00059"></a>00059             {
<a name="l00060"></a>00060                 $xmlRecord .= <span class="stringliteral">&quot;\t\t&lt;Field Name=\&quot;$fld\&quot; Value=\&quot;$val\&quot; /&gt;\n&quot;</span>;
<a name="l00061"></a>00061             }
<a name="l00062"></a>00062             $xmlRecord .= <span class="stringliteral">&quot;\t&lt;/Record&gt;\n&quot;</span>;
<a name="l00063"></a>00063             $xmlString .= $xmlRecord;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065         $xmlString .= <span class="stringliteral">&quot;&lt;/BizDataObj&gt;&quot;</span>;
<a name="l00066"></a>00066 
<a name="l00067"></a>00067         <span class="comment">// output variables</span>
<a name="l00068"></a>00068         $name = str_replace(<span class="stringliteral">&quot;.&quot;</span>,<span class="stringliteral">&quot;_&quot;</span>,$bizObj-&gt;m_Name).<span class="stringliteral">&quot;.xml&quot;</span>;
<a name="l00069"></a>00069         $size = strlen($xmlString);
<a name="l00070"></a>00070         $type = <span class="stringliteral">&quot;text/plain&quot;</span>;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         ob_clean();
<a name="l00073"></a>00073 
<a name="l00074"></a>00074         header(<span class="stringliteral">&quot;Cache-Control: &quot;</span>);<span class="comment">// leave blank to avoid IE errors</span>
<a name="l00075"></a>00075         header(<span class="stringliteral">&quot;Pragma: &quot;</span>);<span class="comment">// leave blank to avoid IE errors</span>
<a name="l00076"></a>00076         header(<span class="stringliteral">&quot;Content-Disposition: attachment; filename=\&quot;$name\&quot;&quot;</span>);
<a name="l00077"></a>00077         header(<span class="stringliteral">&quot;Content-length: $size&quot;</span>);
<a name="l00078"></a>00078         header(<span class="stringliteral">&quot;Content-type: $type&quot;</span>);
<a name="l00079"></a>00079         
<a name="l00080"></a>00080         echo $xmlString;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082         exit;
<a name="l00083"></a>00083     }
<a name="l00084"></a>00084 
<a name="l00091"></a><a class="code" href="classio_service.html#a2d6101bbc41fb01a5d524fcb81717d34">00091</a>     <span class="keyword">public</span> function <a class="code" href="classio_service.html#a2d6101bbc41fb01a5d524fcb81717d34">importXML</a>($objName)
<a name="l00092"></a>00092     {
<a name="l00093"></a>00093         <span class="comment">// read in file from $_FILE</span>
<a name="l00094"></a>00094         <span class="comment">// read in file data and attributes</span>
<a name="l00095"></a>00095         <span class="keywordflow">foreach</span> ($_FILES as $file)
<a name="l00096"></a>00096         {
<a name="l00097"></a>00097             $error = $file[<span class="stringliteral">&#39;error&#39;</span>];
<a name="l00098"></a>00098             <span class="keywordflow">if</span> ($error != 0)
<a name="l00099"></a>00099             {
<a name="l00100"></a>00100                 $this-&gt;<a class="code" href="classio_service.html#a955d574cc8e55d32c7be0248b2153425">reportError</a>($error);
<a name="l00101"></a>00101                 <span class="keywordflow">return</span>;
<a name="l00102"></a>00102             }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104             $tmpName  = $file[<span class="stringliteral">&#39;tmp_name&#39;</span>];
<a name="l00105"></a>00105             $xml = simplexml_load_file($tmpName);
<a name="l00106"></a>00106             <span class="keywordflow">if</span> (!$xml)
<a name="l00107"></a>00107             {
<a name="l00108"></a>00108                 $errorMsg = <span class="stringliteral">&quot;Invalid input data format, could not create xml object.&quot;</span>;
<a name="l00109"></a>00109                 <a class="code" href="class_biz_system.html#aa26ed2b3200c70e2037b46220a7e22aa">BizSystem::clientProxy</a>()-&gt;showErrorMessage($errorMsg);
<a name="l00110"></a>00110                 <span class="keywordflow">return</span>;
<a name="l00111"></a>00111             }
<a name="l00112"></a>00112             <span class="comment">// only read the first one</span>
<a name="l00113"></a>00113             <span class="keywordflow">break</span>;
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">// get the current UI bizobj</span>
<a name="l00117"></a>00117         <span class="comment">/* @var $form EasyForm */</span>
<a name="l00118"></a>00118         $form = <a class="code" href="class_biz_system.html#adf8b5ec7deab8481298eb73aa56493a0">BizSystem::getObject</a>($objName);    <span class="comment">// get the existing bizform object</span>
<a name="l00119"></a>00119         <span class="comment">/* @var $parentForm EasyForm */</span>
<a name="l00120"></a>00120         $parentForm = <a class="code" href="class_biz_system.html#adf8b5ec7deab8481298eb73aa56493a0">BizSystem::getObject</a>($form-&gt;GetParentForm());
<a name="l00121"></a>00121         <span class="comment">/* @var $dataObj BizDataObj */</span>
<a name="l00122"></a>00122         $dataObj = $parentForm-&gt;getDataObj();
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         <span class="comment">//$oldCacheMode = $dataObj-&gt;GetCacheMode();</span>
<a name="l00125"></a>00125         <span class="comment">//$dataObj-&gt;SetCacheMode(0);    // turn off cache mode, not affect the current cache</span>
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="comment">// check if BizDataObj name matches</span>
<a name="l00128"></a>00128         $dataObjName = $xml[<span class="stringliteral">&#39;Name&#39;</span>];
<a name="l00129"></a>00129         <span class="keywordflow">if</span> ($dataObj-&gt;m_Name != $$dataObjName)
<a name="l00130"></a>00130         {
<a name="l00131"></a>00131             $errorMsg = <span class="stringliteral">&quot;Invalid input data. Input data object is not same as the current data object.&quot;</span>;
<a name="l00132"></a>00132             <a class="code" href="class_biz_system.html#aa26ed2b3200c70e2037b46220a7e22aa">BizSystem::clientProxy</a>()-&gt;showErrorMessage($errorMsg);
<a name="l00133"></a>00133             <span class="keywordflow">return</span>;
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136         <span class="comment">// read records</span>
<a name="l00137"></a>00137         <span class="keywordflow">foreach</span> ($xml-&gt;Record as $record)
<a name="l00138"></a>00138         {
<a name="l00139"></a>00139             <span class="comment">// insert record</span>
<a name="l00140"></a>00140             <span class="comment">// todo: check if there&#39;s same user keys in the table</span>
<a name="l00141"></a>00141             $recArray = null;
<a name="l00142"></a>00142             $recArray = $dataObj-&gt;newRecord();
<a name="l00143"></a>00143             <span class="keywordflow">foreach</span> ($record as $field)
<a name="l00144"></a>00144             {
<a name="l00145"></a>00145                 $value = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00146"></a>00146                 <span class="keywordflow">foreach</span> ($field-&gt;attributes() as $attributeName=&gt;$attributeValue)
<a name="l00147"></a>00147                 {
<a name="l00148"></a>00148                     <span class="keywordflow">if</span> ($attributeName == <span class="stringliteral">&#39;Name&#39;</span>) $name = $attributeValue.<span class="stringliteral">&quot;&quot;</span>;
<a name="l00149"></a>00149                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($attributeName == <span class="stringliteral">&#39;Value&#39;</span>) $value = $attributeValue.<span class="stringliteral">&quot;&quot;</span>;
<a name="l00150"></a>00150                 }
<a name="l00151"></a>00151                 <span class="keywordflow">if</span> ($name != <span class="stringliteral">&quot;Id&quot;</span>)
<a name="l00152"></a>00152                     $recArray[$name] = $value;
<a name="l00153"></a>00153             }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155             <span class="keywordflow">if</span> (!$dataObj-&gt;insertRecord($recArray))
<a name="l00156"></a>00156             {
<a name="l00157"></a>00157                 $errorMsg = $dataObj-&gt;getErrorMessage();
<a name="l00158"></a>00158                 <a class="code" href="class_biz_system.html#aa26ed2b3200c70e2037b46220a7e22aa">BizSystem::clientProxy</a>()-&gt;showErrorMessage($errorMsg);
<a name="l00159"></a>00159                 <span class="keywordflow">return</span>;
<a name="l00160"></a>00160             }
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162         <span class="comment">// $dataObj-&gt;SetCacheMode($oldCacheMode);  // restore cache mode</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164         $form-&gt;setFormState(1); <span class="comment">// indicate the import is done</span>
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166 
<a name="l00173"></a><a class="code" href="classio_service.html#a955d574cc8e55d32c7be0248b2153425">00173</a>     <span class="keyword">protected</span> function <a class="code" href="classio_service.html#a955d574cc8e55d32c7be0248b2153425">reportError</a>($error)
<a name="l00174"></a>00174     {
<a name="l00175"></a>00175         <span class="keywordflow">if</span> ($error==1)
<a name="l00176"></a>00176             $errorStr = <span class="stringliteral">&quot;The uploaded file exceeds the upload_max_filesize directive in php.ini&quot;</span>;
<a name="l00177"></a>00177         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($error==2)
<a name="l00178"></a>00178             $errorStr = <span class="stringliteral">&quot;The uploaded file exceeds the MAX_FILE_SIZE directive that was specified in the HTML form&quot;</span>;
<a name="l00179"></a>00179         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($error==3)
<a name="l00180"></a>00180             $errorStr = <span class="stringliteral">&quot;The uploaded file was only partially uploaded&quot;</span>;
<a name="l00181"></a>00181         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($error==4)
<a name="l00182"></a>00182             $errorStr = <span class="stringliteral">&quot;No file was uploaded&quot;</span>;
<a name="l00183"></a>00183         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($error==6)
<a name="l00184"></a>00184             $errorStr = <span class="stringliteral">&quot;Missing a temporary folder&quot;</span>;
<a name="l00185"></a>00185         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ($error==7)
<a name="l00186"></a>00186             $errorStr = <span class="stringliteral">&quot;Failed to write file to disk&quot;</span>;
<a name="l00187"></a>00187         <span class="keywordflow">else</span>
<a name="l00188"></a>00188             $errorStr = <span class="stringliteral">&quot;Error in file upload&quot;</span>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         global $g_BizSystem;
<a name="l00191"></a>00191         <a class="code" href="class_biz_system.html#aa26ed2b3200c70e2037b46220a7e22aa">BizSystem::clientProxy</a>()-&gt;showErrorMessage($errorStr);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 ?&gt;
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Thu Apr 19 2012 17:09:13 for openbiz by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
